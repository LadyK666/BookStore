# 网上书店管理系统数据库设计文档

[TOC]

## **小组成员与分工说明**

本项目《网上书店管理系统数据库设计文档》由以下两位成员合作完成，具体分工如下：

#### **成员一：软件2306班——任梓源——U202317353**

- 负责网上书店管理系统的整体需求分析与业务建模；
- 完成系统需求分析部分，包括项目背景、系统边界、功能需求分解、业务角色与典型使用场景分析；
- 完成从 E-R 模型到关系模型的转换，设计各数据表的关系模式、主键、外键及完整性约束；
- 参与数据库实现层设计，负责数据字典设计；
- 主导数据库设计总体方案讨论、优化与文档整合。

#### **成员二：软件2306班——康晨煜——U202317348**

- 负责数据库的逻辑结构设计与物理设计；

- 负责 MySQL 8 环境下的物理设计，包括数据类型选择、索引设计、存储引擎与字符集配置；

- 负责数据库实现层设计，包括 DDL 建表语句、视图、触发器与存储过程的设计与实现；

- 参与业务规则在数据库层面的实现与优化；

- 参与数据库设计总体方案讨论、优化。

#### **协作部分**

- 共同完成概念结构设计（E-R 模型），完成实体、属性、联系及约束的分析与说明，并绘制系统 E-R 图。

## **第 1 部分：需求分析**

### **1.1 项目背景与目标**

随着电子商务的蓬勃发展，传统书店的经营模式已逐渐向线上转移，构建一个功能完善、数据可靠、业务协同的网上书店管理系统成为必然需求。本系统旨在融合书店内部的日常业务处理（如库存管理、采购、客户及订单管理）与外部的在线零售服务（如客户浏览、在线下单），形成一个统一、高效、安全的数据管理与业务支撑平台。

**数据库设计核心目标如下：**

1.  **业务支撑**：为系统的六大核心功能模块（供书目录与库存、采购管理、客户管理、订单与发货、供应商管理、网上浏览）提供稳定、一致、完整的数据存储基础。
2.  **规则内聚**：将关键的业务规则（如信用等级与折扣计算、库存一致性维护、发货前资金校验等）尽可能下沉至数据库层，通过约束、触发器、存储过程实现，确保业务逻辑的强一致性，减轻应用层负担，并提升系统整体性能与可维护性。
3.  **为应用开发奠基**：本数据库设计将直接服务于后续基于JDBC的C/S架构后台管理系统与B/S架构的网上书店前端，为两者提供清晰、规范、高效的数据访问接口与模型。
4.  **兼顾扩展性**：在满足当前所有必选功能的基础上，数据结构设计预留合理的扩展点（如丛书管理、自动信用调整、分次发货等），以适应未来业务发展的需要。

### **1.2 系统边界与范围说明**

本数据库设计严格依据网上书店管理系统的业务需求，并明确了实现优先级。

**（1）核心范围（必须实现）**
下列功能模块及其关联数据是本次数据库设计必须完整支持的内容：

*   **供书目录与库存管理模块**：完整记录书目信息、作者（有序）、关键字、库存量及与供应商的关联。支持丛书管理（一个书号对应多本实体书），并预留库存位置信息字段。
*   **采购管理模块**：支持手动缺书登记、采购单创建、到货处理及库存联动更新。缺书记录可通过手动、库存低于阈值、客户订单超库存等方式生成，需保证记录唯一性。
*   **客户管理模块**：实现客户信息管理、账户余额充值、以及基于五级信用等级（包含具体折扣率、透支权限与额度规则）的折扣与透支规则管理。支持管理员手动调整信用等级，并可选支持每月初基于账户余额或累计消费额自动调整信用等级。
*   **订单与发货管理模块**：支持客户下单（一单多书）、订单状态跟踪、基于信用等级的支付验证、发货处理及账户扣款。支持订单分次发货，发货前必须校验客户支付能力。
*   **供应商管理模块**：记录供应商基本信息及其可供书目关系，支持供应商发布自有书目。
*   **网上浏览与查询模块**：支持多条件（书号、书名、出版社、关键字、作者及其顺序）的书目检索，以及客户对自身订单与发货情况的查询。书目检索支持模糊查询。

**（2）扩展范围（预留设计）**
为提升系统实用性与设计完整性，以下扩展功能在数据模型中予以考虑和设计，实现上标记为“可选”：

*   **缺书自动生成与通知**：当库存量低于预设阈值，或客户订单数量超过库存时，系统自动生成唯一的缺书记录。若记录来源于客户请求，可关联客户信息，并在采购到货后支持邮件通知。
*   **丛书/套装管理**：设计支持“一个书号对应多本实体书”的丛书结构，子书可单独销售和管理库存。
*   **库存位置可视化**：在库存记录中预留库位信息字段，为未来仓库可视化管理系统留出接口。
*   **信用等级自动调整**：设计数据结构和存储过程，支持每月初根据客户账户余额或历史累计消费额自动调整其信用等级。
*   **订单分次发货**：设计支持单个订单拆分为多次发货的数据结构，以应对部分发货的实际业务场景。
*   **客户缺书登记与跟踪**：记录客户的缺书需求，并在采购到货后，提供通过邮件通知客户的可能性（数据结构支持）。

### **1.3 业务角色与典型使用场景**

**角色定义：**

1.  **客户**：系统的外部使用者。通过网上书店前端进行注册、登录、个人信息维护、图书检索、下单购买、查询订单状态及历史记录、进行缺书登记等操作。
2.  **书店管理员**：系统的内部核心操作者。负责通过后台管理系统进行所有基础数据维护与核心业务流程操作，包括书目管理、库存调整、处理采购、管理客户账户与信用（手动调整等级）、审核订单与执行发货等。
3.  **供应商**：系统的外部协作角色。其主要交互是通过系统维护其供应信息和可供书目，此角色由管理员代为管理其数据。

**典型业务场景（驱动数据流与事务设计）：**

*   **场景S1：新书入库与上架**
    
    > 管理员收到一批新书，在系统中创建新的书目记录，输入书名、出版社、价格等信息，关联最多4位有序作者和10个关键字，并录入初始库存数量。同时，关联该书的供应商信息。若该书属于某套丛书，则还需建立丛书关系。
    
*   **场景S2：库存预警与采购闭环**
    > 系统监控库存，当《数据库系统原理》一书库存量低于5本时，自动生成一条“待处理”的缺书记录。管理员审查后，据此创建采购单。书籍到货后，管理员在系统中登记到货信息，系统自动更新该书库存，并将对应的缺书记录和采购单状态置为“已完成”。

*   **场景S3：客户下单与信用支付验证**
    > 客户“张三”浏览并选购了3本书加入购物车，提交订单。系统创建订单主记录及3条明细。根据张三的信用等级（如三级，享15%折扣，可透支额度500元），计算折后总价。发货前，系统校验：订单总额 ≤ (张三账户余额 + 其透支额度)。若通过，则冻结相应金额（或直接扣款），生成发货单。

*   **场景S4：信用等级自动调整（可选扩展）**
    
    > 每月初，系统自动运行信用评估。客户“李四”因上月累计消费额首次突破10000元，系统根据预设规则，自动将其信用等级从**二级**提升至**三级**，从此可享受透支特权。
    
*   **场景S5：复杂书目检索**
    > 客户想查找所有书名中包含“Java”、由“清华大学出版社”出版、且第一作者为“李刚”的书籍。系统需能高效地支持这种多条件、模糊匹配的组合查询。

*   **场景S6：客户自主服务与缺书登记**
    > 客户登录后，可以查看和修改自己的送货地址，查询所有历史订单的详情（包括订单状态、每本书的信息、发货物流状态等），并可以对自己的账户进行充值（需管理员后台确认到账）。当客户查询的书目无库存时，系统可询问客户是否进行缺书登记，并记录该需求。

### **1.4 功能需求分解**

为明确数据实体与关系，将系统功能分解为可映射到数据库操作的子功能点：

| 模块                      | 子功能点                 | 详细描述与数据要求                                           |
| :------------------------ | :----------------------- | :----------------------------------------------------------- |
| **1. 供书目录与库存管理** | 1.1 书目信息维护         | CRUD操作。核心字段：书号(主键)、书名、出版社、定价、目录/封面(大文本/BLOB，可选)。 **需支持丛书结构**。 |
|                           | 1.2 作者管理             | 支持每本书关联1-4位作者，且必须记录作者顺序(第1作者、第2作者...)。 |
|                           | 1.3 关键字管理           | 支持每本书关联0-10个关键字，用于增强检索。                   |
|                           | 1.4 库存管理             | 记录每本书的实时库存量。支持入库(采购到货)、出库(订单发货)、盘点调整。需考虑并发更新。**需支持安全库存阈值设置**。 |
|                           | 1.5 供应商关联           | 记录每本书可由哪些供应商供货（多对多关系），以便采购时选择。 |
|                           | *1.6 丛书管理(可选)*     | 支持定义丛书，一个丛书号下包含多本独立的子书，子书可单独销售和管理库存。 |
| **2. 采购管理**           | 2.1 缺书登记             | 手动创建：书、数量、推荐供应商、登记日期。<br>**自动创建(可选)**：触发条件(库存低于阈值/订单超库存)，需保证记录唯一性。<br>**客户触发(可选)**：记录客户缺书请求。 |
|                           | 2.2 采购单管理           | 基于一条或多条缺书记录生成采购单。记录采购单状态(待处理、部分到货、已完成)。关联供应商。 |
|                           | 2.3 到货处理             | 登记采购单的到货数量，**触发库存增加**，更新缺书记录和采购单状态。**可选邮件通知客户**。 |
| **3. 客户与信用管理**     | 3.1 客户信息管理         | CRUD操作。字段：客户ID、密码(哈希存储)、姓名、地址集、手机、邮箱、账户余额等。支持客户网上注册与信息维护。 |
|                           | 3.2 账户余额管理         | 记录当前账户余额。管理员可“充值”增加余额。消费时扣减，支持透支（根据信用等级）。 |
|                           | 3.3 信用等级管理         | 预定义5个信用等级（字典表）。每个等级关联：**折扣率、是否允许透支、最高透支额度**。客户关联一个信用等级。<br />\- **折扣率**（一级10%，二级15%，三级15%，四级20%，五级25%）<br/>\- **是否允许透支**（一、二级否；三、四、五级是）<br/>\- **透支额度**（三级、四级为固定限额；五级为无限制）。<br/>支持管理员手动调整客户等级。 |
|                           | *3.4 信用自动调整(可选)* | 每月初，通过存储过程，根据客户上月余额或累计消费额，自动更新其信用等级。需记录升级条件。 |
| **4. 订单与发货管理**     | 4.1 订单创建             | 客户下单，创建订单头(客户、总金额、状态、地址)和订单明细(书、数量、单价)。支持一单多书。**仅能订购库存中已有的书目**。 |
|                           | 4.2 价格计算             | 单价 = 书籍定价 × 客户信用等级对应的折扣率。总金额自动汇总。 |
|                           | 4.3 发货前校验           | **关键业务规则**：在生成发货单前，调用存储过程或触发器，依据客户信用等级规则验证支付能力。<br />\- **一、二级**：校验`余额 >= 订单金额`<br/>\- **三、四、五级**：校验`余额 + 透支额度 >= 订单金额`。 |
|                           | 4.4 发货执行             | 通过校验后，扣减客户账户余额（允许扣为负值表示透支），减少书籍库存，创建发货记录。支持**分次发货(可选)**。 |
|                           | 4.5 状态跟踪             | 订单状态流：待付款->待发货->已发货->已完成/已取消。支持订单明细状态跟踪。 |
| **5. 供应商管理**         | 5.1 供应商信息维护       | CRUD操作。基础信息：名称、联系人、电话、地址等。             |
|                           | 5.2 供货关系维护         | 维护“供应商-可供应书目”的关系，可记录供货价、供货周期等扩展信息。支持供应商发布自有书目。 |
| **6. 网上浏览与查询**     | 6.1 多维度书目检索       | 支持按书号、书名(模糊)、出版社、关键字(匹配度)、作者(第N作者)进行单条件或组合查询。支持模糊查询。 |
|                           | 6.2 客户个人空间查询     | 客户只能查看自己的：信息、所有历史订单、每个订单的发货明细。 |

### **1.5 数据需求（核心数据对象）**

从上述功能中，抽象出数据库必须持久化存储的核心数据对象：
1.  **书目(`Book`)**：书籍的核心静态信息，包括丛书支持。
2.  **作者(`Author`)与书目-作者关系(`Book_Author`)**：记录作者信息及作者与书的关联顺序。
3.  **关键字(`Keyword`)与书目-关键字关系(`Book_Keyword`)**。
4.  **库存(`Inventory`)**：书籍的动态库存量，与书目一一对应或合并，包含安全库存和库位信息。
5.  **供应商(`Supplier`)与供货关系(`Supply`)**。
6.  **缺书记录(`OutOfStockRecord`)**：包含来源（手动/自动/客户触发）和关联客户信息。
7.  **采购单(`PurchaseOrder`)与采购明细(`PurchaseOrderItem`)**。
8.  **客户(`Customer`)**：包含账户余额、累计消费额和信用等级关联。
9.  **信用等级字典(`CreditLevel`)**：必须包含等级ID、折扣率、是否允许透支、透支额度等字段，并预置五级具体数据。
10. **订单(`SalesOrder`)与订单明细(`SalesOrderItem`)**：包含折扣快照和发货地址快照。
11. **发货单(`Shipment`)与发货明细(`ShipmentItem`)** (支持分次发货)。
12. **客户地址(`CustomerAddress`)**：一个客户可能有多个收货地址。
13. **丛书关系(`BookSeries`)** (可选)：描述丛书与子书的关系。

### **1.6 关键业务规则与约束（数据库层面）**

以下规则必须在数据库设计中被体现，优先使用约束，其次使用触发器或存储过程保证：

1.  **数据完整性约束**：
    *   主键唯一性。
    *   外键参照完整性（如订单明细中的书号必须存在于书目表中）。
    *   非负约束：库存量、账户余额、订单数量、金额等字段必须 ≥ 0。
    *   账户余额：允许为负（表示透支），但必须与信用等级透支规则联动校验。
    *   枚举值约束：订单状态、采购单状态、发货单状态、缺书来源等字段值必须在预定范围内。

2.  **业务逻辑约束**：
    *   **作者顺序约束**：对于同一`book_id`，`author_order`字段值必须在1到4之间，且组合唯一(`book_id`, `author_order`)。
    *   **关键字数量约束**：通过应用程序逻辑或触发器保证，插入`Book_Keyword`关系时，同一`book_id`的记录不超过10条。
    *   **缺书记录唯一性**：当通过自动方式生成缺书记录时，对于同一`book_id`且状态为“待处理”的记录应唯一。可通过触发器或存储过程实现。
    *   **库存更新原子性**：采购到货（增加库存）和订单发货（减少库存）必须在同一事务中完成，并考虑使用`SELECT ... FOR UPDATE`或乐观锁处理高并发场景。
    *   **信用-折扣-透支联动**：
        - 订单明细中的成交价必须在插入时根据`Book.price`和`Customer.credit_level`对应的折扣率计算得出。
        - **发货前的支付能力校验**必须严格依据信用等级字典中定义的“是否允许透支”和“透支额度”字段进行判断。此校验逻辑应封装在存储过程或触发器中。
    *   **信用自动调整规则(可选)**：若实现，其判断逻辑（条件与目标等级）应有明确的配置或定义，并由数据库定时任务或存储过程执行。
    *   **分次发货总量控制**：如果实现分次发货，则同一订单下，所有发货明细中某书的累计发货数量不得大于其订单明细中的订购数量。
    *   **订单书目有效性**：订单明细中的书号必须对应状态为“在售”的图书。
    *   **到货通知与业务闭环规则**： 
        - **实时识别需求**：系统要求在执行采购入库操作（`sp_receive_purchase`）时，必须通过数据库关联查询，实时识别受本次到货影响且已登记缺书需求的客户 。
        - **异步解耦设计**：为保证数据库事务的原子性与处理效率，数据库层不直接调用外部发信接口。
        - **结果集反馈机制**：入库存储过程在完成库存更新与状态核销后，需通过返回特定的“通知清单结果集”（包含客户姓名、邮箱、到货书名等）的方式，将发信指令下传给基于 JDBC 的应用层，由应用层异步执行邮件发送动作。
    *   **询价与报价联动规则**：当客户查询的书目未找到时，系统允许客户发起询价请求。该请求记录于 `out_of_stock_record` 表中，来源标记为“客户缺书登记（询价）”。管理员在获取供应渠道后，需更新该记录的“报价”字段，并由应用层通知客户。
    *   **高级检索匹配评分规则**：系统支持基于关键字匹配精细度的排序。利用全文索引评分机制（`MATCH...AGAINST`），在进行书目检索时，计算关键词与书名、目录的相关度分值，并优先展示相关度最高的书目。

### **1.7 非功能需求（数据库视角）**

1.  **性能**：
    *   书目检索、客户订单查询为高频操作，相关表（`Book`, `SalesOrder`）及查询条件字段（`Book.name`, `Book.publisher`, `SalesOrder.customer_id`）需建立合适的索引。
    *   联表查询（如订单详情查询）路径上的外键字段应建立索引。
    *   考虑大表（如`SalesOrderItem`）的历史数据归档策略。

2.  **安全性**：
    *   客户密码在数据库中只存储加盐哈希值，绝不存储明文。
    *   在数据库权限设计上，可为应用层创建不同权限的数据库用户，例如：`web_user`（仅有特定表的查询、插入权限）和`admin_user`（具有全部管理权限）。

3.  **一致性**：
    *   所有核心业务事务（如“创建订单-扣减库存-扣款”）必须保证ACID特性。
    *   使用数据库事务和锁机制来防止超卖等并发问题。

4.  **可维护性与可扩展性**：
    *   表结构设计符合第三范式（3NF），减少数据冗余。
    *   使用字典表管理状态、类型等枚举值，便于维护。
    *   核心表结构预留少量`备用字段`（`extra_info` JSON类型或`reserved1` VARCHAR），以应对未来不确定的微小需求变更。

## **第 2 部分：概念结构设计（E-R 模型）**

### **2.1 概念结构设计目标**

概念结构设计的核心任务是：在完成需求分析的基础上，**独立于任何特定的数据库管理系统（DBMS）和物理实现细节**，抽象出系统所必需的数据及其内在联系，构建一个清晰、完整、无歧义的全局数据模型。

本阶段设计具体目标如下：
1.  **准确性与完备性**：模型必须全面、准确地反映"网上书店管理系统"中所有核心业务对象（如书、客户、订单等）及其静态属性、动态行为和相互关系，涵盖书目、作者、库存、采购、客户、信用、订单、发货、供应商等全部数据实体。
2.  **业务规则表达**：模型需能够自然地表达需求中定义的复杂业务规则，如"一本图书最多关联4位有序作者"、"每本书最多关联10个关键字"、"客户的信用等级决定其折扣率与透支权限"、"缺书记录的生成条件和唯一性"等。
3.  **约束显性化**：将数据间的数量约束（基数约束）、存在依赖关系（参与约束）等清晰地体现在模型中，为后续的数据库完整性设计提供直接依据。特别是作者顺序、关键字数量、信用等级与透支规则的联动关系。
4.  **可扩展性**：模型结构应具备一定的弹性，能够在不破坏核心结构的前提下，容纳需求中提及的"可选"功能（如分次发货、丛书管理、信用自动调整）的未来扩展。
5.  **无冗余性**：消除概念层面的数据冗余，确保每个实体和联系都具有明确的、不可替代的语义，为达到较高的关系范式奠定基础。例如，作者、关键字等描述性实体独立存在，避免在书目表中重复存储。

本概念模型采用**实体-联系方法（E-R方法）**进行描述，并通过文字与图形（E-R图核心部分描述）相结合的方式呈现。

---

### **2.2 实体总体说明**

基于对需求分析的深入理解，本系统涉及的核心业务对象可抽象为以下主要实体类型及其从属实体。实体清单如下：

1.  **核心业务实体**：书目（Book）、客户（Customer）、供应商（Supplier）、订单（SalesOrder）。
2.  **描述性实体**：作者（Author）、关键字（Keyword）、信用等级（CreditLevel）。
3.  **过程性实体**：库存（Inventory）、缺书记录（OutOfStockRecord）、采购单（PurchaseOrder）、发货单（Shipment）。
4.  **关联性（弱）实体**：订单明细（SalesOrderItem）、采购明细（PurchaseOrderItem）、发货明细（ShipmentItem）、书目-作者联系（Book_Author）、书目-关键字联系（Book_Keyword）、供货联系（Supply）。
5.  **扩展实体（可选）**：丛书（BookSeries）、客户地址（CustomerAddress）。

这些实体共同构成了网上书店业务数据体系的骨架，覆盖了从图书信息管理、库存控制、采购补货、客户订单到发货履约的全业务流程。

---

### **2.3 实体及属性详细设计**

#### **2.3.1 书目实体 (Book)**

*   **实体含义**：代表书店所经营或可订购的图书的唯一抽象。它是系统中最核心的静态数据实体。
*   **标识符（主键）**：书号 (BookID)。采用具有业务含义或系统生成的唯一编码，如ISBN或内部编码。
*   **主要属性**：
    *   书名 (Title)：图书的名称。
    *   定价 (Price)：图书的标准销售单价。
    *   出版社 (Publisher)：出版单位。
    *   出版日期 (PublishDate)。
    *   版次 (Edition，可选)：用于区分同一书名的不同版本。
    *   国际标准书号 (ISBN，可选)：全球唯一图书标识。
    *   封面图片 (CoverImage，可选)：存储图片路径或BLOB数据。
    *   内容目录 (Catalog，可选)：长文本描述。
    *   状态 (Status)：如"在售"、"停售"。用于控制前端展示与购买。
    *   丛书标识 (SeriesFlag，可选)：标记该书是否属于丛书。
*   **设计说明**：将图书的"可变信息"（如库存量、供应商）与"不变信息"（如书名、出版社）分离，符合数据库设计原则。为支持丛书扩展，预留丛书标识字段。

#### **2.3.2 作者实体 (Author)**

*   **实体含义**：独立记录作者信息，避免在不同图书中重复录入同一作者信息，并支持按作者检索。
*   **标识符**：作者编号 (AuthorID)。代理主键，无业务含义。
*   **主要属性**：
    *   作者姓名 (AuthorName)。
    *   国籍 (Nationality，可选)。
    *   简介 (Biography，可选)：作者生平与成就介绍。
*   **设计说明**：作者实体独立存在，通过"书目-作者"联系与书目关联，实现了"一位作者可著多本书"的关系。这种设计便于按作者进行统一检索和统计。

#### **2.3.3 关键字实体 (Keyword)**

*   **实体含义**：用于对书目进行多维度标记和分类，是实现高效、灵活检索功能的基础。
*   **标识符**：关键字编号 (KeywordID)。代理主键。
*   **主要属性**：
    *   关键字内容 (KeywordText)：如"数据库"、"编程"、"小说"。
*   **设计说明**：采用独立实体而非在书目表中设多个关键字字段，便于统一管理、统计热点关键字，并轻松支持"多对多"的关联关系。这种设计支持模糊查询和基于关键字的推荐功能。

#### **2.3.4 库存实体 (Inventory)**

*   **实体含义**：记录特定书目的实时库存情况，是连接采购、销售（订单）与书目实体的关键状态实体。
*   **标识符**：库存记录ID (InventoryID) 或直接使用书目ID (BookID)作为主键。考虑到与书目的一一对应关系，可采用BookID作为其主键和外键。
*   **主要属性**：
    *   当前数量 (Quantity)：必须为非负整数。
    *   安全库存量 (SafetyStock)：用于触发自动缺书预警的阈值，可设定默认值。
    *   库位编码 (LocationCode，可选)：物理仓库中的存放位置，为未来仓储管理预留。
*   **设计说明**：将库存独立为实体，而非作为书目的属性，更清晰地表达了"库存是一个随时间变化的动态状态"这一业务事实，也便于未来扩展库存批次、不同仓库库存等复杂场景。

#### **2.3.5 供应商实体 (Supplier)**

*   **实体含义**：代表图书的供货来源。
*   **标识符**：供应商编号 (SupplierID)。
*   **主要属性**：
    *   供应商名称 (SupplierName)。
    *   联系人 (ContactPerson)。
    *   联系电话 (Phone)。
    *   电子邮箱 (Email)。
    *   地址 (Address)。
    *   结算方式 (PaymentTerms，可选)：如"月结30天"。
    *   合作状态 (CooperationStatus)：如"合作中"、"暂停"、"终止"。
*   **设计说明**：供应商信息独立管理，支持多供应商供货模式，为采购决策提供数据支持。

#### **2.3.6 客户实体 (Customer)**

*   **实体含义**：在书店注册的消费者，是订单的发起者。
*   **标识符**：客户编号 (CustomerID)。代理主键。
*   **主要属性**：
    *   用户名 (Username)：用于登录，需唯一。
    *   密码哈希 (PasswordHash)：存储加密后的密码，确保安全。
    *   真实姓名 (RealName)。
    *   手机号 (MobilePhone)：重要联系方式，可用于验证。
    *   电子邮箱 (Email)：用于订单通知、密码找回。
    *   账户余额 (AccountBalance)：记录客户预存或待付的金额，可为负（透支）。
    *   累计消费额 (TotalConsumption)：用于信用自动调整。
    *   注册时间 (RegistrationTime)。
    *   账户状态 (AccountStatus)：如"正常"、"冻结"。
*   **设计说明**：密码单独存储哈希值，是基本的安全设计。账户余额和累计消费额是核心财务属性，其更新必须通过严格的事务控制。信用等级通过外键关联，实现规则分离。

#### **2.3.7 信用等级实体 (CreditLevel)**

*   **实体含义**：定义信用等级的规则字典，是业务规则数据化的典范。
*   **标识符**：等级编号 (LevelID) 或等级名称 (LevelName)。
*   **主要属性**：
    *   等级名称 (LevelName)：如"普通会员"、"黄金会员"。
    *   折扣率 (DiscountRate)：小数，如0.85代表85折（即15%折扣）。
    *   是否允许透支 (AllowOverdraft)：布尔值。
    *   透支额度 (OverdraftLimit)：当允许透支时，此字段有效；若不允许透支，可为0或NULL；对于"无额度限制"的等级，可设为极大值或-1表示无限。
    *   升级条件 (UpgradeCondition，可选)：用于描述自动升级的规则，如"累计消费满1000元"。
*   **设计说明**：将业务规则参数化存储于表中，使得规则调整无需修改程序代码，极大提高了系统的可维护性。预置五级信用规则，支持信用体系的灵活管理。

#### **2.3.8 订单实体 (SalesOrder)**

*   **实体含义**：记录客户一次完整的购买请求，是交易的核心凭证。
*   **标识符**：订单编号 (OrderID)。可采用时间戳+序列号等规则生成。
*   **主要属性**：
    *   下单时间 (OrderTime)。
    *   订单状态 (OrderStatus)：如"待支付"、"待发货"、"已发货"、"已完成"、"已取消"。状态流转体现业务流程。
    *   商品总金额 (GoodsAmount)：订单明细中商品单价*数量的总和。
    *   折扣率快照 (DiscountRateSnapshot)：下单时客户信用等级对应的折扣率。
    *   实付金额 (PayableAmount)：商品总金额 × 折扣率。这是最终需要支付的金额。
    *   收货地址快照 (ShippingAddressSnapshot)：发货地址的快照信息。
    *   支付时间 (PaymentTime，可选)。
    *   发货时间 (DeliveryTime，可选)。
    *   客户备注 (CustomerNote，可选)。
*   **设计说明**：明确区分"商品总金额"和"实付金额"，清晰地体现了折扣业务。存储折扣率快照和地址快照保证了订单历史数据的不可变性。订单状态是驱动后续流程（发货、收款）的关键。

#### **2.3.9 订单明细实体 (SalesOrderItem)**

*   **实体含义**：描述订单中包含的具体商品项，是**弱实体**，其存在完全依赖于订单实体。
*   **标识符**：明细ID (OrderItemID)，或使用复合主键 (OrderID, BookID)。
*   **主要属性**：
    *   订购数量 (Quantity)。
    *   成交单价 (UnitPrice)：下单时根据图书定价和客户折扣率快照的值。必须保留，即使图书未来涨价。
    *   小计金额 (SubAmount)：Quantity * UnitPrice，可冗余存储以提高查询效率。
    *   明细状态 (ItemStatus)：如"已下单"、"已发货"、"已完成"，支持分次发货跟踪。
*   **设计说明**：存储"成交单价"是电子商务系统的通用做法，保证了订单历史价格的不可篡改性和可追溯性。该实体实现了订单与书目之间的多对多关系。支持分次发货时，明细状态用于跟踪每本书的发货进度。

#### **2.3.10 发货单实体 (Shipment) (可选扩展)**

*   **实体含义**：记录一次具体的发货行为，支持"一单多次发货"。
*   **标识符**：发货单号 (ShipmentID)。
*   **主要属性**：
    *   发货时间 (ShipTime)。
    *   物流公司 (Carrier)。
    *   运单号 (TrackingNumber)。
    *   发货状态 (ShipmentStatus)：如"已出库"、"运输中"、"已签收"。
    *   操作员 (Operator)：执行发货操作的管理员。
*   **设计说明**：此实体为可选扩展。若不实现分次发货，发货信息可直接作为订单的属性。引入此实体使物流跟踪更精细，支持订单的多次分批发货。

#### **2.3.11 发货明细实体 (ShipmentItem) (可选扩展)**

*   **实体含义**：描述一次发货中包含的具体书目及数量，是弱实体，依赖于发货单。
*   **标识符**：复合主键 (ShipmentID, OrderItemID) 或增加一个明细ID。
*   **主要属性**：
    *   发货数量 (ShipQuantity)。
*   **设计说明**：与订单明细关联，准确记录每次发货的具体内容，确保分次发货的准确性和可追溯性。

#### **2.3.12 缺书记录实体 (OutOfStockRecord)**

*   **实体含义**：记录因库存不足产生的需求，是采购流程的起点。
*   **标识符**：缺书记录ID (RecordID)。
*   **主要属性**：
    *   缺书数量 (RequiredQuantity)。
    *   登记日期 (RecordDate)。
    *   记录来源 (Source)：如"手动登记"、"系统预警(低库存)"、"客户订单触发"、"客户缺书登记"。
    *   关联客户ID (RelatedCustomerID，可选)：若由客户订单或登记触发，可记录于此。
    *   状态 (Status)：如"待处理"、"已生成采购"、"已到货"。
    *   优先级 (Priority，可选)：用于采购排序。
*   **设计说明**：通过"记录来源"和"状态"字段，可以清晰追踪每一条缺书需求的产生、处理和完成的全生命周期。关联客户信息支持到货通知功能。

#### **2.3.13 采购单实体 (PurchaseOrder)**

*   **实体含义**：书店向供应商发出的正式采购请求。
*   **标识符**：采购单号 (PurchaseOrderID)。
*   **主要属性**：
    *   创建日期 (CreateDate)。
    *   期望到货日期 (ExpectedDate)。
    *   采购员 (Buyer)。
    *   总预估金额 (EstimatedAmount)。
    *   状态 (Status)：如"草稿"、"已发出"、"部分到货"、"已完成"、"已取消"。
    *   供应商ID (SupplierID)：外键，指明向谁采购。
*   **设计说明**：采购单管理采购业务的全过程，状态流转反映采购进度。

#### **2.3.14 采购明细实体 (PurchaseOrderItem)**

*   **实体含义**：描述采购单中要采购的具体书目及信息，是**弱实体**。
*   **标识符**：复合主键 (PurchaseOrderID, BookID)。
*   **主要属性**：
    *   采购数量 (PurchaseQuantity)。
    *   采购单价 (PurchasePrice)：与供应商协定的进价。
    *   关联缺书记录ID (RelatedOutOfStockID，可选)：指明本次采购是为了满足哪条缺书需求。
*   **设计说明**：通过关联缺书记录，实现采购需求的可追溯性，形成从缺书到采购的完整闭环。

#### **2.3.15 客户地址实体 (CustomerAddress) (推荐)**

*   **实体含义**：存储客户的一个或多个收货地址。
*   **标识符**：地址编号 (AddressID)。
*   **主要属性**：
    *   收件人姓名 (RecipientName)。
    *   收件人电话 (RecipientPhone)。
    *   省份 (Province)。
    *   城市 (City)。
    *   区县 (District)。
    *   详细地址 (DetailAddress)。
    *   是否默认地址 (IsDefault)。
    *   地址标签 (Tag，可选)：如"家"、"公司"。
*   **设计说明**：独立地址实体支持客户管理多个收货地址，下单时灵活选择，提升了用户体验。

#### **2.3.16 丛书实体 (BookSeries) (可选扩展)**

*   **实体含义**：管理丛书信息，支持一个书号对应多本实体书。
*   **标识符**：丛书编号 (SeriesID)。
*   **主要属性**：
    *   丛书名称 (SeriesName)。
    *   丛书描述 (SeriesDescription，可选)。
*   **设计说明**：通过单独的丛书实体和关联关系，实现丛书的灵活管理，子书可独立销售和库存管理。

---

### **2.4 实体之间的联系 (Relationship) 设计**

以下联系定义了实体之间如何交互，是业务逻辑在数据层面的体现。

1.  **书目 — 作者 (Book – Author)**
    *   **联系类型**：多对多 (M:N)。一本图书可由多位作者合著，一位作者也可创作多本图书。
    *   **联系名称**：`著作 (Writes)`。
    *   **联系属性**：作者顺序 (AuthorOrder)，取值1~4。此属性记录了作者在该书中的贡献排序，是业务关键约束。
    *   **参与约束**：书目端为**强制参与**（一本已录入的书至少有一位作者），作者端为**可选参与**（一位作者可能尚未有作品被收录）。
    *   **数量约束**：每本书最多关联4位作者。

2.  **书目 — 关键字 (Book – Keyword)**
    *   **联系类型**：多对多 (M:N)。一本书可有多个标签，一个标签可标记多本书。
    *   **联系名称**：`标记为 (TaggedAs)`。
    *   **参与约束**：两端均为可选。
    *   **数量约束**：每本书最多关联10个关键字。

3.  **书目 — 库存 (Book – Inventory)**
    *   **联系类型**：一对一 (1:1)。一种书目在系统中对应唯一的库存记录。
    *   **联系名称**：`拥有库存 (HasInventory)`。
    *   **参与约束**：书目端为强制参与（录入书目即初始化库存为0），库存端为强制参与。

4.  **书目 — 供应商 (Book – Supplier)**
    *   **联系类型**：多对多 (M:N)。一本书可从多个供应商处采购，一个供应商可供应多种书。
    *   **联系名称**：`可供应 (CanSupply)`。
    *   **联系属性（可选扩展）**：供货价格 (SupplyPrice)、供货周期 (LeadTime)、是否主要供应商 (IsPrimary)。这些属性描述了"供应"这一联系本身的特性。
    *   **参与约束**：两端均为可选。

5.  **客户 — 信用等级 (Customer – CreditLevel)**
    *   **联系类型**：多对一 (N:1)。多个客户属于同一信用等级，一个客户只能有一个信用等级。
    *   **联系名称**：`属于 (BelongsTo)`。
    *   **参与约束**：客户端为强制参与（客户注册时需分配默认等级），信用等级端为强制参与（系统必须预定义等级）。

6.  **客户 — 订单 (Customer – SalesOrder)**
    *   **联系类型**：一对多 (1:N)。一个客户可下多个订单，一个订单只属于一个客户。
    *   **联系名称**：`下达 (Places)`。
    *   **参与约束**：客户端为强制参与（订单必有归属客户），订单端为可选参与（客户可以先注册不下单）。

7.  **订单 — 订单明细 (SalesOrder – SalesOrderItem)**
    *   **联系类型**：一对多 (1:N)（组合关系）。一个订单包含多项明细，一项明细只属于一个订单。
    *   **联系名称**：`包含 (Contains)`。
    *   **参与约束**：订单端为强制参与（有订单才有明细），明细端为强制参与（明细不能独立存在）。

8.  **订单明细 — 书目 (SalesOrderItem – Book)**
    *   **联系类型**：多对一 (N:1)。多项明细可能指向同一种书（在不同订单中），一项明细只对应一种书。
    *   **联系名称**：`订购了 (Orders)`。
    *   **参与约束**：明细端为强制参与，书目端为强制参与。订单明细中的书目必须是"在售"状态。

9.  **订单 — 发货单 (SalesOrder – Shipment) (可选扩展)**
    *   **联系类型**：一对多 (1:N)。一个订单可以分多次发货，产生多张发货单。
    *   **联系名称**：`产生发货 (GeneratesShipment)`。
    *   **参与约束**：订单端为可选参与（订单可能尚未发货），发货单端为强制参与（发货单必须关联一个订单）。

10. **发货单 — 发货明细 (Shipment – ShipmentItem) (可选扩展)**
    *   **联系类型**：一对多 (1:N)（组合关系）。
    *   **联系名称**：`包含货物 (ContainsGoods)`。

11. **发货明细 — 订单明细 (ShipmentItem – SalesOrderItem) (可选扩展)**
    *   **联系类型**：多对一 (N:1)。一次发货可能涉及多个订单明细的多个批次，但一条发货明细必须明确关联到一条具体的订单明细。
    *   **联系名称**：`发运了 (Ships)`。
    *   **数量约束**：同一订单明细的累计发货数量不能超过其订购数量。

12. **书目 — 缺书记录 (Book – OutOfStockRecord)**
    *   **联系类型**：一对多 (1:N)。一种书可能产生多条缺书记录（在不同时间），一条缺书记录只针对一种书。
    *   **联系名称**：`产生缺书需求 (GeneratesDemandFor)`。
    *   **参与约束**：书目端为强制参与，缺书记录端为强制参与。
    *   **唯一性约束**：同一本书在"待处理"状态下只能有一条缺书记录。

13. **缺书记录 — 采购单明细 (OutOfStockRecord – PurchaseOrderItem)**
    *   **联系类型**：一对多 (1:N) 或 多对一 (N:1)。一条缺书记录可能通过一次或多次采购来满足（如果采购量不足），一次采购也可能同时满足多条缺书记录（合并采购）。
    *   **联系名称**：`被满足于 (IsFulfilledBy)`。
    *   **设计说明**：这是一个较为灵活的联系，通过采购明细中的"关联缺书记录ID"属性来实现，它记录了采购行为与需求源头的关系。

14. **采购单 — 采购明细 (PurchaseOrder – PurchaseOrderItem)**
    *   **联系类型**：一对多 (1:N)（组合关系）。
    *   **联系名称**：`包含采购项 (Includes)`。

15. **采购明细 — 书目 (PurchaseOrderItem – Book)**
    *   **联系类型**：多对一 (N:1)。
    *   **联系名称**：`采购 (Purchases)`。

16. **采购单 — 供应商 (PurchaseOrder – Supplier)**
    *   **联系类型**：多对一 (N:1)。多张采购单可发给同一个供应商，一张采购单一般只针对一个供应商（简化模型）。
    *   **联系名称**：`发往 (IssuedTo)`。
    *   **参与约束**：采购单端为强制参与，供应商端为强制参与。

17. **客户 — 客户地址 (Customer – CustomerAddress)**
    *   **联系类型**：一对多 (1:N)。一个客户可以有多个收货地址。
    *   **联系名称**：`拥有地址 (HasAddress)`。
    *   **参与约束**：客户端为强制参与（客户至少有一个地址），地址端为强制参与（地址必须属于某个客户）。

18. **书目 — 丛书 (Book – BookSeries) (可选扩展)**
    *   **联系类型**：多对一 (N:1) 或多对多 (M:N)。多本书可以属于同一套丛书（如果从书是逻辑集合），或一套丛书包含多本独立的子书（物理集合）。
    *   **联系名称**：`属于丛书 (BelongsToSeries)`。
    *   **设计说明**：根据业务需求，可选择适合的丛书模型。本设计采用"丛书-子书"的父子关系模型。

---

### **2.5 全局 E-R 图**

整个概念模型以**书目(Book)**、**客户(Customer)**、**供应商(Supplier)**三个强实体为核心展开。

*   **书目**通过 `Writes` 和 `TaggedAs` 联系与**作者**、**关键字**关联，形成其描述体系；通过 `HasInventory` 联系与**库存**绑定，反映其可用状态；通过 `CanSupply` 联系与**供应商**相连，指明货源；通过 `BelongsToSeries` 联系（可选）与**丛书**关联。
*   **客户**通过 `BelongsTo` 联系绑定**信用等级**，通过 `HasAddress` 联系管理多个**收货地址**。其消费行为通过 `Places` 联系产生**订单**。**订单**通过 `Contains` 联系聚合多条**订单明细**，每条明细通过 `Orders` 联系指向具体的**书目**。若实现分次发货，**订单**会进一步通过 `GeneratesShipment` 联系产生**发货单**，**发货单**通过 `ContainsGoods` 联系包含**发货明细**，每条发货明细通过 `Ships` 联系指向具体的**订单明细**。
*   **库存**数量不足时，系统或人工通过 `GeneratesDemandFor` 联系为**书目**创建**缺书记录**。管理员根据缺书记录，向特定**供应商** (`IssuedTo`) 创建**采购单**，其中包含的**采购明细** (`Purchases`) 指向**书目**，并可能通过属性关联回**缺书记录** (`IsFulfilledBy`)。采购到货后，更新**库存**，完成业务闭环。

所有联系均标注了类型和关键的基数约束（如1:1, 1:N, M:N），并体现了重要的业务规则（如数量限制、唯一性约束），共同构成了一张完整反映网上书店数据流动与存储的概念网络。

**网上书店管理系统的数据库的ER图如下：**

![ER.drawio (2)](D:\数据库系统原理\上机实验\ER.drawio (2).svg)

---

### **2.6 概念模型设计小结**

通过以上详细设计，我们得到了"网上书店管理系统"的完整概念模型。该模型具有以下特点：
1.  **业务匹配度高**：每个实体、属性和联系都源自明确的业务需求，真实反映了网上书店的运营逻辑，全面覆盖了供书目录、库存、采购、客户、订单、发货、供应商等核心业务。
2.  **结构清晰规范**：采用标准的E-R方法，明确了主键、依赖关系和约束条件，为向逻辑模型（关系模式）的无损转换做好了充分准备。
3.  **约束显性化**：作者顺序、关键字数量、信用规则、缺书记录唯一性等业务约束已在模型层面得到明确体现。
4.  **扩展性良好**：通过引入`Shipment`、`BookSeries`等可选实体和对联系属性的设计，为未来功能扩展（分次发货、丛书管理）预留了清晰的数据接口。
5.  **支持复杂查询**：模型结构天然支持多维度书目检索（按作者、关键字、出版社等）、客户订单跟踪、缺书采购追溯等复杂查询需求。

此概念模型是后续**逻辑结构设计**和**物理设计**的坚实基础与根本依据。

## **第 3 部分：逻辑结构设计（关系模型设计）**

### **3.1 设计原则与转换规则**

#### **3.1.1 关系模型设计原则**

本次逻辑设计遵循以下核心原则，确保最终数据模型兼具规范性、实用性、可维护性与高性能。

1.  **完整性映射**：确保将概念模型（E-R图）中的所有实体、联系及其属性，通过标准转换规则，无损且精确地映射为一系列关系模式（数据表），并能支持所有业务功能的实现。
2.  **规范化优先**：关系模式的设计优先满足**第三范式（3NF）**，以最大限度地消除数据冗余和插入、删除、更新异常，保证数据的一致性和存储效率。这将通过严格的数据依赖分析和分解实现。
3.  **完整性约束前置**：在设计阶段即明确并记录每一张表所应具备的实体完整性（主键）、参照完整性（外键）、域完整性（数据类型、非空、检查约束）以及用户定义完整性（业务规则）。这些约束是数据库正确性的基石。
4.  **性能与应用平衡**：在遵循3NF的基础上，对特定高频、复杂查询的场景，进行审慎的**反规范化**或**适度冗余**设计（如快照字段、汇总字段），以空间换取时间，优化查询性能。任何冗余数据必须有明确的维护机制（如触发器、存储过程）保证一致性。
5.  **可扩展性与前瞻性**：表结构设计需为需求中明确的"可选功能"以及潜在的未来扩展预留合理的接口和字段，确保新增功能时，对已有核心结构的改动最小。
6.  **命名规范与清晰性**：采用清晰、一致且具有业务含义的英文或拼音缩写命名表与字段，便于开发、维护与沟通。

#### **3.1.2 E-R模型向关系模式的转换规则**

严格遵循以下标准转换规则：

1.  **实体转换为表**：每个强实体转换为一张关系表，实体的属性转换为表的列，实体的标识符转换为主键。
2.  **1:1联系**：可并入任意一端实体对应的表中，作为外键。若双方参与度均为强制（1,1），可合并为一张表。本设计中，`书目-库存`为1:1，但为清晰表达库存的动态管理特性，采用独立成表并以外键关联的方式。
3.  **1:N联系**：在"N"端（多方）的表中，加入"1"端（一方）的主键作为外键。例如，`客户-订单`联系中，在 `SalesOrder` 表中加入 `CustomerID` 外键；`客户-地址`联系中，在 `CustomerAddress` 表中加入 `CustomerID` 外键。
4.  **M:N联系**：转换为一张独立的**关联表**。该表至少包含两端实体的主键作为外键，这两个外键的组合通常构成该关联表的主键。例如，`书目-作者`联系转换为 `BookAuthor` 表；`书目-关键字`联系转换为 `BookKeyword` 表；`书目-供应商`联系转换为 `Supply` 表。
5.  **联系属性的处理**：联系自身的属性置于对应的关联表中。例如，`作者顺序(AuthorOrder)` 是"书目-作者"联系的属性，因此存放在 `BookAuthor` 表中；`供货价格(SupplyPrice)` 是"书目-供应商"联系的属性，存放在 `Supply` 表中。
6.  **弱实体的处理**：弱实体（如订单明细、采购明细）必须转换为一张表，并将其所依赖的强实体（如订单、采购单）的主键作为该表外键的一部分或全部。弱实体的主键通常是其依赖的强实体主键与一个辨别符的组合。
7.  **可选扩展实体的处理**：对于可选功能对应的实体（如`发货单`、`发货明细`、`丛书`），在设计时保留对应的表结构，但在实现时可标记为可选。

---

### **3.2 关系模式总览**

根据上述原则和规则，网上书店管理系统的数据库将包含以下关系表，按其业务逻辑分层如下：

#### **3.2.1 基础与配置数据层**
此层数据相对稳定，是系统运行的基础。
1.  **`Book`** - 书目基本信息表
2.  **`Author`** - 作者信息表
3.  **`BookAuthor`** - 书目与作者关联表（含顺序）
4.  **`Keyword`** - 关键字字典表
5.  **`BookKeyword`** - 书目与关键字关联表
6.  **`Supplier`** - 供应商信息表
7.  **`Supply`** - 供应商供货关系表
8.  **`CreditLevel`** - 信用等级规则字典表
9.  **`BookSeries`** (可选) - 丛书信息表

#### **3.2.2 核心业务数据层**
此层数据是系统动态业务的核心记录。
10. **`Customer`** - 客户信息表
11. **`CustomerAddress`** - 客户收货地址表
12. **`Inventory`** - 书目库存表
13. **`SalesOrder`** - 客户订单主表
14. **`SalesOrderItem`** - 订单明细表
15. **`Shipment`** (可选) - 发货单主表
16. **`ShipmentItem`** (可选) - 发货明细表

#### **3.2.3 物流与采购数据层**
此层数据支持库存补充与订单履约流程。
17. **`OutOfStockRecord`** - 缺书记录表
18. **`PurchaseOrder`** - 采购单主表
19. **`PurchaseOrderItem`** - 采购明细表

---

### **3.3 详细关系模式设计**

以下对每张表进行详细定义，包括：**表名、字段名、数据类型（逻辑层面）、是否为空、默认值、主键/外键约束、其他业务约束**。MySQL具体数据类型将在物理设计部分确定。

#### **3.3.1 基础与配置数据层表**

**1. 书目表 (Book)**
*   **描述**：存储图书的静态描述信息，支持丛书标识。
*   **主键**：`book_id`
*   **字段**：
    | 字段名            | 逻辑类型 | 空否     | 默认值      | 说明                           | 约束               |
    | :---------------- | :------- | :------- | :---------- | :----------------------------- | :----------------- |
    | `book_id`         | 字符型   | NOT NULL |             | **书号**，系统唯一标识         | **PK**             |
    | `isbn`            | 字符型   | NULL     |             | 国际标准书号                   | Unique             |
    | `title`           | 字符型   | NOT NULL |             | 书名                           |                    |
    | `publisher`       | 字符型   | NOT NULL |             | 出版社                         |                    |
    | `publish_date`    | 日期型   | NULL     |             | 出版日期                       |                    |
    | `edition`         | 字符型   | NULL     |             | 版次                           |                    |
    | `price`           | 数值型   | NOT NULL |             | 定价（元）                     | >= 0               |
    | `cover_image_url` | 字符型   | NULL     |             | 封面图片存储路径               |                    |
    | `catalog`         | 文本型   | NULL     |             | 内容目录/简介                  |                    |
    | `series_flag`     | 布尔型   | NOT NULL | FALSE       | 是否为丛书                     |                    |
    | `parent_book_id`  | 字符型   | NULL     |             | 所属丛书父书号（若为丛书子书） | FK → Book(book_id) |
    | `status`          | 枚举型   | NOT NULL | 'AVAILABLE' | 状态：在售/停售                |                    |

此表主要存储图书的核心静态信息，涵盖了书号（唯一标识）、ISBN、书名、出版社、定价、出版日期及丛书标识等关键字段。作为系统的核心实体，它为前台的书目浏览、检索以及后台的库存管理与采购业务提供了基础数据支撑，是连接采购、销售与库存的枢纽。

**2. 作者表 (Author)**

*   **描述**：存储作者信息。
*   **主键**：`author_id`
*   **字段**：
    | 字段名        | 逻辑类型 | 空否     | 默认值 | 说明               | 约束   |
    | :------------ | :------- | :------- | :----- | :----------------- | :----- |
    | `author_id`   | 数值型   | NOT NULL |        | **作者编号**，自增 | **PK** |
    | `author_name` | 字符型   | NOT NULL |        | 作者姓名           |        |
    | `nationality` | 字符型   | NULL     |        | 国籍               |        |
    | `biography`   | 文本型   | NULL     |        | 作者简介           |        |

此表独立存储了作者的个人信息，包括作者编号、姓名、国籍及简介。通过独立建表，避免了在图书信息中重复录入同一作者的数据，既消除了数据冗余，也为系统实现“按作者维度进行统计和检索”提供了数据基础。

**3. 书目-作者关联表 (BookAuthor)**

*   **描述**：实现书目与作者的多对多关系，并记录作者顺序。
*   **主键**：`(book_id, author_order)`
*   **字段**：
    | 字段名         | 逻辑类型 | 空否     | 默认值 | 说明               | 约束                                   |
    | :------------- | :------- | :------- | :----- | :----------------- | :------------------------------------- |
    | `book_id`      | 字符型   | NOT NULL |        | 书号               | **FK → Book(book_id)**, **PK的一部分** |
    | `author_id`    | 数值型   | NOT NULL |        | 作者编号           | **FK → Author(author_id)**             |
    | `author_order` | 数值型   | NOT NULL |        | 作者顺序 (1,2,3,4) | **PK的一部分**，值域 {1,2,3,4}         |
*   **候选键/唯一约束**：`(book_id, author_id)` 确保同一作者不被重复关联到同一本书。
*   **业务约束**：对于同一个 `book_id`，`author_order` 必须连续且唯一（1~4）。需要通过应用逻辑或数据库触发器保证每本书最多4条记录。

此表作为关联表，通过引用书号和作者编号，实现了图书与作者之间的多对多关系，并专门记录了`author_order`字段以明确作者在书籍中的排名顺序。它确立了“一书多作者且有序”的业务规则，保证了书目署名信息的完整性与准确性。

**4. 关键字表 (Keyword)**
*   **描述**：系统所有关键字的字典。
*   **主键**：`keyword_id`
*   **字段**：
    | 字段名         | 逻辑类型 | 空否     | 默认值 | 说明                 | 约束   |
    | :------------- | :------- | :------- | :----- | :------------------- | :----- |
    | `keyword_id`   | 数值型   | NOT NULL |        | **关键字编号**，自增 | **PK** |
    | `keyword_text` | 字符型   | NOT NULL |        | 关键字内容           | Unique |

此表维护了系统内所有可用的检索关键字字典，包括关键字编号和内容。通过统一管理关键字，系统能够规范化图书的标签体系，便于进行热词统计，并支持用户通过标签快速定位感兴趣的图书类别。

**5. 书目-关键字关联表 (BookKeyword)**

*   **描述**：实现书目与关键字的多对多关系。
*   **主键**：`(book_id, keyword_id)`
*   **字段**：
    | 字段名       | 逻辑类型 | 空否     | 默认值 | 说明       | 约束                                         |
    | :----------- | :------- | :------- | :----- | :--------- | :------------------------------------------- |
    | `book_id`    | 字符型   | NOT NULL |        | 书号       | **FK → Book(book_id)**, **PK的一部分**       |
    | `keyword_id` | 数值型   | NOT NULL |        | 关键字编号 | **FK → Keyword(keyword_id)**, **PK的一部分** |
*   **业务约束**：需要通过应用逻辑或触发器保证每本书 (`book_id`) 关联的关键字不超过10个。

此表记录了图书与关键字之间的多对多映射关系。它允许一本书被打上多个标签，从而支持系统实现多维度的书目检索与分类展示，极大地提升了用户在网上书店的搜索体验和检索命中率。

**6. 供应商表 (Supplier)**

*   **描述**：存储图书供应商信息。
*   **主键**：`supplier_id`
*   **字段**：
    
    | 字段名           | 逻辑类型 | 空否     | 默认值   | 说明                     | 约束   |
    | :--------------- | :------- | :------- | :------- | :----------------------- | :----- |
    | `supplier_id`    | 数值型   | NOT NULL |          | **供应商编号**，自增     | **PK** |
    | `supplier_name`  | 字符型   | NOT NULL |          | 供应商名称               |        |
    | `contact_person` | 字符型   | NULL     |          | 联系人                   |        |
    | `phone`          | 字符型   | NULL     |          | 联系电话                 |        |
    | `email`          | 字符型   | NULL     |          | 电子邮箱                 |        |
    | `address`        | 字符型   | NULL     |          | 地址                     |        |
    | `payment_terms`  | 字符型   | NULL     |          | 结算方式                 |        |
    | `status`         | 枚举型   | NOT NULL | 'ACTIVE' | 合作状态：活跃/暂停/终止 |        |

此表存储了所有图书供应商的基础档案，包括供应商名称、联系人、电话、地址及结算方式等信息。它对于管理书店的供应链资源、维护供货商关系以及后续生成采购订单至关重要。

**7. 供货关系表 (Supply)**

*   **描述**：实现供应商与书目之间的多对多供货关系，记录供货价等联系属性。
*   **主键**：`(supplier_id, book_id)`
*   **字段**：
    | 字段名           | 逻辑类型 | 空否     | 默认值 | 说明             | 约束                                           |
    | :--------------- | :------- | :------- | :----- | :--------------- | :--------------------------------------------- |
    | `supplier_id`    | 数值型   | NOT NULL |        | 供应商编号       | **FK → Supplier(supplier_id)**, **PK的一部分** |
    | `book_id`        | 字符型   | NOT NULL |        | 书号             | **FK → Book(book_id)**, **PK的一部分**         |
    | `supply_price`   | 数值型   | NULL     |        | 供货单价（元）   | >= 0                                           |
    | `lead_time_days` | 数值型   | NULL     |        | 供货周期（天）   | > 0                                            |
    | `is_primary`     | 布尔型   | NOT NULL | FALSE  | 是否为主要供货商 |                                                |

此表建立了供应商与具体图书之间的多对多供货联系，并记录了特定供应商针对某本书的供货价格、供货周期及是否为首选供应商。这为采购人员在缺书补货时选择最优货源提供了决策依据。

**8. 信用等级表 (CreditLevel)**

*   **描述**：信用等级业务规则的参数化存储，包含五级具体规则。
*   **主键**：`level_id`
*   **字段**：
    | 字段名                   | 逻辑类型 | 空否     | 默认值 | 说明                                 | 约束                           |
    | :----------------------- | :------- | :------- | :----- | :----------------------------------- | :----------------------------- |
    | `level_id`               | 数值型   | NOT NULL |        | **等级编号** (1-5)                   | **PK**                         |
    | `level_name`             | 字符型   | NOT NULL |        | 等级名称（如"一级会员"）             | Unique                         |
    | `discount_rate`          | 数值型   | NOT NULL | 1.0    | 折扣率 (0.0 ~ 1.0)                   | >0 AND <=1，与五级信用规则一致 |
    | `allow_overdraft`        | 布尔型   | NOT NULL | FALSE  | 是否允许透支                         |                                |
    | `overdraft_limit`        | 数值型   | NULL     |        | 透支额度（元），NULL表示无限制       | >=0                            |
    | `upgrade_condition_desc` | 字符型   | NULL     |        | 升级条件描述（如"累计消费满1000元"） |                                |
    | `upgrade_threshold`      | 数值型   | NULL     |        | 升级阈值（金额）                     | >=0                            |

此表参数化地定义了客户信用等级体系，详细记录了各等级（如一级到五级）对应的折扣率、是否允许透支及具体的透支额度规则。它是系统自动计算订单实付金额、执行发货前风险校验（资金能力验证）的核心规则配置表。

**9. 丛书表 (BookSeries) (可选)**

*   **描述**：管理丛书信息，支持一个书号对应多本实体书。
*   **主键**：`series_id`
*   **字段**：
    
    | 字段名               | 逻辑类型 | 空否     | 默认值 | 说明         | 约束   |
    | :------------------- | :------- | :------- | :----- | :----------- | :----- |
    | `series_id`          | 数值型   | NOT NULL |        | **丛书编号** | **PK** |
    | `series_name`        | 字符型   | NOT NULL |        | 丛书名称     |        |
    | `series_description` | 文本型   | NULL     |        | 丛书描述     |        |

此表用于管理丛书的集合信息，记录了丛书的编号、名称及描述。它与书目表配合，支持将多本独立的实体书在逻辑上归纳为一套丛书，方便在前台进行成套展示和在后台进行成套管理。

#### **3.3.2 核心业务数据层表**

**10. 客户表 (Customer)**

*   **描述**：存储注册客户信息及其账户、信用状态，支持累计消费统计。
*   **主键**：`customer_id`
*   **字段**：
    | 字段名              | 逻辑类型 | 空否     | 默认值            | 说明                 | 约束                           |
    | :------------------ | :------- | :------- | :---------------- | :------------------- | :----------------------------- |
    | `customer_id`       | 数值型   | NOT NULL |                   | **客户编号**，自增   | **PK**                         |
    | `username`          | 字符型   | NOT NULL |                   | 登录用户名           | Unique                         |
    | `password_hash`     | 字符型   | NOT NULL |                   | 密码哈希值           |                                |
    | `real_name`         | 字符型   | NOT NULL |                   | 真实姓名             |                                |
    | `mobile_phone`      | 字符型   | NULL     |                   | 手机号               | Unique                         |
    | `email`             | 字符型   | NULL     |                   | 电子邮箱             | Unique                         |
    | `account_balance`   | 数值型   | NOT NULL | 0.00              | 账户余额（元）       |                                |
    | `total_consumption` | 数值型   | NOT NULL | 0.00              | 历史累计消费额（元） | >=0                            |
    | `level_id`          | 数值型   | NOT NULL |                   | 信用等级编号         | **FK → CreditLevel(level_id)** |
    | `registration_time` | 时间戳   | NOT NULL | CURRENT_TIMESTAMP | 注册时间             |                                |
    | `status`            | 枚举型   | NOT NULL | 'ACTIVE'          | 账户状态：活跃/冻结  |                                |

此表集中存储了注册客户的个人档案、账户资产及信用状态信息，包括登录凭证、联系方式、账户余额、累计消费额及所属信用等级。它是系统识别用户身份、管理客户资产以及实施差异化信用策略（如折扣与透支权限控制）的根本依据。

**11. 客户地址表 (CustomerAddress)**

*   **描述**：存储客户的一个或多个收货地址。
*   **主键**：`address_id`
*   **字段**：
    
    | 字段名            | 逻辑类型 | 空否     | 默认值 | 说明                       | 约束                           |
    | :---------------- | :------- | :------- | :----- | :------------------------- | :----------------------------- |
    | `address_id`      | 数值型   | NOT NULL |        | **地址编号**，自增         | **PK**                         |
    | `customer_id`     | 数值型   | NOT NULL |        | 客户编号                   | **FK → Customer(customer_id)** |
    | `recipient_name`  | 字符型   | NOT NULL |        | 收件人姓名                 |                                |
    | `recipient_phone` | 字符型   | NOT NULL |        | 收件人电话                 |                                |
    | `province`        | 字符型   | NOT NULL |        | 省份                       |                                |
    | `city`            | 字符型   | NOT NULL |        | 城市                       |                                |
    | `district`        | 字符型   | NOT NULL |        | 区县                       |                                |
    | `detail_address`  | 字符型   | NOT NULL |        | 详细地址                   |                                |
    | `is_default`      | 布尔型   | NOT NULL | FALSE  | 是否为默认地址             |                                |
    | `tag`             | 字符型   | NULL     |        | 地址标签（如"家"、"公司"） |                                |

此表记录了客户维护的一个或多个收货地址信息，包含收件人姓名、联系电话、省市区及详细地址，并标记了默认地址。通过将地址独立管理，系统支持客户在下单时灵活选择配送目的地，提升了购物体验并确保了物流配送信息的准确性。

**12. 库存表 (Inventory)**

*   **描述**：记录每种书目的实时库存，包含安全库存阈值。
*   **主键**：`book_id` (与书目表一对一)
*   **字段**：
    | 字段名          | 逻辑类型 | 空否     | 默认值            | 说明             | 约束                           |
    | :-------------- | :------- | :------- | :---------------- | :--------------- | :----------------------------- |
    | `book_id`       | 字符型   | NOT NULL |                   | **书号**         | **PK**, **FK → Book(book_id)** |
    | `quantity`      | 数值型   | NOT NULL | 0                 | 当前可用库存数量 | >=0                            |
    | `safety_stock`  | 数值型   | NOT NULL | 5                 | 安全库存阈值     | >=0                            |
    | `location_code` | 字符型   | NULL     |                   | 库位编码         |                                |
    | `last_updated`  | 时间戳   | NOT NULL | CURRENT_TIMESTAMP | 最后更新时间     |                                |

此表动态记录了每种书目的实时库存数量、安全库存阈值及物理库位信息。作为连接采购与销售的核心状态表，它直接决定了前台书籍是否“在售/缺货”，并负责在库存不足时触发预警以驱动后续的补货流程，是防止超卖和断货的关键控制点。

**13. 订单表 (SalesOrder)**

*   **描述**：记录客户的一次购买订单，包含折扣快照和地址快照。
*   **主键**：`order_id`
*   **字段**：
    | 字段名                | 逻辑类型 | 空否     | 默认值            | 说明                                                  | 约束                                 |
    | :-------------------- | :------- | :------- | :---------------- | :---------------------------------------------------- | :----------------------------------- |
    | `order_id`            | 字符型   | NOT NULL |                   | **订单号**，规则生成                                  | **PK**                               |
    | `customer_id`         | 数值型   | NOT NULL |                   | 客户编号                                              | **FK → Customer(customer_id)**       |
    | `order_time`          | 时间戳   | NOT NULL | CURRENT_TIMESTAMP | 下单时间                                              |                                      |
    | `order_status`        | 枚举型   | NOT NULL | 'PENDING_PAYMENT' | 订单状态：待支付/待发货/部分发货/已发货/已完成/已取消 |                                      |
    | `goods_amount`        | 数值型   | NOT NULL | 0.00              | 商品总金额（折扣前）                                  | >=0                                  |
    | `discount_rate`       | 数值型   | NOT NULL |                   | 下单时折扣率快照                                      | >0 AND <=1                           |
    | `payable_amount`      | 数值型   | NOT NULL | 0.00              | 实付金额（折扣后）                                    | >=0                                  |
    | `shipping_address_id` | 数值型   | NOT NULL |                   | 收货地址ID                                            | **FK → CustomerAddress(address_id)** |
    | `payment_time`        | 时间戳   | NULL     |                   | 支付时间                                              |                                      |
    | `customer_note`       | 文本型   | NULL     |                   | 客户备注                                              |                                      |

此表是交易的核心凭证，记录了客户一次购买行为的主体信息，包括订单状态流转（待付、待发、已发等）、商品总金额、实付金额、下单时的折扣率快照及收货地址快照。它串联了从下单、支付到发货的全生命周期，是财务结算和物流调度的总控中心。

**14. 订单明细表 (SalesOrderItem)**

*   **描述**：记录订单中包含的具体商品，支持分次发货跟踪。
*   **主键**：`order_item_id` (独立主键，便于与发货关联)
*   **字段**：
    | 字段名          | 逻辑类型 | 空否     | 默认值    | 说明                                                    | 约束                          |
    | :-------------- | :------- | :------- | :-------- | :------------------------------------------------------ | :---------------------------- |
    | `order_item_id` | 数值型   | NOT NULL |           | **明细项ID**，自增                                      | **PK**                        |
    | `order_id`      | 字符型   | NOT NULL |           | 订单号                                                  | **FK → SalesOrder(order_id)** |
    | `book_id`       | 字符型   | NOT NULL |           | 书号                                                    | **FK → Book(book_id)**        |
    | `quantity`      | 数值型   | NOT NULL |           | 订购数量                                                | >0                            |
    | `unit_price`    | 数值型   | NOT NULL |           | 成交单价（快照）                                        | >=0                           |
    | `subtotal`      | 数值型   | NOT NULL |           | 小计金额 (quantity * unit_price)                        | >=0                           |
    | `item_status`   | 枚举型   | NOT NULL | 'ORDERED' | 明细状态：已下单/已发货/已完成/已取消，支持分次发货跟踪 |                               |
*   **候选键**：`(order_id, book_id)`，可选唯一约束，防止同一订单中重复添加同一种书（除非业务允许）。

此表详细记录了订单中包含的具体图书项目、订购数量及成交单价快照。它不仅实现了“一单多书”的业务需求，还通过记录每项商品的独立状态，支持了针对单本书籍的精细化状态跟踪（如分次发货场景），为订单履约提供了颗粒度更细的数据支持。

**15. 发货单表 (Shipment) (可选扩展)**

*   **描述**：记录一次发货行为，支持分次发货。
*   **主键**：`shipment_id`
*   **字段**：
    | 字段名            | 逻辑类型 | 空否     | 默认值            | 说明                           | 约束                          |
    | :---------------- | :------- | :------- | :---------------- | :----------------------------- | :---------------------------- |
    | `shipment_id`     | 字符型   | NOT NULL |                   | **发货单号**                   | **PK**                        |
    | `order_id`        | 字符型   | NOT NULL |                   | 关联的订单号                   | **FK → SalesOrder(order_id)** |
    | `ship_time`       | 时间戳   | NOT NULL | CURRENT_TIMESTAMP | 发货时间                       |                               |
    | `carrier`         | 字符型   | NULL     |                   | 物流公司                       |                               |
    | `tracking_number` | 字符型   | NULL     |                   | 运单号                         |                               |
    | `shipment_status` | 枚举型   | NOT NULL | 'SHIPPED'         | 发货状态：已出库/运输中/已签收 |                               |
    | `operator`        | 字符型   | NULL     |                   | 操作员                         |                               |

此表记录了仓库实际执行发货的操作详情，包括发货时间、物流公司、运单号及操作员信息。在支持“一单分多次发货”的复杂业务场景下，它负责将逻辑上的订单与物理上的物流包裹关联起来，方便客户精确追踪每一次发货的包裹状态。

**16. 发货明细表 (ShipmentItem) (可选扩展)**

*   **描述**：记录一次发货中包含的具体商品及数量。
*   **主键**：`(shipment_id, order_item_id)`
*   **字段**：
    | 字段名          | 逻辑类型 | 空否     | 默认值 | 说明         | 约束                                                   |
    | :-------------- | :------- | :------- | :----- | :----------- | :----------------------------------------------------- |
    | `shipment_id`   | 字符型   | NOT NULL |        | 发货单号     | **FK → Shipment(shipment_id)**, **PK的一部分**         |
    | `order_item_id` | 数值型   | NOT NULL |        | 订单明细项ID | **FK → SalesOrderItem(order_item_id)**, **PK的一部分** |
    | `ship_quantity` | 数值型   | NOT NULL |        | 本次发货数量 | >0                                                     |

此表描述了某次具体发货行为中实际包含的图书及数量。通过与订单明细的映射，它精确记录了哪些书在哪个包裹中被发出，确保了物流信息的准确性，防止漏发或错发，并为库存扣减提供了物理凭证。

#### **3.3.3 物流与采购数据层表**

**17. 缺书记录表 (OutOfStockRecord)**
*   **描述**：记录因库存不足产生的采购需求，支持多种生成方式。
*   **主键**：`record_id`
*   **字段**：
    
    | 字段名                | 逻辑类型 | 空否     | 默认值            | 说明                                              | 约束                           |
    | :-------------------- | :------- | :------- | :---------------- | :------------------------------------------------ | :----------------------------- |
    | `record_id`           | 数值型   | NOT NULL |                   | **缺书记录ID**，自增                              | **PK**                         |
    | `book_id`             | 字符型   | NOT NULL |                   | 书号                                              | **FK → Book(book_id)**         |
    | `required_quantity`   | 数值型   | NOT NULL |                   | 需求数量                                          | >0                             |
    | `record_date`         | 时间戳   | NOT NULL | CURRENT_TIMESTAMP | 登记日期                                          |                                |
    | `source`              | 枚举型   | NOT NULL |                   | 来源：手动登记/库存预警/客户订单触发/客户缺书登记 |                                |
    | `related_customer_id` | 数值型   | NULL     |                   | 关联客户（若由客户触发）                          | **FK → Customer(customer_id)** |
    | `status`              | 枚举型   | NOT NULL | 'PENDING'         | 状态：待处理/已生成采购/已到货                    |                                |
    | `priority`            | 数值型   | NULL     |                   | 优先级（可选）                                    |                                |
    | `quoted_price`        | 数值型   | NULL     |                   | 报价（元），管理员针对询价给出的价格              | \>= 0                          |
    | `inquiry_notes`       | 文本型   | NULL     |                   | 询价备注，记录客户的具体需求说明                  |                                |

此表记录了所有因库存不足或人为需求产生的缺书事项，包含缺书数量、登记日期、记录来源（如库存预警、客户登记）及处理状态。它是采购流程的起点，系统依据这些记录生成采购计划，并支持在到货后追溯通知相关客户，实现了需求与供应的精准对接。

**18. 采购单表 (PurchaseOrder)**

*   **描述**：记录向供应商的采购请求。
*   **主键**：`purchase_order_id`
*   **字段**：
    | 字段名                   | 逻辑类型 | 空否     | 默认值            | 说明                                     | 约束                           |
    | :----------------------- | :------- | :------- | :---------------- | :--------------------------------------- | :----------------------------- |
    | `purchase_order_id`      | 字符型   | NOT NULL |                   | **采购单号**                             | **PK**                         |
    | `supplier_id`            | 数值型   | NOT NULL |                   | 供应商编号                               | **FK → Supplier(supplier_id)** |
    | `create_date`            | 时间戳   | NOT NULL | CURRENT_TIMESTAMP | 创建日期                                 |                                |
    | `expected_date`          | 日期型   | NULL     |                   | 期望到货日期                             |                                |
    | `buyer`                  | 字符型   | NULL     |                   | 采购员                                   |                                |
    | `total_estimated_amount` | 数值型   | NULL     |                   | 总预估金额                               | >=0                            |
    | `status`                 | 枚举型   | NOT NULL | 'DRAFT'           | 状态：草稿/已发出/部分到货/已完成/已取消 |                                |

此表记录了书店向供应商发出的正式采购订单，包含采购单号、供应商信息、预估总额及订单流转状态（如草稿、已发出、部分到货）。它负责统筹管理与供应商的交易过程，跟踪采购进度，是书店补充库存的法律与财务凭证。

**19. 采购明细表 (PurchaseOrderItem)**

*   **描述**：记录采购单中要采购的具体书目，可关联缺书记录。
*   **主键**：`(purchase_order_id, book_id)`
*   **字段**：
    | 字段名                    | 逻辑类型 | 空否     | 默认值 | 说明             | 约束                                                      |
    | :------------------------ | :------- | :------- | :----- | :--------------- | :-------------------------------------------------------- |
    | `purchase_order_id`       | 字符型   | NOT NULL |        | 采购单号         | **FK → PurchaseOrder(purchase_order_id)**, **PK的一部分** |
    | `book_id`                 | 字符型   | NOT NULL |        | 书号             | **FK → Book(book_id)**, **PK的一部分**                    |
    | `purchase_quantity`       | 数值型   | NOT NULL |        | 采购数量         | >0                                                        |
    | `purchase_price`          | 数值型   | NULL     |        | 采购单价         | >=0                                                       |
    | `related_out_of_stock_id` | 数值型   | NULL     |        | 关联的缺书记录ID | **FK → OutOfStockRecord(record_id)**                      |

此表详细描述了采购单中包含的具体图书条目、采购数量及议定价格，并可选关联具体的缺书记录ID。它实现了采购需求与具体缺书记录的闭环追踪，确保每一次采购都有据可依，并在到货时准确核销对应的缺书需求，完成了从“发现缺货”到“补货入库”的业务闭环。

### **3.4 规范化与范式分析**

本设计严格遵循关系数据库规范化理论，对大部分表的设计进行了范式分析，以确保良好的数据组织结构。

#### **3.4.1 第一范式 (1NF)**
所有表均满足1NF，即：
*   每个属性（列）都是**原子的、不可再分**的。例如，作者、关键字等均以独立实体和关联表的形式存在，而非在 `Book` 表中以逗号分隔的字符串存储。
*   每行数据都是唯一的，由主键标识。
*   列的顺序无关紧要。

#### **3.4.2 第二范式 (2NF)**
在满足1NF的基础上，检查所有非主属性对主键的**完全函数依赖**。本设计中：
*   对于具有**单属性主键**的表（如 `Book`, `Customer`），其所有非主属性都直接依赖于整个主键，自然满足2NF。
*   对于具有**复合主键**的表（如 `BookAuthor`, `PurchaseOrderItem`），其非主属性都依赖于**整个复合主键**，而非部分主键。例如，在 `BookAuthor` 表中，`author_id` 依赖于 `(book_id, author_order)` 才能确定（区分第一、第二作者），因此满足2NF。

#### **3.4.3 第三范式 (3NF)**
在满足2NF的基础上，消除**传递函数依赖**。本设计通过分解，使所有非主属性都**直接依赖于主键**，而不依赖于其他非主属性。
*   **典型处理**：在 `Customer` 表中，信用等级相关的折扣、透支规则并未直接存储，而是通过 `level_id` 外键关联到独立的 `CreditLevel` 字典表。这样，`discount_rate` 等属性依赖于 `CreditLevel` 的主键 `level_id`，而非直接或间接依赖于 `Customer` 的主键 `customer_id`，消除了传递依赖，满足3NF。
*   **受控冗余**：为了**性能**和**历史追溯**，我们审慎地引入了少量冗余，这些冗余属于"反规范化"设计，但均有明确的维护机制：
    1.  **订单快照**：`SalesOrder` 表中的 `discount_rate`, `payable_amount` 以及 `SalesOrderItem` 表中的 `unit_price`。这些是下单时客户等级和图书定价的快照，用于保证订单历史数据的稳定性。它们通过下单事务一次性计算并存储，后续不再修改。
    2.  **汇总字段**：`SalesOrder` 表中的 `goods_amount` 和 `payable_amount` 可由 `SalesOrderItem` 汇总得到。存储它们是为了避免高频查询时频繁的 `SUM` 联表操作，提高订单列表查询性能。这些字段必须在订单明细插入、更新或删除时，通过**触发器**或**存储过程**进行同步更新，以确保数据一致性。
    3.  **客户累计消费**：`Customer` 表中的 `total_consumption` 可由历史订单汇总得到。存储它是为了支持信用自动升级规则的高效判断。该字段在订单完成支付时，由事务更新。
    4.  **地址快照**：`SalesOrder` 表中的 `shipping_address_id` 是地址快照，确保订单历史地址的不可变性。

**结论**：除为优化性能而精心设计的受控冗余外，本数据库逻辑设计整体满足**第三范式 (3NF)**。这最大程度地减少了数据冗余和更新异常，同时通过索引、视图和应用层缓存等策略，确保了在复杂查询场景下的性能可接受性。

---

### **3.5 本部分小结**

本部分完成了从概念模型到关系模型的精确转换，定义了共19张核心关系表的结构（包含可选表），并详细说明了每张表的字段、主键、外键及关键业务约束。设计遵循了规范化理论，主体满足3NF，并对关键性能瓶颈进行了合理的反规范化考虑。

**关键设计亮点：**
1.  **完整覆盖业务需求**：表设计完整覆盖了书目管理、库存控制、采购补货、客户管理、信用体系、订单处理、发货物流、供应商管理等全部核心业务。
2.  **约束体系完善**：通过主键、外键、唯一约束、检查约束构建了基本的数据完整性保障，为后续触发器和存储过程实现复杂业务规则奠定了基础。
3.  **扩展性良好**：通过可选表（`Shipment`, `ShipmentItem`, `BookSeries`）和预留字段，支持分次发货、丛书管理、信用自动调整等扩展功能。
4.  **性能优化考虑**：通过快照机制、汇总字段等受控冗余设计，优化了高频查询性能，同时保证了数据的一致性。

**为后续章节的接口**：此逻辑模型是进行**物理设计**（确定MySQL具体数据类型、索引、存储引擎等）的直接蓝图。同时，本模型中标识的"受控冗余"字段和外键关系，是后续设计**触发器**和**存储过程**以维护数据完整性与业务规则的核心依据。在下一部分，我们将基于此逻辑模型，进行针对MySQL 8的物理实现设计。

## **第 4 部分：物理设计（MySQL 8）**

### **4.1 物理设计目标与原则**

#### **4.1.1 目标**
本阶段物理设计旨在将第3部分完成的逻辑结构模型，高效、可靠、可维护地落地到 MySQL 8 数据库管理系统中，具体目标如下：
1.  **实现落地**：提供可直接在 MySQL 8 上执行的数据库结构定义（DDL），建立完整的网上书店数据库。
2.  **性能优化**：在保证数据一致性与完整性的前提下，通过合理的数据类型、索引、存储引擎选择，优化高频业务操作（如书目检索、订单查询、库存更新）的性能。
3.  **规则固化**：将关键的、复杂的业务规则（如数量限制、完整性校验、状态流转）通过数据库层面的约束、触发器、存储过程进行固化，确保无论应用层如何变化，核心业务逻辑依然正确。
4.  **可维护性**：设计清晰、规范的物理结构，便于后续的数据库监控、备份、迁移和性能调优。
5.  **支持网上书店特色功能**：特别优化书目多条件检索（包括作者顺序查询、关键字匹配）、客户订单跟踪、库存预警等网上书店核心业务场景。

#### **4.1.2 核心原则**
*   **编码统一化**：全库采用 `utf8mb4` 字符集和一致的排序规则，彻底解决中文存储与比较问题。
*   **类型精确化**：为每个字段选择最精确、最节省空间的 MySQL 数据类型，精确表达业务语义（如金额用 `DECIMAL`，状态用 `TINYINT`，日期时间用 `DATETIME`/`TIMESTAMP`）。
*   **索引服务化**：索引设计完全以支撑高频查询、保障外键性能为导向，避免创建无用或重复索引。特别关注书目检索、订单查询、库存更新等关键路径。
*   **约束显性化**：优先使用数据库原生约束（`PRIMARY KEY`, `FOREIGN KEY`, `UNIQUE`, `NOT NULL`, `CHECK` (MySQL 8.0.16+)）来声明数据完整性，将错误阻止在数据写入之前。
*   **扩展预留化**：在表结构设计中，为未来可能的扩展（如国际化、审计日志）预留少量备用字段或考虑使用 `JSON` 类型存储非结构化扩展属性。
*   **安全性内置**：密码字段使用 `VARCHAR(255)` 存储加盐哈希值，支持现代哈希算法。

---

### **4.2 数据库与全局配置**

#### **4.2.1 数据库创建**
```sql
-- 创建数据库，指定字符集和排序规则
CREATE DATABASE IF NOT EXISTS `online_bookstore`
CHARACTER SET utf8mb4
COLLATE utf8mb4_0900_ai_ci;
USE `online_bookstore`;
```
*   **数据库名**：`online_bookstore`，清晰表明业务范围。
*   **字符集**：`utf8mb4`。这是 MySQL 8.0 的默认字符集，完全支持 Unicode，包括 Emoji 和生僻汉字，是存储中文的最佳选择。
*   **排序规则**：`utf8mb4_0900_ai_ci`。这是基于 Unicode 9.0 标准的默认排序规则，对中文排序友好，且不区分大小写和重音（accent-insensitive），符合大多数检索场景。

#### **4.2.2 存储引擎选择**
*   **全部使用 InnoDB**。理由如下：
    *   **事务支持**：网上书店的核心操作（如下单、付款、发货、采购入库）必须是原子性的，需要事务保障。
    *   **行级锁**：支持高并发下的读写操作，避免表锁带来的性能瓶颈，特别是库存更新场景。
    *   **外键约束**：支持声明式的外键约束，由数据库自动维护参照完整性。
    *   **崩溃恢复**：支持 ACID 特性，提供可靠的崩溃恢复机制。
    *   **聚簇索引**：表数据按主键顺序存储，能极大提升主键查询和范围查询的效率。
    *   **全文索引**：InnoDB 支持全文索引，可用于书目标题和目录的全文检索。

---

### **4.3 命名规范与数据类型映射**

#### **4.3.1 命名规范**
为保持一致性，本设计采用以下命名约定：
*   **数据库/表/字段名**：使用 **蛇形命名法 (snake_case)**，全小写，单词间用下划线连接。例如：`sales_order`, `customer_id`。
*   **主键字段**：统一采用 `表名单数_id` 格式，如 `book_id`, `order_id`。自增主键也可简化为 `id`。
*   **外键字段**：通常与所引用的主键字段同名，如 `customer_id`。
*   **布尔类型字段**：以 `is_`, `has_`, `allow_` 等前缀开头，如 `is_default`, `allow_overdraft`。
*   **时间戳字段**：使用 `_at` 后缀，如 `created_at`, `updated_at`。
*   **状态字段**：以 `_status` 结尾，如 `order_status`, `item_status`。

#### **4.3.2 常用数据类型映射指南**
| 逻辑类型 / 业务场景         | MySQL 8 类型                     | 说明与参数示例                                               |
| :-------------------------- | :------------------------------- | :----------------------------------------------------------- |
| **唯一标识符 (代理主键)**   | `BIGINT UNSIGNED AUTO_INCREMENT` | 自增长整型，范围大，性能好。用于 `author_id`, `customer_id`, `order_item_id` 等。 |
| **业务编码 (自然主键)**     | `VARCHAR(32)` 或 `CHAR(n)`       | 如 `book_id` (ISBN或内部编码), `order_id` (如'SO202311210001'), `purchase_order_id`。VARCHAR(32) 足够容纳业务编码。 |
| **短文本 (名称、标题)**     | `VARCHAR(255)`                   | 书名、出版社名、作者名等。`VARCHAR(255)` 是平衡性能与灵活性的常用选择。 |
| **中等文本 (地址、描述)**   | `VARCHAR(500)`                   | 地址、图片URL等可能需要稍长但有限制的字段。                  |
| **长文本 (目录、备注)**     | `TEXT`                           | 支持约 65KB 文本。对于图书目录、客户备注等。                 |
| **精确数值 (金额、折扣)**   | `DECIMAL(M, D)`                  | 定点数，精确存储。<br>`DECIMAL(10,2)` 表示共10位，小数占2位，适合金额（最大约9千万）。<br>`DECIMAL(5,4)` 适合折扣率（0.0000~0.9999）。 |
| **大额数值 (累计消费)**     | `DECIMAL(12,2)`                  | 支持更大范围的金额统计。                                     |
| **整数数量 (库存、订单数)** | `INT UNSIGNED`                   | 无符号整数，范围 0 ~ 约42亿，足够业务使用。                  |
| **小范围整数 (状态、类型)** | `TINYINT UNSIGNED`               | 范围0-255，存储效率高。用于各种状态码（订单状态、信用等级、发货状态等）。通过注释或字典表说明含义。 |
| **布尔值**                  | `TINYINT(1)`                     | MySQL 没有原生 BOOLEAN 类型，用 `TINYINT(1)` 存储 0/1。      |
| **日期**                    | `DATE`                           | 仅存储年月日。用于出版日期、期望到货日期等。                 |
| **日期时间**                | `DATETIME`                       | 存储年月日时分秒，范围广（1000-9999年）。不受时区影响。用于订单时间、发货时间等。 |
| **时间戳 (自动更新)**       | `TIMESTAMP`                      | 存储自 '1970-01-01' 的秒数，范围较小（1970-2038），受时区影响。可用于 `created_at`, `updated_at` 自动记录时间。 |
| **ISBN**                    | `VARCHAR(13)`                    | 标准 ISBN 长度。                                             |
| **哈希密码**                | `VARCHAR(255)`                   | 存储 bcrypt 等现代哈希算法的结果，预留足够长度。             |

---

### **4.4 核心表物理结构详述**

以下将详细定义每张表在 MySQL 8 中的物理结构，包括**字段名、数据类型、约束、默认值**以及**索引建议**。建表 DDL 语句将在第5部分集中给出。

#### **4.4.1 书目表 (`book`)**
| 字段名            | 数据类型         | 空否     | 默认值                                        | 说明                     | 索引                          |
| :---------------- | :--------------- | :------- | :-------------------------------------------- | :----------------------- | :---------------------------- |
| `book_id`         | VARCHAR(32)      | NOT NULL |                                               | **书号**，业务主键。     | **PK**                        |
| `isbn`            | VARCHAR(13)      | NULL     |                                               | 国际标准书号，唯一。     | UNIQUE                        |
| `title`           | VARCHAR(255)     | NOT NULL |                                               | 书名。                   | **IDX (title)**               |
| `publisher`       | VARCHAR(100)     | NOT NULL |                                               | 出版社。                 | **IDX (publisher)**           |
| `publish_date`    | DATE             | NULL     |                                               | 出版日期。               |                               |
| `edition`         | VARCHAR(20)      | NULL     |                                               | 版次。                   |                               |
| `price`           | DECIMAL(10, 2)   | NOT NULL | 0.00                                          | 定价。                   |                               |
| `cover_image_url` | VARCHAR(500)     | NULL     |                                               | 封面图片URL。            |                               |
| `catalog`         | TEXT             | NULL     |                                               | 内容目录。               | **FULLTEXT (title, catalog)** |
| `series_flag`     | TINYINT(1)       | NOT NULL | 0                                             | 是否为丛书：0-否，1-是。 |                               |
| `parent_book_id`  | VARCHAR(32)      | NULL     |                                               | 所属丛书父书号。         | **FK → book(book_id)**        |
| `status`          | TINYINT UNSIGNED | NOT NULL | 1                                             | 状态：1-在售，0-下架。   | **IDX (status)**              |
| `created_at`      | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP                             | 创建时间。               |                               |
| `updated_at`      | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 最后更新时间。           |                               |

**设计说明**：
*   对 `title` 和 `catalog` 创建 **FULLTEXT** 全文索引，以支持复杂的书名和内容关键字模糊搜索，这是网上书店的核心查询功能。
*   使用 `TIMESTAMP` 类型并设置自动更新，便于追踪记录变化。
*   `parent_book_id` 自引用外键实现简单的丛书父子关系。

#### **4.4.2 作者表 (`author`)**
| 字段名        | 数据类型        | 空否     | 默认值            | 说明                   | 索引                   |
| :------------ | :-------------- | :------- | :---------------- | :--------------------- | :--------------------- |
| `id`          | BIGINT UNSIGNED | NOT NULL |                   | **作者ID**，自增主键。 | **PK, AUTO_INCREMENT** |
| `author_name` | VARCHAR(100)    | NOT NULL |                   | 作者姓名。             | **IDX (author_name)**  |
| `nationality` | VARCHAR(50)     | NULL     |                   | 国籍。                 |                        |
| `biography`   | TEXT            | NULL     |                   | 作者简介。             |                        |
| `created_at`  | TIMESTAMP       | NOT NULL | CURRENT_TIMESTAMP | 创建时间。             |                        |

#### **4.4.3 书目-作者关联表 (`book_author`)**
| 字段名         | 数据类型         | 空否     | 默认值            | 说明             | 索引/约束                                     |
| :------------- | :--------------- | :------- | :---------------- | :--------------- | :-------------------------------------------- |
| `book_id`      | VARCHAR(32)      | NOT NULL |                   | 书号。           | **FK → book(book_id), PK1**                   |
| `author_id`    | BIGINT UNSIGNED  | NOT NULL |                   | 作者ID。         | **FK → author(id), PK2**                      |
| `author_order` | TINYINT UNSIGNED | NOT NULL |                   | 作者顺序 (1-4)。 | **PK3, CHECK (author_order BETWEEN 1 AND 4)** |
| `created_at`   | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间。       |                                               |
*   **主键**：`(book_id, author_order)`。复合主键能唯一标识一条关联记录，并隐含了对`(book_id, author_order)`的唯一性约束，保证了顺序不重复。
*   **唯一约束**：`UNIQUE(book_id, author_id)`。防止同一作者被重复关联到同一本书。
*   **检查约束**：`CHECK (author_order BETWEEN 1 AND 4)`。MySQL 8.0.16+ 支持，用于限定顺序范围。
*   **数量约束**：`每本书作者数<=4`。此约束无法通过DDL直接实现，需通过**触发器** `trg_book_author_limit` 在插入/更新时进行校验和限制。

#### **4.4.4 关键字表 (`keyword`)**
| 字段名         | 数据类型        | 空否     | 默认值            | 说明                     | 索引                   |
| :------------- | :-------------- | :------- | :---------------- | :----------------------- | :--------------------- |
| `id`           | BIGINT UNSIGNED | NOT NULL |                   | **关键字ID**，自增主键。 | **PK, AUTO_INCREMENT** |
| `keyword_text` | VARCHAR(50)     | NOT NULL |                   | 关键字内容。             | **UNIQUE**             |
| `created_at`   | TIMESTAMP       | NOT NULL | CURRENT_TIMESTAMP | 创建时间。               |                        |

#### **4.4.5 书目-关键字关联表 (`book_keyword`)**
| 字段名       | 数据类型        | 空否     | 默认值            | 说明       | 索引/约束                   |
| :----------- | :-------------- | :------- | :---------------- | :--------- | :-------------------------- |
| `book_id`    | VARCHAR(32)     | NOT NULL |                   | 书号。     | **FK → book(book_id), PK1** |
| `keyword_id` | BIGINT UNSIGNED | NOT NULL |                   | 关键字ID。 | **FK → keyword(id), PK2**   |
| `created_at` | TIMESTAMP       | NOT NULL | CURRENT_TIMESTAMP | 创建时间。 |                             |
*   **数量约束**：`每本书关键字数<=10`。需通过**触发器** `trg_book_keyword_limit` 实现。

#### **4.4.6 库存表 (`inventory`)**
| 字段名          | 数据类型     | 空否     | 默认值                                        | 说明                       | 索引                       |
| :-------------- | :----------- | :------- | :-------------------------------------------- | :------------------------- | :------------------------- |
| `book_id`       | VARCHAR(32)  | NOT NULL |                                               | **书号**，与书目一一对应。 | **PK, FK → book(book_id)** |
| `quantity`      | INT UNSIGNED | NOT NULL | 0                                             | 当前可用库存。             |                            |
| `safety_stock`  | INT UNSIGNED | NOT NULL | 5                                             | 安全库存阈值。             |                            |
| `location_code` | VARCHAR(20)  | NULL     |                                               | 库位编码。                 |                            |
| `updated_at`    | TIMESTAMP    | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 最后更新时间。             |                            |
*   **检查约束**：`CHECK (quantity >= 0)`。保证库存不为负。

#### **4.4.7 供应商表 (`supplier`)**
| 字段名           | 数据类型         | 空否     | 默认值            | 说明                             | 索引                    |
| :--------------- | :--------------- | :------- | :---------------- | :------------------------------- | :---------------------- |
| `id`             | BIGINT UNSIGNED  | NOT NULL |                   | **供应商ID**，自增主键。         | **PK, AUTO_INCREMENT**  |
| `supplier_name`  | VARCHAR(200)     | NOT NULL |                   | 供应商名称。                     | **IDX (supplier_name)** |
| `contact_person` | VARCHAR(100)     | NULL     |                   | 联系人。                         |                         |
| `phone`          | VARCHAR(30)      | NULL     |                   | 联系电话。                       |                         |
| `email`          | VARCHAR(100)     | NULL     |                   | 电子邮箱。                       |                         |
| `address`        | VARCHAR(500)     | NULL     |                   | 地址。                           |                         |
| `payment_terms`  | VARCHAR(100)     | NULL     |                   | 结算方式。                       |                         |
| `status`         | TINYINT UNSIGNED | NOT NULL | 1                 | 状态：1-合作中，0-暂停，2-终止。 | **IDX (status)**        |
| `created_at`     | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间。                       |                         |

#### **4.4.8 供货关系表 (`supply`)**
| 字段名           | 数据类型        | 空否     | 默认值            | 说明               | 索引/约束                   |
| :--------------- | :-------------- | :------- | :---------------- | :----------------- | :-------------------------- |
| `supplier_id`    | BIGINT UNSIGNED | NOT NULL |                   | 供应商ID。         | **FK → supplier(id), PK1**  |
| `book_id`        | VARCHAR(32)     | NOT NULL |                   | 书号。             | **FK → book(book_id), PK2** |
| `supply_price`   | DECIMAL(10, 2)  | NULL     |                   | 供货单价。         |                             |
| `lead_time_days` | INT UNSIGNED    | NULL     |                   | 供货周期(天)。     |                             |
| `is_primary`     | TINYINT(1)      | NOT NULL | 0                 | 是否为主要供货商。 |                             |
| `created_at`     | TIMESTAMP       | NOT NULL | CURRENT_TIMESTAMP | 创建时间。         |                             |

#### **4.4.9 信用等级表 (`credit_level`)**
| 字段名                   | 数据类型         | 空否     | 默认值            | 说明                       | 索引/约束                                                 |
| :----------------------- | :--------------- | :------- | :---------------- | :------------------------- | :-------------------------------------------------------- |
| `id`                     | TINYINT UNSIGNED | NOT NULL |                   | **等级ID** (1-5)。         | **PK**                                                    |
| `level_name`             | VARCHAR(20)      | NOT NULL |                   | 等级名称。                 | **UNIQUE**                                                |
| `discount_rate`          | DECIMAL(5, 4)    | NOT NULL | 1.0000            | 折扣率 (0-1)。             | `CHECK (discount_rate > 0 AND discount_rate <= 1)`        |
| `allow_overdraft`        | TINYINT(1)       | NOT NULL | 0                 | 是否允许透支。             |                                                           |
| `overdraft_limit`        | DECIMAL(10, 2)   | NULL     |                   | 透支额度，NULL表示无限制。 | `CHECK (overdraft_limit IS NULL OR overdraft_limit >= 0)` |
| `upgrade_condition_desc` | VARCHAR(255)     | NULL     |                   | 升级条件描述。             |                                                           |
| `upgrade_threshold`      | DECIMAL(12, 2)   | NULL     |                   | 升级阈值（金额）。         |                                                           |
| `created_at`             | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间。                 |                                                           |

**预置数据示例**：
```sql
INSERT INTO `credit_level` (`id`, `level_name`, `discount_rate`, `allow_overdraft`, `overdraft_limit`) VALUES
(1, '一级会员', 0.90, 0, 0.00),
(2, '二级会员', 0.85, 0, 0.00),
(3, '三级会员', 0.85, 1, 500.00),
(4, '四级会员', 0.80, 1, 1000.00),
(5, '五级会员', 0.75, 1, NULL);
```

#### **4.4.10 客户表 (`customer`)**
| 字段名              | 数据类型         | 空否     | 默认值                                        | 说明                   | 索引                                      |
| :------------------ | :--------------- | :------- | :-------------------------------------------- | :--------------------- | :---------------------------------------- |
| `id`                | BIGINT UNSIGNED  | NOT NULL |                                               | **客户ID**，自增主键。 | **PK, AUTO_INCREMENT**                    |
| `username`          | VARCHAR(50)      | NOT NULL |                                               | 登录用户名。           | **UNIQUE**                                |
| `password_hash`     | VARCHAR(255)     | NOT NULL |                                               | 密码哈希值。           |                                           |
| `real_name`         | VARCHAR(100)     | NOT NULL |                                               | 真实姓名。             |                                           |
| `mobile_phone`      | VARCHAR(20)      | NULL     |                                               | 手机号。               | **UNIQUE**                                |
| `email`             | VARCHAR(100)     | NULL     |                                               | 电子邮箱。             | **UNIQUE**                                |
| `account_balance`   | DECIMAL(10, 2)   | NOT NULL | 0.00                                          | 账户余额。             |                                           |
| `total_consumption` | DECIMAL(12, 2)   | NOT NULL | 0.00                                          | 累计消费额。           |                                           |
| `level_id`          | TINYINT UNSIGNED | NOT NULL | 1                                             | 信用等级ID。           | **FK → credit_level(id), IDX (level_id)** |
| `registration_time` | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP                             | 注册时间。             |                                           |
| `status`            | TINYINT UNSIGNED | NOT NULL | 1                                             | 状态：1-正常，0-冻结。 | **IDX (status)**                          |
| `updated_at`        | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 最后更新时间。         |                                           |

#### **4.4.11 客户地址表 (`customer_address`)**
| 字段名            | 数据类型        | 空否     | 默认值            | 说明                    | 索引                                     |
| :---------------- | :-------------- | :------- | :---------------- | :---------------------- | :--------------------------------------- |
| `id`              | BIGINT UNSIGNED | NOT NULL |                   | **地址ID**，自增主键。  | **PK, AUTO_INCREMENT**                   |
| `customer_id`     | BIGINT UNSIGNED | NOT NULL |                   | 客户ID。                | **FK → customer(id), IDX (customer_id)** |
| `recipient_name`  | VARCHAR(100)    | NOT NULL |                   | 收件人姓名。            |                                          |
| `recipient_phone` | VARCHAR(20)     | NOT NULL |                   | 收件人电话。            |                                          |
| `province`        | VARCHAR(50)     | NOT NULL |                   | 省份。                  |                                          |
| `city`            | VARCHAR(50)     | NOT NULL |                   | 城市。                  |                                          |
| `district`        | VARCHAR(50)     | NOT NULL |                   | 区县。                  |                                          |
| `detail_address`  | VARCHAR(500)    | NOT NULL |                   | 详细地址。              |                                          |
| `is_default`      | TINYINT(1)      | NOT NULL | 0                 | 是否为默认地址。        | **IDX (customer_id, is_default)**        |
| `tag`             | VARCHAR(20)     | NULL     |                   | 地址标签（家/公司等）。 |                                          |
| `created_at`      | TIMESTAMP       | NOT NULL | CURRENT_TIMESTAMP | 创建时间。              |                                          |

#### **4.4.12 订单表 (`sales_order`)**
| 字段名                | 数据类型         | 空否     | 默认值                                        | 说明                                                         | 索引                                     |
| :-------------------- | :--------------- | :------- | :-------------------------------------------- | :----------------------------------------------------------- | :--------------------------------------- |
| `order_id`            | VARCHAR(32)      | NOT NULL |                                               | **订单号**，业务主键（如'SO202311210001'）。                 | **PK**                                   |
| `customer_id`         | BIGINT UNSIGNED  | NOT NULL |                                               | 客户ID。                                                     | **FK → customer(id), IDX (customer_id)** |
| `order_time`          | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP                             | 下单时间。                                                   | **IDX (order_time)**                     |
| `order_status`        | TINYINT UNSIGNED | NOT NULL | 10                                            | 状态：10-待付款，20-待发货，30-部分发货，40-已发货，50-已完成，0-已取消。 | **IDX (order_status)**                   |
| `goods_amount`        | DECIMAL(10, 2)   | NOT NULL | 0.00                                          | 商品总金额（折扣前）。                                       |                                          |
| `discount_rate`       | DECIMAL(5, 4)    | NOT NULL | 1.0000                                        | 下单时折扣率快照。                                           |                                          |
| `payable_amount`      | DECIMAL(10, 2)   | NOT NULL | 0.00                                          | 实付金额（折扣后）。                                         |                                          |
| `shipping_address_id` | BIGINT UNSIGNED  | NOT NULL |                                               | 收货地址ID。                                                 | **FK → customer_address(id)**            |
| `payment_time`        | TIMESTAMP        | NULL     |                                               | 支付时间。                                                   |                                          |
| `customer_note`       | TEXT             | NULL     |                                               | 客户备注。                                                   |                                          |
| `updated_at`          | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 最后更新时间。                                               |                                          |

**复合索引建议**：
- `IDX (customer_id, order_status, order_time)`：高效支持客户查询自己不同状态的订单并按时间排序。
- `IDX (order_status, order_time)`：管理员后台按状态和时间筛选订单。

#### **4.4.13 订单明细表 (`sales_order_item`)**
| 字段名        | 数据类型         | 空否     | 默认值            | 说明                                                  | 索引                                           |
| :------------ | :--------------- | :------- | :---------------- | :---------------------------------------------------- | :--------------------------------------------- |
| `id`          | BIGINT UNSIGNED  | NOT NULL |                   | **明细项ID**，自增主键。                              | **PK, AUTO_INCREMENT**                         |
| `order_id`    | VARCHAR(32)      | NOT NULL |                   | 订单号。                                              | **FK → sales_order(order_id), IDX (order_id)** |
| `book_id`     | VARCHAR(32)      | NOT NULL |                   | 书号。                                                | **FK → book(book_id), IDX (book_id)**          |
| `quantity`    | INT UNSIGNED     | NOT NULL |                   | 订购数量。                                            |                                                |
| `unit_price`  | DECIMAL(10, 2)   | NOT NULL |                   | 成交单价（快照）。                                    |                                                |
| `subtotal`    | DECIMAL(10, 2)   | NOT NULL |                   | 小计金额。                                            |                                                |
| `item_status` | TINYINT UNSIGNED | NOT NULL | 10                | 明细状态：10-已下单，20-已发货，30-已完成，0-已取消。 |                                                |
| `created_at`  | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间。                                            |                                                |

**唯一约束**：`UNIQUE(order_id, book_id)`。防止同一订单中重复添加同一种图书（除非业务允许分条记录不同批次或优惠）。

#### **4.4.14 发货单表 (`shipment`) (可选扩展)**
| 字段名            | 数据类型         | 空否     | 默认值            | 说明                                    | 索引                                           |
| :---------------- | :--------------- | :------- | :---------------- | :-------------------------------------- | :--------------------------------------------- |
| `shipment_id`     | VARCHAR(32)      | NOT NULL |                   | **发货单号**（如'SH202311210001'）。    | **PK**                                         |
| `order_id`        | VARCHAR(32)      | NOT NULL |                   | 关联订单号。                            | **FK → sales_order(order_id), IDX (order_id)** |
| `ship_time`       | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 发货时间。                              | **IDX (ship_time)**                            |
| `carrier`         | VARCHAR(50)      | NULL     |                   | 物流公司。                              |                                                |
| `tracking_number` | VARCHAR(50)      | NULL     |                   | 运单号。                                | **UNIQUE**                                     |
| `shipment_status` | TINYINT UNSIGNED | NOT NULL | 10                | 状态：10-已出库，20-运输中，30-已签收。 | **IDX (shipment_status)**                      |
| `operator`        | VARCHAR(50)      | NULL     |                   | 操作员。                                |                                                |
| `created_at`      | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间。                              |                                                |

#### **4.4.15 发货明细表 (`shipment_item`) (可选扩展)**
| 字段名          | 数据类型        | 空否     | 默认值 | 说明           | 索引/约束                           |
| :-------------- | :-------------- | :------- | :----- | :------------- | :---------------------------------- |
| `shipment_id`   | VARCHAR(32)     | NOT NULL |        | 发货单号。     | **FK → shipment(shipment_id), PK1** |
| `order_item_id` | BIGINT UNSIGNED | NOT NULL |        | 订单明细项ID。 | **FK → sales_order_item(id), PK2**  |
| `ship_quantity` | INT UNSIGNED    | NOT NULL |        | 本次发货数量。 | `CHECK (ship_quantity > 0)`         |

#### **4.4.16 缺书记录表 (`out_of_stock_record`)**
| 字段名                | 数据类型         | 空否     | 默认值            | 说明                                                         | 索引                                  |
| :-------------------- | :--------------- | :------- | :---------------- | :----------------------------------------------------------- | :------------------------------------ |
| `id`                  | BIGINT UNSIGNED  | NOT NULL |                   | **缺书记录ID**，自增主键。                                   | **PK, AUTO_INCREMENT**                |
| `book_id`             | VARCHAR(32)      | NOT NULL |                   | 书号。                                                       | **FK → book(book_id), IDX (book_id)** |
| `required_quantity`   | INT UNSIGNED     | NOT NULL |                   | 需求数量。                                                   |                                       |
| `record_date`         | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 登记日期。                                                   | **IDX (record_date)**                 |
| `source`              | TINYINT UNSIGNED | NOT NULL | 1                 | 来源：1-手动登记，2-库存预警，3-客户订单触发，4-客户缺书登记。 |                                       |
| `related_customer_id` | BIGINT UNSIGNED  | NULL     |                   | 关联客户ID。                                                 | **FK → customer(id)**                 |
| `status`              | TINYINT UNSIGNED | NOT NULL | 10                | 状态：10-待处理，20-已生成采购，30-已到货。                  | **IDX (status)**                      |
| `priority`            | TINYINT UNSIGNED | NULL     |                   | 优先级 (1-高，2-中，3-低)。                                  |                                       |
| `created_at`          | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间。                                                   |                                       |
| `quoted_price`        | DECIMAL(10, 2)   | NULL     | CURRENT_TIMESTAMP | 报价（元），管理员针对询价给出的价格。                       |                                       |
| `inquiry_notes`       | TEXT             | NULL     | CURRENT_TIMESTAMP | 询价备注，记录客户的具体需求说明。                           |                                       |

**复合索引建议**：`IDX (status, source)`：便于按状态和来源筛选缺书记录。

#### **4.4.17 采购单表 (`purchase_order`)**
| 字段名                   | 数据类型         | 空否     | 默认值            | 说明                                                         | 索引                                     |
| :----------------------- | :--------------- | :------- | :---------------- | :----------------------------------------------------------- | :--------------------------------------- |
| `purchase_order_id`      | VARCHAR(32)      | NOT NULL |                   | **采购单号**（如'PO202311210001'）。                         | **PK**                                   |
| `supplier_id`            | BIGINT UNSIGNED  | NOT NULL |                   | 供应商ID。                                                   | **FK → supplier(id), IDX (supplier_id)** |
| `create_date`            | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建日期。                                                   | **IDX (create_date)**                    |
| `expected_date`          | DATE             | NULL     |                   | 期望到货日期。                                               |                                          |
| `buyer`                  | VARCHAR(50)      | NULL     |                   | 采购员。                                                     |                                          |
| `total_estimated_amount` | DECIMAL(10, 2)   | NULL     |                   | 总预估金额。                                                 |                                          |
| `status`                 | TINYINT UNSIGNED | NOT NULL | 10                | 状态：10-草稿，20-已发出，30-部分到货，40-已完成，0-已取消。 | **IDX (status)**                         |
| `created_at`             | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间。                                                   |                                          |

#### **4.4.18 采购明细表 (`purchase_order_item`)**
| 字段名                    | 数据类型        | 空否     | 默认值            | 说明               | 索引/约束                                       |
| :------------------------ | :-------------- | :------- | :---------------- | :----------------- | :---------------------------------------------- |
| `purchase_order_id`       | VARCHAR(32)     | NOT NULL |                   | 采购单号。         | **FK → purchase_order(purchase_order_id), PK1** |
| `book_id`                 | VARCHAR(32)     | NOT NULL |                   | 书号。             | **FK → book(book_id), PK2**                     |
| `purchase_quantity`       | INT UNSIGNED    | NOT NULL |                   | 采购数量。         |                                                 |
| `purchase_price`          | DECIMAL(10, 2)  | NULL     |                   | 采购单价。         |                                                 |
| `related_out_of_stock_id` | BIGINT UNSIGNED | NULL     |                   | 关联的缺书记录ID。 | **FK → out_of_stock_record(id)**                |
| `created_at`              | TIMESTAMP       | NOT NULL | CURRENT_TIMESTAMP | 创建时间。         |                                                 |

---

### **4.5 索引设计策略总结**

索引是提高查询性能的关键，但会增加写操作开销和存储空间。本设计遵循以下策略：

1.  **主键索引**：每张表必有，通常是聚簇索引，选择短且有序的字段。对于频繁范围查询的字段（如`order_time`）作为主键的一部分可提升性能。
2.  **外键索引**：在所有外键字段上创建索引，以避免表锁和提升联表查询性能。特别是`customer_id`、`order_id`、`book_id`等高频连接字段。
3.  **高频查询字段索引**：对 `WHERE`, `ORDER BY`, `GROUP BY`, `JOIN ON` 子句中频繁出现的字段建立索引。
    *   例如：`book(title, publisher)`用于书目检索；`sales_order(customer_id, order_status, order_time)`用于客户订单查询；`out_of_stock_record(status, source)`用于缺书处理。
4.  **复合索引**：针对特定的、固定的查询模式设计。
    *   **左前缀匹配原则**：将查询中最常用作等值匹配的列放在最左边。
    *   例如：`IDX (customer_id, order_status, order_time DESC)` 能高效支持"查某客户所有待发货订单并按时间倒序"的查询。
    *   `IDX (book_id, status)` 用于查询某本书的库存状态和缺书状态。
5.  **唯一索引**：对业务上要求唯一的字段（如 `username`, `email`, `isbn`, `order_id`）建立，同时保证唯一性约束。
6.  **全文索引**：对需要文本内容搜索的字段（如 `book(title, catalog)`）建立，这是实现高级搜索功能的基础，支持中文分词检索。
7.  **避免过度索引**：不为很少被查询的字段、区分度极低的字段单独建索引，除非它常作为查询的驱动列。例如`status`字段虽区分度低，但作为高频筛选条件仍需要索引。
8.  **覆盖索引**：对某些高频查询，考虑建立覆盖索引，使查询只需访问索引而无需回表。例如客户订单列表查询的复合索引。

---

### **4.6 完整性约束与事务策略**

#### **4.6.1 外键引用操作策略**
为防止误删重要数据导致历史业务断裂，外键约束的删除和更新策略建议如下：

*   **`ON DELETE`**:
    *   对于核心业务主表（`customer`, `book`, `supplier`），使用 **`RESTRICT`** 或 **`NO ACTION`**。当有业务记录引用时，禁止删除。通常我们采用"逻辑删除"（更新状态字段）而非物理删除。
    *   对于具有强依赖关系的组合实体（如 `sales_order_item` 依赖于 `sales_order`），可考虑 **`CASCADE`**。但同样建议逻辑删除，以保留完整的历史审计线索。
    *   对于关联表（如 `book_author`, `book_keyword`），可使用 **`CASCADE`**，当主表记录删除时自动清理关联。
*   **`ON UPDATE`**:
    *   通常设置为 **`CASCADE`**。如果主表的主键被更新（虽然不常见），所有外键引用自动同步更新，保持数据一致性。

#### **4.6.2 事务与并发控制**
关键业务操作必须放在数据库事务中执行，以保证 ACID 特性：
*   **下单事务**：插入订单主表、明细表，计算总金额，快照折扣率。采用乐观锁或者"支付后扣库存"策略避免超卖。
*   **支付成功事务**：更新订单状态为"待发货"，扣减客户账户余额，增加累计消费额。需校验信用透支规则。
*   **发货事务**：检查支付与信用，扣减库存，创建发货记录，更新订单及明细状态。使用 `SELECT ... FOR UPDATE` 锁定库存行和客户账户行。
*   **采购到货事务**：增加库存，更新采购单和缺书记录状态。需要锁定库存行。
*   **缺书自动生成事务**：库存检查与缺书记录插入需要原子操作，避免重复记录。

**隔离级别**：MySQL InnoDB 默认的 **`REPEATABLE READ`** 级别对于本系统大多数场景是足够的。在极高并发支付/发货场景下，可能需要考虑使用 **`READ COMMITTED`** 来减少锁竞争，但可能出现"不可重复读"问题。可以考虑在存储过程中显式设置所需的事务隔离级别。

#### **4.6.3 检查约束的使用**
MySQL 8.0.16+ 支持标准的 `CHECK` 约束，可用于：
*   数值范围：`quantity >= 0`, `price > 0`
*   枚举值范围：`author_order BETWEEN 1 AND 4`
*   条件逻辑：`overdraft_limit IS NULL OR overdraft_limit >= 0`
*   状态一致性：发货数量不大于订购数量（需结合触发器实现）

---

### **4.7 物理设计中的约束实现路径**

1.  **DDL 可声明的约束**：
    *   `PRIMARY KEY`, `FOREIGN KEY`, `UNIQUE`, `NOT NULL`, `DEFAULT`。
    *   `CHECK` 约束 (MySQL 8.0.16+)，用于字段值范围校验（如 `quantity >= 0`, `author_order BETWEEN 1 AND 4`）。
2.  **需程序逻辑/触发器实现的约束**：
    *   **跨行计数约束**：每本书作者数≤4（`trg_book_author_limit`），关键字数≤10（`trg_book_keyword_limit`）。
    *   **跨行状态唯一约束**：缺书记录"待处理"状态不重复（`trg_unique_out_of_stock`）。
    *   **跨表计算约束**：订单总金额、实付金额与明细项汇总的一致性维护（`trg_sync_order_amount`系列）。
    *   **复杂业务规则校验**：发货前客户支付能力校验（余额+透支额度），需在存储过程中实现。
    *   **库存安全阈值触发**：当库存低于安全库存时自动生成缺书记录，可通过触发器或定时任务实现。
    *   **分次发货控制**：累计发货量不超过订购量，需在发货存储过程中校验。
    *   **信用自动调整**：每月初根据规则调整信用等级，可通过事件调度器（Event Scheduler）调用存储过程实现。

3.  **业务规则优先级**：
    *   **第一优先级**：通过DDL约束保证的基础完整性（非空、唯一、外键、检查约束）。
    *   **第二优先级**：通过触发器保证的复杂行级、跨行约束（数量限制、状态唯一性）。
    *   **第三优先级**：通过存储过程保证的事务性业务规则（支付校验、发货流程、采购入库）。

---

### **4.8 本部分小结**

本部分完成了网上书店数据库在 MySQL 8 环境下的详细物理设计，明确了：
*   数据库全局配置（字符集、引擎）。
*   每一张表的精确字段定义、数据类型、约束和索引方案，特别针对网上书店的业务特点（如书目检索、订单跟踪、库存管理）进行了优化。
*   核心的索引设计策略与事务处理原则，确保系统在高并发下的性能与一致性。
*   复杂业务约束的实现路径划分（DDL vs. 程序逻辑），为下一部分的实现设计提供了清晰指导。

**下一部分（数据库实现设计）将基于此物理设计**，提供完整的DDL建表语句、视图定义、触发器实现和存储过程封装，将设计真正落地为可运行的数据库系统。

## **第 5 部分：数据库实现设计（DDL、视图、触发器与存储过程）**

### **5.1 实现设计说明**

数据库实现设计是将前面章节完成的逻辑与物理设计转化为在 **MySQL 8.0** 中可实际创建、运行和测试的数据库对象的过程。本部分旨在提供一个**可直接用于实验环境部署的、包含核心业务逻辑的数据库实现方案**。

**核心实现目标：**
1.  **结构落地**：通过 Data Definition Language (DDL) 语句，创建所有定义好的表、索引和约束。
2.  **业务规则固化**：对于无法通过标准 DDL 约束（如 `PRIMARY KEY`, `FOREIGN KEY`, `CHECK`）实现的复杂业务规则（例如数量上限、跨表一致性），通过编写**触发器 (Triggers)** 在数据库层面进行强制约束。
3.  **核心流程封装**：将高频、复杂且需要事务保障的核心业务操作（如下单、发货、采购入库）封装为**存储过程 (Stored Procedures)**。这不仅能保证业务逻辑的一致性和事务性，还能提高执行效率，并为应用层提供清晰、安全的调用接口。
4.  **查询简化与数据安全**：通过创建**视图 (Views)**，将复杂的多表连接查询封装为简单的虚拟表，简化前端应用程序的查询逻辑，同时可以隐藏底层表的敏感字段或复杂结构。
5.  **数据完整性兜底**：在应用层之外，建立数据库层面的第二道完整性防线，确保即使在应用逻辑出现漏洞时，关键的业务规则（如库存不为负）依然有效。
6.  **支持网上书店特色功能**：特别实现书目多条件检索、客户订单跟踪、库存预警、信用等级自动调整等网上书店核心业务逻辑。

---

### **5.2 数据库与基本表实现（DDL）**

#### **5.2.1 创建数据库**
```sql
-- 创建数据库，明确指定字符集和排序规则，确保中文兼容性和一致的排序行为
DROP DATABASE IF EXISTS `online_bookstore`;
CREATE DATABASE `online_bookstore`
CHARACTER SET utf8mb4
COLLATE utf8mb4_0900_ai_ci;

USE `online_bookstore`;
```

#### **5.2.2 核心表创建 DDL**
以下展示部分核心表的创建语句，体现了字段类型、约束、索引和外键的完整定义。

#### **1. 书目表 (`book`)**
```sql
CREATE TABLE `book` (
    `book_id` VARCHAR(32) NOT NULL COMMENT '书号（业务主键，如ISBN或内部编码）',
    `isbn` VARCHAR(13) UNIQUE COMMENT '国际标准书号',
    `title` VARCHAR(255) NOT NULL COMMENT '书名',
    `publisher` VARCHAR(100) NOT NULL COMMENT '出版社',
    `publish_date` DATE COMMENT '出版日期',
    `edition` VARCHAR(20) COMMENT '版次',
    `price` DECIMAL(10, 2) NOT NULL DEFAULT 0.00 COMMENT '定价（元）',
    `cover_image_url` VARCHAR(500) COMMENT '封面图片URL',
    `catalog` TEXT COMMENT '内容目录/简介',
    `series_flag` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否为丛书：0-否，1-是',
    `parent_book_id` VARCHAR(32) COMMENT '所属丛书父书号',
    `status` TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '状态：1-在售，0-下架',
    `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (`book_id`),
    INDEX `idx_book_title` (`title`),
    INDEX `idx_book_publisher` (`publisher`),
    INDEX `idx_book_status` (`status`),
    FULLTEXT INDEX `ft_book_title_catalog` (`title`, `catalog`) COMMENT '全文索引，支持书名和目录搜索',
    CONSTRAINT `fk_book_parent` FOREIGN KEY (`parent_book_id`) REFERENCES `book` (`book_id`) ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT `chk_book_price` CHECK (`price` >= 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='图书基本信息表';
-- 为支持书目检索的“匹配程度排序”，需在 book 表建立全文索引
ALTER TABLE `book` ADD FULLTEXT INDEX `ft_book_search` (`title`, `catalog`);
```

#### **2. 作者表 (`author`)**
```sql
CREATE TABLE `author` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '作者ID',
    `author_name` VARCHAR(100) NOT NULL COMMENT '作者姓名',
    `nationality` VARCHAR(50) COMMENT '国籍',
    `biography` TEXT COMMENT '作者简介',
    `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    INDEX `idx_author_name` (`author_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='作者信息表';
```

#### **3. 书目-作者关联表 (`book_author`)**
```sql
CREATE TABLE `book_author` (
    `book_id` VARCHAR(32) NOT NULL COMMENT '书号',
    `author_id` BIGINT UNSIGNED NOT NULL COMMENT '作者ID',
    `author_order` TINYINT UNSIGNED NOT NULL COMMENT '作者顺序 (1-4)',
    `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`book_id`, `author_order`),
    UNIQUE KEY `uk_book_author` (`book_id`, `author_id`),
    CONSTRAINT `fk_book_author_book` FOREIGN KEY (`book_id`) REFERENCES `book` (`book_id`) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT `fk_book_author_author` FOREIGN KEY (`author_id`) REFERENCES `author` (`id`) ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT `chk_author_order` CHECK (`author_order` BETWEEN 1 AND 4)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='图书与作者关联表（含顺序）';
```
> **说明**：
>
> * **主键** `(book_id, author_order)` 确保同一本书的作者顺序唯一。
> * **唯一约束** `uk_book_author` 防止同一作者被重复关联到同一本书。
> * **检查约束** `chk_author_order` 确保顺序值在有效范围内。
> * **数量限制**（最多4位作者）需通过触发器 `trg_book_author_limit` 实现。

#### **4. 库存表 (`inventory`)**
```sql
CREATE TABLE `inventory` (
    `book_id` VARCHAR(32) NOT NULL COMMENT '书号',
    `quantity` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '当前可用库存',
    `safety_stock` INT UNSIGNED NOT NULL DEFAULT 5 COMMENT '安全库存阈值',
    `location_code` VARCHAR(20) COMMENT '库位编码',
    `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (`book_id`),
    CONSTRAINT `fk_inventory_book` FOREIGN KEY (`book_id`) REFERENCES `book` (`book_id`) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT `chk_quantity_non_negative` CHECK (`quantity` >= 0),
    CONSTRAINT `chk_safety_stock` CHECK (`safety_stock` >= 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='图书库存表';
```

#### **5. 客户表 (`customer`)**
```sql
CREATE TABLE `customer` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '客户ID',
    `username` VARCHAR(50) NOT NULL COMMENT '登录用户名',
    `password_hash` VARCHAR(255) NOT NULL COMMENT '密码哈希值',
    `real_name` VARCHAR(100) NOT NULL COMMENT '真实姓名',
    `mobile_phone` VARCHAR(20) COMMENT '手机号',
    `email` VARCHAR(100) COMMENT '电子邮箱',
    `account_balance` DECIMAL(10, 2) NOT NULL DEFAULT 0.00 COMMENT '账户余额（元）',
    `total_consumption` DECIMAL(12, 2) NOT NULL DEFAULT 0.00 COMMENT '历史累计消费额（元）',
    `level_id` TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '信用等级ID',
    `registration_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    `status` TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '账户状态：1-正常，0-冻结',
    `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_customer_username` (`username`),
    UNIQUE KEY `uk_customer_mobile` (`mobile_phone`),
    UNIQUE KEY `uk_customer_email` (`email`),
    INDEX `idx_customer_level` (`level_id`),
    INDEX `idx_customer_status` (`status`),
    CONSTRAINT `fk_customer_level` FOREIGN KEY (`level_id`) REFERENCES `credit_level` (`id`) ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT `chk_account_balance` CHECK (`account_balance` >= -100000) -- 允许适度透支
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='客户信息表';
```

#### **6. 订单表 (`sales_order`) 与 订单明细表 (`sales_order_item`)**
```sql
-- 订单主表
CREATE TABLE `sales_order` (
    `order_id` VARCHAR(32) NOT NULL COMMENT '订单号',
    `customer_id` BIGINT UNSIGNED NOT NULL COMMENT '客户ID',
    `order_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '下单时间',
    `order_status` TINYINT UNSIGNED NOT NULL DEFAULT 10 COMMENT '状态：10-待付款，20-待发货，30-部分发货，40-已发货，50-已完成，0-已取消',
    `goods_amount` DECIMAL(10, 2) NOT NULL DEFAULT 0.00 COMMENT '商品总金额（折扣前）',
    `discount_rate` DECIMAL(5, 4) NOT NULL DEFAULT 1.0000 COMMENT '下单时折扣率快照',
    `payable_amount` DECIMAL(10, 2) NOT NULL DEFAULT 0.00 COMMENT '实付金额（折扣后）',
    `shipping_address_id` BIGINT UNSIGNED NOT NULL COMMENT '收货地址ID',
    `payment_time` TIMESTAMP NULL COMMENT '支付时间',
    `customer_note` TEXT COMMENT '客户备注',
    `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (`order_id`),
    INDEX `idx_so_customer_time` (`customer_id`, `order_time`),
    INDEX `idx_so_status` (`order_status`),
    INDEX `idx_so_customer_status_time` (`customer_id`, `order_status`, `order_time` DESC),
    CONSTRAINT `fk_so_customer` FOREIGN KEY (`customer_id`) REFERENCES `customer` (`id`) ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT `fk_so_address` FOREIGN KEY (`shipping_address_id`) REFERENCES `customer_address` (`id`) ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT `chk_order_amounts` CHECK (`goods_amount` >= 0 AND `payable_amount` >= 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='客户订单主表';

-- 订单明细表
CREATE TABLE `sales_order_item` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '明细项ID',
    `order_id` VARCHAR(32) NOT NULL COMMENT '订单号',
    `book_id` VARCHAR(32) NOT NULL COMMENT '书号',
    `quantity` INT UNSIGNED NOT NULL COMMENT '订购数量',
    `unit_price` DECIMAL(10, 2) NOT NULL COMMENT '成交单价（快照）',
    `subtotal` DECIMAL(10, 2) NOT NULL COMMENT '小计金额',
    `item_status` TINYINT UNSIGNED NOT NULL DEFAULT 10 COMMENT '明细状态：10-已下单，20-已发货，30-已完成，0-已取消',
    `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_order_book` (`order_id`, `book_id`),
    INDEX `idx_soi_order` (`order_id`),
    INDEX `idx_soi_book` (`book_id`),
    CONSTRAINT `fk_soi_order` FOREIGN KEY (`order_id`) REFERENCES `sales_order` (`order_id`) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT `fk_soi_book` FOREIGN KEY (`book_id`) REFERENCES `book` (`book_id`) ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT `chk_quantity_positive` CHECK (`quantity` > 0),
    CONSTRAINT `chk_unit_price` CHECK (`unit_price` >= 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='订单明细表';
```

#### **7. 信用等级表 (`credit_level`)**
```sql
CREATE TABLE `credit_level` (
    `id` TINYINT UNSIGNED NOT NULL COMMENT '等级ID',
    `level_name` VARCHAR(20) NOT NULL COMMENT '等级名称',
    `discount_rate` DECIMAL(5, 4) NOT NULL DEFAULT 1.0000 COMMENT '折扣率',
    `allow_overdraft` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否允许透支',
    `overdraft_limit` DECIMAL(10, 2) COMMENT '透支额度（元），NULL表示无限制',
    `upgrade_condition_desc` VARCHAR(255) COMMENT '升级条件描述',
    `upgrade_threshold` DECIMAL(12, 2) COMMENT '升级阈值（金额）',
    `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_level_name` (`level_name`),
    CONSTRAINT `chk_discount_rate` CHECK (`discount_rate` > 0 AND `discount_rate` <= 1),
    CONSTRAINT `chk_overdraft_limit` CHECK (`overdraft_limit` IS NULL OR `overdraft_limit` >= 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='信用等级规则字典表';
```

#### **8. 预置信用等级数据**
```sql
-- 插入五级信用等级数据
INSERT INTO `credit_level` (`id`, `level_name`, `discount_rate`, `allow_overdraft`, `overdraft_limit`, `upgrade_condition_desc`) VALUES
(1, '一级会员', 0.90, 0, 0.00, '初始等级'),
(2, '二级会员', 0.85, 0, 0.00, '累计消费满500元'),
(3, '三级会员', 0.85, 1, 500.00, '累计消费满2000元'),
(4, '四级会员', 0.80, 1, 1000.00, '累计消费满5000元'),
(5, '五级会员', 0.75, 1, NULL, '累计消费满10000元');
```

---

### **5.3 视图设计 (Views)**

视图作为虚拟表，封装了复杂的查询逻辑，提供安全、便捷的数据访问接口。

#### **5.3.1 书目综合信息视图 (`v_book_summary`)**
**目的**：为前台网站或后台管理系统提供统一的、包含库存状态的书目展示信息，支持库存预警。
```sql
CREATE VIEW `v_book_summary` AS
SELECT
    b.`book_id`,
    b.`title`,
    b.`publisher`,
    b.`price`,
    b.`status` AS `book_status`,
    COALESCE(i.`quantity`, 0) AS `inventory_quantity`,
    i.`safety_stock`,
    (CASE 
        WHEN COALESCE(i.`quantity`, 0) = 0 THEN '缺货'
        WHEN COALESCE(i.`quantity`, 0) <= i.`safety_stock` THEN '低库存'
        ELSE '充足'
    END) AS `inventory_status`,
    b.`cover_image_url`,
    b.`updated_at`
FROM `book` b
LEFT JOIN `inventory` i ON b.`book_id` = i.`book_id`
WHERE b.`status` = 1; -- 只展示在售书籍
```

#### **5.3.2 客户订单详情视图 (`v_customer_order_detail`)**
**目的**：供客户在个人中心查询其所有订单的详细信息，包括每本书的名称和状态，支持订单跟踪。
```sql
CREATE VIEW `v_customer_order_detail` AS
SELECT
    o.`order_id`,
    o.`customer_id`,
    o.`order_time`,
    o.`order_status`,
    o.`goods_amount`,
    o.`discount_rate`,
    o.`payable_amount`,
    ca.`recipient_name`,
    ca.`recipient_phone`,
    CONCAT(ca.`province`, ca.`city`, ca.`district`, ca.`detail_address`) AS `shipping_address`,
    oi.`id` AS `order_item_id`,
    oi.`book_id`,
    b.`title` AS `book_title`,
    oi.`quantity`,
    oi.`unit_price`,
    oi.`subtotal`,
    oi.`item_status`,
    -- 计算已发货数量（如果实现分次发货）
    (SELECT COALESCE(SUM(si.`ship_quantity`), 0) 
     FROM `shipment_item` si 
     WHERE si.`order_item_id` = oi.`id`) AS `shipped_quantity`
FROM `sales_order` o
JOIN `customer_address` ca ON o.`shipping_address_id` = ca.`id`
JOIN `sales_order_item` oi ON o.`order_id` = oi.`order_id`
JOIN `book` b ON oi.`book_id` = b.`book_id`
WHERE o.`order_status` != 0; -- 排除已取消订单
```

#### **5.3.3 待处理缺书需求视图 (`v_pending_out_of_stock`)**
**目的**：为采购员提供清晰、待处理的缺书清单，便于生成采购单，推荐主供应商。
```sql
CREATE VIEW `v_pending_out_of_stock` AS
SELECT
    oos.`id`,
    oos.`book_id`,
    b.`title`,
    b.`publisher`,
    oos.`required_quantity`,
    oos.`record_date`,
    CASE oos.`source`
        WHEN 1 THEN '手动登记'
        WHEN 2 THEN '库存预警'
        WHEN 3 THEN '客户订单触发'
        WHEN 4 THEN '客户缺书登记'
        ELSE '其他'
    END AS `source_desc`,
    i.`quantity` AS `current_stock`,
    i.`safety_stock`,
    s.`supplier_name` AS `preferred_supplier`,
    sp.`supply_price` AS `suggested_price`,
    sp.`lead_time_days` AS `estimated_lead_time`
FROM `out_of_stock_record` oos
JOIN `book` b ON oos.`book_id` = b.`book_id`
LEFT JOIN `inventory` i ON oos.`book_id` = i.`book_id`
LEFT JOIN (
    SELECT sp1.`book_id`, sp1.`supplier_id`, sp1.`supply_price`, sp1.`lead_time_days`
    FROM `supply` sp1
    WHERE sp1.`is_primary` = 1
) sp ON oos.`book_id` = sp.`book_id`
LEFT JOIN `supplier` s ON sp.`supplier_id` = s.`id`
WHERE oos.`status` = 10 -- 状态为‘待处理’
ORDER BY oos.`priority` ASC, oos.`record_date` ASC;
```

#### **5.3.4 书目多条件检索视图 (`v_book_search`)**
**目的**：封装复杂的书目检索逻辑，支持按书名、出版社、作者、关键字等多条件组合查询。
```sql
CREATE VIEW `v_book_search` AS
SELECT
    b.`book_id`,
    b.`title`,
    b.`publisher`,
    b.`price`,
    b.`cover_image_url`,
    GROUP_CONCAT(DISTINCT a.`author_name` ORDER BY ba.`author_order` SEPARATOR ', ') AS `authors`,
    GROUP_CONCAT(DISTINCT k.`keyword_text` SEPARATOR ', ') AS `keywords`,
    i.`quantity` AS `inventory_quantity`,
    b.`status`
FROM `book` b
LEFT JOIN `book_author` ba ON b.`book_id` = ba.`book_id`
LEFT JOIN `author` a ON ba.`author_id` = a.`id`
LEFT JOIN `book_keyword` bk ON b.`book_id` = bk.`book_id`
LEFT JOIN `keyword` k ON bk.`keyword_id` = k.`id`
LEFT JOIN `inventory` i ON b.`book_id` = i.`book_id`
WHERE b.`status` = 1 -- 在售书籍
GROUP BY b.`book_id`, b.`title`, b.`publisher`, b.`price`, b.`cover_image_url`, i.`quantity`, b.`status`;
```

---

### **5.4 触发器设计 (Triggers)**

触发器用于实现那些超越标准 SQL 约束的、与具体业务行数据相关的完整性规则。

#### **5.4.1 限制每本书的作者数量（不超过4位）**
```sql
DELIMITER $$

CREATE TRIGGER `trg_book_author_limit`
BEFORE INSERT ON `book_author`
FOR EACH ROW
BEGIN
    DECLARE `author_count` INT;
    -- 计算该书当前已关联的作者数量
    SELECT COUNT(*) INTO `author_count`
    FROM `book_author`
    WHERE `book_id` = NEW.`book_id`;

    -- 如果已达到上限，则抛出错误，阻止插入
    IF `author_count` >= 4 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '每本图书最多只能关联4位作者。';
    END IF;
END$$

DELIMITER ;
```

#### **5.4.2 限制每本书的关键字数量（不超过10个）**
```sql
DELIMITER $$

CREATE TRIGGER `trg_book_keyword_limit`
BEFORE INSERT ON `book_keyword`
FOR EACH ROW
BEGIN
    DECLARE `keyword_count` INT;
    SELECT COUNT(*) INTO `keyword_count`
    FROM `book_keyword`
    WHERE `book_id` = NEW.`book_id`;

    IF `keyword_count` >= 10 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '每本图书最多只能关联10个关键字。';
    END IF;
END$$

DELIMITER ;
```

#### **5.4.3 确保缺书记录的唯一性（同一书‘待处理’状态不重复）**
```sql
DELIMITER $$

CREATE TRIGGER `trg_unique_out_of_stock`
BEFORE INSERT ON `out_of_stock_record`
FOR EACH ROW
BEGIN
    DECLARE `pending_count` INT;
    -- 检查是否存在同书号且状态为‘待处理’的记录
    SELECT COUNT(*) INTO `pending_count`
    FROM `out_of_stock_record`
    WHERE `book_id` = NEW.`book_id` AND `status` = 10;

    IF `pending_count` > 0 AND NEW.`status` = 10 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = '该书已存在一条待处理的缺书记录，无需重复添加。';
    END IF;
END$$

DELIMITER ;
```

#### **5.4.4 自动维护订单总金额 (`goods_amount` 和 `payable_amount`)**
```sql
DELIMITER $$

-- 插入订单明细后更新订单总金额
CREATE TRIGGER `trg_sync_order_amount_insert`
AFTER INSERT ON `sales_order_item`
FOR EACH ROW
BEGIN
    UPDATE `sales_order`
    SET `goods_amount` = (
        SELECT SUM(`subtotal`) FROM `sales_order_item` WHERE `order_id` = NEW.`order_id`
    ),
    `payable_amount` = `goods_amount` * `discount_rate`
    WHERE `order_id` = NEW.`order_id`;
END$$

-- 更新订单明细后更新订单总金额
CREATE TRIGGER `trg_sync_order_amount_update`
AFTER UPDATE ON `sales_order_item`
FOR EACH ROW
BEGIN
    UPDATE `sales_order`
    SET `goods_amount` = (
        SELECT SUM(`subtotal`) FROM `sales_order_item` WHERE `order_id` = NEW.`order_id`
    ),
    `payable_amount` = `goods_amount` * `discount_rate`
    WHERE `order_id` = NEW.`order_id`;
END$$

-- 删除订单明细后更新订单总金额
CREATE TRIGGER `trg_sync_order_amount_delete`
AFTER DELETE ON `sales_order_item`
FOR EACH ROW
BEGIN
    UPDATE `sales_order`
    SET `goods_amount` = (
        SELECT SUM(`subtotal`) FROM `sales_order_item` WHERE `order_id` = OLD.`order_id`
    ),
    `payable_amount` = `goods_amount` * `discount_rate`
    WHERE `order_id` = OLD.`order_id`;
END$$

DELIMITER ;
```

#### **5.4.5 库存低于安全阈值时自动生成缺书记录**
```sql
DELIMITER $$

CREATE TRIGGER `trg_auto_out_of_stock`
AFTER UPDATE ON `inventory`
FOR EACH ROW
BEGIN
    DECLARE `pending_count` INT;
    
    -- 检查库存是否低于安全阈值，且不是初始插入（OLD.quantity不为NULL）
    IF OLD.`quantity` IS NOT NULL AND NEW.`quantity` <= NEW.`safety_stock` AND OLD.`quantity` > NEW.`safety_stock` THEN
        -- 检查是否已存在待处理的缺书记录
        SELECT COUNT(*) INTO `pending_count`
        FROM `out_of_stock_record`
        WHERE `book_id` = NEW.`book_id` AND `status` = 10;
        
        -- 如果没有待处理的记录，则创建一条
        IF `pending_count` = 0 THEN
            INSERT INTO `out_of_stock_record` (`book_id`, `required_quantity`, `source`, `status`, `priority`)
            VALUES (NEW.`book_id`, NEW.`safety_stock` * 2, 2, 10, 2); -- 库存预警，中等优先级
        END IF;
    END IF;
END$$

DELIMITER ;
```

#### **5.4.6 更新客户累计消费额**
```sql
DELIMITER $$

CREATE TRIGGER `trg_update_customer_consumption`
AFTER UPDATE ON `sales_order`
FOR EACH ROW
BEGIN
    -- 当订单状态从非完成状态变为完成状态时，更新客户累计消费额
    IF OLD.`order_status` != 50 AND NEW.`order_status` = 50 THEN
        UPDATE `customer`
        SET `total_consumption` = `total_consumption` + NEW.`payable_amount`
        WHERE `id` = NEW.`customer_id`;
    END IF;
END$$

DELIMITER ;
```

---

### **5.5 存储过程设计 (Stored Procedures)**

存储过程封装了需要事务支持和复杂逻辑的业务操作，是应用程序与数据库交互的主要方式之一。

#### **5.5.1 客户下单过程 (`sp_place_order`)**
**功能**：处理客户下单的核心流程，包括创建订单头、插入订单明细、计算金额、快照折扣率。
```sql
DELIMITER $$

CREATE PROCEDURE `sp_place_order`(
    IN `p_customer_id` BIGINT UNSIGNED,
    IN `p_shipping_address_id` BIGINT UNSIGNED,
    IN `p_order_id` VARCHAR(32),
    IN `p_order_items` JSON -- 格式：[{"book_id":"B001", "quantity":2}, ...]
)
BEGIN
    DECLARE `v_discount_rate` DECIMAL(5,4);
    DECLARE `v_goods_amount` DECIMAL(10,2) DEFAULT 0.00;
    DECLARE `i` INT DEFAULT 0;
    DECLARE `item_count` INT;
    DECLARE `v_book_id` VARCHAR(32);
    DECLARE `v_quantity` INT;
    DECLARE `v_unit_price` DECIMAL(10,2);
    DECLARE `v_subtotal` DECIMAL(10,2);
    DECLARE `v_book_status` TINYINT;
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;

    -- 1. 获取客户当前折扣率
    SELECT cl.`discount_rate` INTO `v_discount_rate`
    FROM `customer` c
    JOIN `credit_level` cl ON c.`level_id` = cl.`id`
    WHERE c.`id` = `p_customer_id`;
    
    IF `v_discount_rate` IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '客户不存在或信用等级无效。';
    END IF;

    -- 2. 开始事务
    START TRANSACTION;

    -- 3. 创建订单主记录
    INSERT INTO `sales_order` (`order_id`, `customer_id`, `shipping_address_id`, `discount_rate`)
    VALUES (`p_order_id`, `p_customer_id`, `p_shipping_address_id`, `v_discount_rate`);

    -- 4. 解析JSON，循环插入订单明细
    SET `item_count` = JSON_LENGTH(`p_order_items`);
    
    WHILE `i` < `item_count` DO
        SET `v_book_id` = JSON_UNQUOTE(JSON_EXTRACT(`p_order_items`, CONCAT('$[', `i`, '].book_id')));
        SET `v_quantity` = JSON_EXTRACT(`p_order_items`, CONCAT('$[', `i`, '].quantity'));
        
        -- 检查图书状态和库存
        SELECT `price`, `status` INTO `v_unit_price`, `v_book_status` 
        FROM `book` 
        WHERE `book_id` = `v_book_id` FOR UPDATE;
        
        IF `v_unit_price` IS NULL OR `v_book_status` != 1 THEN
            ROLLBACK;
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = CONCAT('图书不存在或已下架: ', `v_book_id`);
        END IF;
        
        -- 计算折扣后单价和小计
        SET `v_unit_price` = `v_unit_price` * `v_discount_rate`;
        SET `v_subtotal` = `v_unit_price` * `v_quantity`;
        SET `v_goods_amount` = `v_goods_amount` + `v_subtotal`;

        -- 插入订单明细
        INSERT INTO `sales_order_item` (`order_id`, `book_id`, `quantity`, `unit_price`, `subtotal`)
        VALUES (`p_order_id`, `v_book_id`, `v_quantity`, `v_unit_price`, `v_subtotal`);

        SET `i` = `i` + 1;
    END WHILE;

    -- 5. 提交事务
    COMMIT;
    
    SELECT `p_order_id` AS `order_id`, `v_goods_amount` AS `goods_amount`, 
           (`v_goods_amount` * `v_discount_rate`) AS `payable_amount`;
END$$

DELIMITER ;
```

#### **5.5.2 订单发货与扣款过程 (`sp_ship_order`)**
**功能**：执行发货操作，包括校验支付能力、扣减账户余额、扣减库存、创建发货记录。
```sql
DELIMITER $$

CREATE PROCEDURE `sp_ship_order`(
    IN `p_order_id` VARCHAR(32),
    IN `p_operator` VARCHAR(50),
    IN `p_carrier` VARCHAR(50),
    IN `p_tracking_number` VARCHAR(50)
)
BEGIN
    DECLARE `v_customer_id` BIGINT UNSIGNED;
    DECLARE `v_payable_amount` DECIMAL(10,2);
    DECLARE `v_balance` DECIMAL(10,2);
    DECLARE `v_allow_overdraft` TINYINT(1);
    DECLARE `v_overdraft_limit` DECIMAL(10,2);
    DECLARE `v_shipment_id` VARCHAR(32);
    DECLARE `done` BOOLEAN DEFAULT FALSE;
    DECLARE `cur_item_id` BIGINT UNSIGNED;
    DECLARE `cur_book_id` VARCHAR(32);
    DECLARE `cur_quantity` INT;
    DECLARE `cur_inventory` INT;
    
    -- 游标，用于遍历需要发货的订单明细
    DECLARE `item_cursor` CURSOR FOR
        SELECT `id`, `book_id`, `quantity`
        FROM `sales_order_item`
        WHERE `order_id` = `p_order_id` AND `item_status` = 10; -- 状态为‘已下单’

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET `done` = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;

    -- 1. 获取订单信息并加锁
    START TRANSACTION;
    
    SELECT `customer_id`, `payable_amount`
    INTO `v_customer_id`, `v_payable_amount`
    FROM `sales_order`
    WHERE `order_id` = `p_order_id` AND `order_status` = 20 -- 状态为‘待发货’
    FOR UPDATE;

    IF `v_customer_id` IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '订单不存在或状态不正确，无法发货。';
    END IF;

    -- 2. 获取客户信用信息并加锁
    SELECT c.`account_balance`, cl.`allow_overdraft`, cl.`overdraft_limit`
    INTO `v_balance`, `v_allow_overdraft`, `v_overdraft_limit`
    FROM `customer` c
    JOIN `credit_level` cl ON c.`level_id` = cl.`id`
    WHERE c.`id` = `v_customer_id`
    FOR UPDATE;

    -- 3. 支付能力校验
    IF `v_allow_overdraft` = 0 AND `v_balance` < `v_payable_amount` THEN
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '账户余额不足且不允许透支。';
    END IF;
    
    IF `v_allow_overdraft` = 1 AND (`v_balance` + COALESCE(`v_overdraft_limit`, 9999999.99)) < `v_payable_amount` THEN
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '账户余额与透支额度之和不足。';
    END IF;

    -- 4. 扣减客户余额
    UPDATE `customer`
    SET `account_balance` = `account_balance` - `v_payable_amount`,
        `updated_at` = CURRENT_TIMESTAMP
    WHERE `id` = `v_customer_id`;

    -- 5. 扣减库存并更新明细状态
    OPEN `item_cursor`;
    `item_loop`: LOOP
        FETCH `item_cursor` INTO `cur_item_id`, `cur_book_id`, `cur_quantity`;
        IF `done` THEN
            LEAVE `item_loop`;
        END IF;

        -- 检查并扣减库存 (带锁)
        SELECT `quantity` INTO `cur_inventory` FROM `inventory` WHERE `book_id` = `cur_book_id` FOR UPDATE;
        
        IF `cur_inventory` < `cur_quantity` THEN
            ROLLBACK;
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = CONCAT('图书库存不足: ', `cur_book_id`, '，当前库存: ', `cur_inventory`, '，需求: ', `cur_quantity`);
        END IF;

        UPDATE `inventory`
        SET `quantity` = `quantity` - `cur_quantity`,
            `updated_at` = CURRENT_TIMESTAMP
        WHERE `book_id` = `cur_book_id`;

        UPDATE `sales_order_item`
        SET `item_status` = 20 -- 标记为‘已发货’
        WHERE `id` = `cur_item_id`;
    END LOOP;
    CLOSE `item_cursor`;

    -- 6. 创建发货单 (如果实现分次发货)
    SET `v_shipment_id` = CONCAT('SH', DATE_FORMAT(NOW(), '%Y%m%d'), LPAD(FLOOR(RAND()*10000), 4, '0'));
    
    INSERT INTO `shipment` (`shipment_id`, `order_id`, `carrier`, `tracking_number`, `operator`)
    VALUES (`v_shipment_id`, `p_order_id`, `p_carrier`, `p_tracking_number`, `p_operator`);

    -- 7. 更新订单状态
    UPDATE `sales_order`
    SET `order_status` = 40, -- 标记为‘已发货’
        `updated_at` = CURRENT_TIMESTAMP
    WHERE `order_id` = `p_order_id`;

    -- 8. 提交事务
    COMMIT;
    
    SELECT `v_shipment_id` AS `shipment_id`, '发货成功' AS `message`;
END$$

DELIMITER ;
```

#### **5.5.3 采购到货入库过程 (`sp_receive_purchase`)**
**功能**：处理采购单到货，增加库存，自动核销缺书记录，并返回需通知到货的客户名单供应用层发信。

```sql
DELIMITER $$

CREATE PROCEDURE `sp_receive_purchase`(
    IN `p_purchase_order_id` VARCHAR(32),
    IN `p_received_items` JSON -- 格式：[{"book_id":"B001", "received_quantity":50}, ...]
)
BEGIN
    DECLARE `i` INT DEFAULT 0;
    DECLARE `item_count` INT;
    DECLARE `v_book_id` VARCHAR(32);
    DECLARE `v_received_qty` INT;
    DECLARE `v_total_items` INT DEFAULT 0;
    DECLARE `v_completed_items` INT DEFAULT 0;
    DECLARE `v_po_status` TINYINT;
    DECLARE `v_supplier_id` BIGINT UNSIGNED;
    
    -- 临时表用于收集本次到货涉及的所有书目ID，以便最后统一查询通知名单
    CREATE TEMPORARY TABLE IF NOT EXISTS `tmp_notified_books` (`book_id` VARCHAR(32));
    DELETE FROM `tmp_notified_books`;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;

    START TRANSACTION;

    -- 检查采购单状态
    SELECT `status`, `supplier_id` INTO `v_po_status`, `v_supplier_id` 
    FROM `purchase_order` 
    WHERE `purchase_order_id` = `p_purchase_order_id` FOR UPDATE;
    
    IF `v_po_status` IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '采购单不存在。';
    END IF;
    
    IF `v_po_status` NOT IN (20, 30) THEN 
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '采购单状态不允许进行到货操作。';
    END IF;

    SELECT COUNT(*) INTO `v_total_items` FROM `purchase_order_item` WHERE `purchase_order_id` = `p_purchase_order_id`;

    SET `item_count` = JSON_LENGTH(`p_received_items`);
    WHILE `i` < `item_count` DO
        SET `v_book_id` = JSON_UNQUOTE(JSON_EXTRACT(`p_received_items`, CONCAT('$[', `i`, '].book_id')));
        SET `v_received_qty` = JSON_EXTRACT(`p_received_items`, CONCAT('$[', `i`, '].received_quantity'));

        IF EXISTS (SELECT 1 FROM `purchase_order_item` WHERE `purchase_order_id` = `p_purchase_order_id` AND `book_id` = `v_book_id`) THEN
            -- 1. 增加库存
            UPDATE `inventory`
            SET `quantity` = `quantity` + `v_received_qty`, `updated_at` = CURRENT_TIMESTAMP
            WHERE `book_id` = `v_book_id`;

            -- 2. 记录本次到货的书目，用于后续查询通知名单
            INSERT INTO `tmp_notified_books` VALUES (`v_book_id`);

            -- 3. 更新关联的缺书记录状态为‘已到货(30)’
            UPDATE `out_of_stock_record`
            SET `status` = 30, `updated_at` = CURRENT_TIMESTAMP
            WHERE `book_id` = `v_book_id` AND `status` = 20;

            SET `v_completed_items` = `v_completed_items` + 1;
        END IF;
        SET `i` = `i` + 1;
    END WHILE;

    -- 更新采购单状态
    UPDATE `purchase_order`
    SET `status` = IF(`v_completed_items` = `v_total_items`, 40, 30), `updated_at` = CURRENT_TIMESTAMP
    WHERE `purchase_order_id` = `p_purchase_order_id`;

    COMMIT;
    
    -- 返回两个结果集
    -- 结果集1：操作状态
    SELECT '采购到货处理成功' AS `message`, `v_completed_items` AS `completed_items`;

    -- 结果集2：到货通知名单（应用层获取此列表后执行发信操作）
    SELECT 
        c.real_name, 
        c.email, 
        b.title AS book_title,
        oos.record_date AS request_date
    FROM `out_of_stock_record` oos
    JOIN `customer` c ON oos.related_customer_id = c.id
    JOIN `book` b ON oos.book_id = b.book_id
    WHERE oos.book_id IN (SELECT book_id FROM `tmp_notified_books`)
      AND oos.status = 30; -- 仅查询状态刚变为已到货的记录
END$$

DELIMITER ;
```

#### **5.5.4 信用等级自动调整存储过程 (`sp_auto_adjust_credit_level`)**
**功能**：每月初根据客户累计消费额自动调整信用等级。

```sql
DELIMITER $$

CREATE PROCEDURE `sp_auto_adjust_credit_level`()
BEGIN
    DECLARE `done` BOOLEAN DEFAULT FALSE;
    DECLARE `v_customer_id` BIGINT UNSIGNED;
    DECLARE `v_total_consumption` DECIMAL(12,2);
    DECLARE `v_current_level` TINYINT UNSIGNED;
    DECLARE `v_new_level` TINYINT UNSIGNED;
    DECLARE `v_upgrade_threshold` DECIMAL(12,2);
    
    -- 游标，遍历所有活跃客户
    DECLARE `customer_cursor` CURSOR FOR
        SELECT `id`, `total_consumption`, `level_id`
        FROM `customer`
        WHERE `status` = 1; -- 只处理活跃客户

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET `done` = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;

    START TRANSACTION;
    
    OPEN `customer_cursor`;
    `customer_loop`: LOOP
        FETCH `customer_cursor` INTO `v_customer_id`, `v_total_consumption`, `v_current_level`;
        IF `done` THEN
            LEAVE `customer_loop`;
        END IF;
        
        -- 根据累计消费额确定新等级
        IF `v_total_consumption` >= 10000 THEN
            SET `v_new_level` = 5;
        ELSEIF `v_total_consumption` >= 5000 THEN
            SET `v_new_level` = 4;
        ELSEIF `v_total_consumption` >= 2000 THEN
            SET `v_new_level` = 3;
        ELSEIF `v_total_consumption` >= 500 THEN
            SET `v_new_level` = 2;
        ELSE
            SET `v_new_level` = 1;
        END IF;
        
        -- 如果等级需要提升
        IF `v_new_level` > `v_current_level` THEN
            UPDATE `customer`
            SET `level_id` = `v_new_level`,
                `updated_at` = CURRENT_TIMESTAMP
            WHERE `id` = `v_customer_id`;
            
            -- 可以在此处记录等级变更日志
            INSERT INTO `credit_level_log` (`customer_id`, `old_level`, `new_level`, `change_reason`, `change_time`)
            VALUES (`v_customer_id`, `v_current_level`, `v_new_level`, '自动调整:累计消费达标', NOW());
        END IF;
    END LOOP;
    CLOSE `customer_cursor`;
    
    COMMIT;
    
    SELECT '信用等级自动调整完成' AS `message`;
END$$

DELIMITER ;
```

#### **5.5.5 书目多条件检索存储过程 (`sp_search_books`)**
**功能**：支持按书名、出版社、作者、关键字等多条件组合检索。利用 MySQL 全文索引实现“匹配程度（Relevance）”排序，优先展示最相关的结果。

```sql
DELIMITER $$

CREATE PROCEDURE `sp_search_books`(
    IN `p_keyword` VARCHAR(255),
    IN `p_publisher` VARCHAR(100),
    IN `p_author_name` VARCHAR(100),
    IN `p_min_price` DECIMAL(10,2),
    IN `p_max_price` DECIMAL(10,2),
    IN `p_offset` INT,
    IN `p_limit` INT
)
BEGIN
    -- 1. 定义基础查询语句
    -- 这里使用了 MATCH...AGAINST 计算相关度分值 (relevance)
    -- 如果未输入关键字，relevance 默认为 0
    SET @`sql_query` = '
        SELECT DISTINCT
            b.`book_id`,
            b.`title`,
            b.`publisher`,
            b.`price`,
            b.`cover_image_url`,
            i.`quantity` AS `inventory_quantity`,
            b.`status`,
            (CASE 
                WHEN ? IS NOT NULL AND ? != '''' THEN MATCH(b.`title`, b.`catalog`) AGAINST(?) 
                ELSE 0 
             END) AS `relevance`
        FROM `book` b
        LEFT JOIN `inventory` i ON b.`book_id` = i.`book_id`
        LEFT JOIN `book_author` ba ON b.`book_id` = ba.`book_id`
        LEFT JOIN `author` a ON ba.`author_id` = a.`id`
        LEFT JOIN `book_keyword` bk ON b.`book_id` = bk.`book_id`
        LEFT JOIN `keyword` k ON bk.`keyword_id` = k.`id`
        WHERE b.`status` = 1
    ';

    -- 2. 动态拼接 WHERE 条件
    -- 使用 QUOTE() 函数可以安全地处理字符串转义，避免 SQL 注入，同时简化参数绑定逻辑

    -- 关键字检索：同时支持全文检索和模糊匹配
    IF `p_keyword` IS NOT NULL AND `p_keyword` != '' THEN
        SET @`sql_query` = CONCAT(@`sql_query`, 
            ' AND (MATCH(b.`title`, b.`catalog`) AGAINST(', QUOTE(`p_keyword`), ')',
            ' OR k.`keyword_text` LIKE ', QUOTE(CONCAT('%', `p_keyword`, '%')), ')');
    END IF;

    -- 出版社过滤
    IF `p_publisher` IS NOT NULL AND `p_publisher` != '' THEN
        SET @`sql_query` = CONCAT(@`sql_query`, ' AND b.`publisher` LIKE ', QUOTE(CONCAT('%', `p_publisher`, '%')));
    END IF;

    -- 作者过滤
    IF `p_author_name` IS NOT NULL AND `p_author_name` != '' THEN
        SET @`sql_query` = CONCAT(@`sql_query`, ' AND a.`author_name` LIKE ', QUOTE(CONCAT('%', `p_author_name`, '%')));
    END IF;

    -- 价格区间过滤
    IF `p_min_price` IS NOT NULL THEN
        SET @`sql_query` = CONCAT(@`sql_query`, ' AND b.`price` >= ', `p_min_price`);
    END IF;
    IF `p_max_price` IS NOT NULL THEN
        SET @`sql_query` = CONCAT(@`sql_query`, ' AND b.`price` <= ', `p_max_price`);
    END IF;

    -- 3. 排序与分页
    -- 优先按 relevance (匹配程度) 降序排列，其次按更新时间
    SET @`sql_query` = CONCAT(@`sql_query`, ' ORDER BY `relevance` DESC, b.`updated_at` DESC LIMIT ', `p_offset`, ', ', `p_limit`);

    -- 4. 执行查询
    -- 只需要绑定 SELECT 子句中计算分数所需的 3 个占位符（即 p_keyword）
    PREPARE `stmt` FROM @`sql_query`;
    EXECUTE `stmt` USING `p_keyword`, `p_keyword`, `p_keyword`;
    DEALLOCATE PREPARE `stmt`;
END$$

DELIMITER ;
```

---

### **5.6 数据库安全与维护考虑**

1.  **用户与权限**：应在 MySQL 中创建不同的数据库用户，并授予最小必要权限。例如：
    *   `bookstore_web`：用于网上书店前端连接，仅有 `SELECT` 权限（用于浏览）和特定存储过程的 `EXECUTE` 权限。
    *   `bookstore_app`：用于后台管理系统连接，拥有对业务表的 `SELECT`, `INSERT`, `UPDATE`, `DELETE` 权限，以及执行相关存储过程的 `EXECUTE` 权限。
    *   `bookstore_admin`：用于数据库管理，拥有更高级的权限（如 `CREATE`, `ALTER`, `DROP`），但仅限于维护时段使用。

2.  **密码安全**：客户密码可以考虑在应用层进行加盐哈希处理（如 bcrypt）后再存入 `customer.password_hash` 字段，数据库不存储明文。存储过程应使用参数化查询防止SQL注入。

3.  **审计日志**：对于关键操作（如发货、扣款、大额充值、信用等级变更），可考虑在数据库中创建审计日志表记录详细的操作信息。
    
    ```sql
    CREATE TABLE `operation_log` (
        `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
        `user_id` BIGINT UNSIGNED COMMENT '操作员ID',
        `operation_type` VARCHAR(50) NOT NULL COMMENT '操作类型',
        `target_table` VARCHAR(50) COMMENT '目标表',
        `target_id` VARCHAR(100) COMMENT '目标记录ID',
        `operation_detail` JSON COMMENT '操作详情',
        `ip_address` VARCHAR(45) COMMENT 'IP地址',
        `user_agent` TEXT COMMENT '用户代理',
        `operation_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (`id`),
        INDEX `idx_operation_time` (`operation_time`),
        INDEX `idx_operation_type` (`operation_type`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作审计日志表';
    ```
    
4.  **备份策略**：可以考虑制定定期备份策略（如每日全备，每小时增量备份），可使用 MySQL `mysqldump` 或第三方工具，并测试恢复流程。本设计中的 `created_at`/`updated_at` 字段有助于进行时间点恢复。

5.  **性能监控**：定期监控慢查询日志，优化索引。对于大表（如 `sales_order_item`）考虑分区或归档策略。

6.  **事件调度**：使用 MySQL 事件调度器定期执行维护任务：
    ```sql
    -- 每月1日凌晨执行信用等级自动调整
    CREATE EVENT `event_auto_adjust_credit_level`
    ON SCHEDULE EVERY 1 MONTH
    STARTS '2024-01-01 02:00:00'
    DO
    CALL `sp_auto_adjust_credit_level`();
    
    -- 启用事件调度器
    SET GLOBAL event_scheduler = ON;
    ```

---

### **5.7 本部分小结**

本部分完成了网上书店数据库从设计到实现的最终跨越，提供了：
*   **可执行的 DDL 脚本**，用于创建所有核心表结构、索引和约束，完整覆盖网上书店业务需求。
*   **面向业务的视图**，简化了复杂的数据查询，特别是书目检索和订单跟踪功能。
*   **关键业务规则的触发器实现**，在数据库层面保障了数据的完整性，包括作者关键字数量限制、缺书记录唯一性、库存自动预警等。
*   **核心业务流程的存储过程封装**，确保了事务的原子性、一致性和业务逻辑的集中管理，涵盖下单、发货、采购、信用调整等关键流程。

**本实现方案的特点：**
1.  **完整性**：完整实现了网上书店管理系统的所有必选功能和可选扩展功能。
2.  **安全性**：通过视图隐藏敏感数据，通过存储过程封装业务逻辑，防止SQL注入。
3.  **性能优化**：合理的索引设计、视图预计算、存储过程减少网络往返。
4.  **可维护性**：清晰的表结构、规范的命名、完整的注释，便于后续维护和扩展。
5.  **实用性**：提供了可直接在实验环境中部署和测试的完整代码。

此数据库实现方案为网上书店管理系统的开发奠定了坚实的数据基础，后续的应用开发可以基于此数据库结构进行。

## **第 6 部分：数据字典（Data Dictionary）**

### **6.1 数据字典说明**

数据字典是数据库设计的"元数据"中心，它以结构化的方式详尽描述了数据库中所有对象（表、字段、约束、视图、存储过程等）的定义、含义、关系和规则。本数据字典的编制旨在实现以下目标：

1.  **统一知识库**：为数据库设计者、软件开发人员、测试人员及系统维护人员提供一份关于数据库结构的唯一、权威的解释性文档，确保团队对数据有一致的理解。
2.  **设计规范化体现**：系统化地展示表结构、字段属性、主外键关系以及业务约束，体现设计的严谨性和规范性。
3.  **提高可维护性**：当需要进行数据库结构变更、故障排查或新功能开发时，维护人员可以快速查阅相关数据对象的定义和关联关系。
4.  **支持文档自动化**：结构化的数据字典可以作为未来生成数据库设计报告、API接口文档或数据血缘分析的基础。
5.  **确保数据一致性**：明确各数据项的取值规则、业务含义和约束条件，防止数据歧义和不一致。

本数据字典依据第3、4、5部分的设计成果编制，主要包括：表级数据字典、字段级数据字典、关键约束与规则说明以及重要视图、触发器与存储过程摘要。

---

### **6.2 表级数据字典**

表级数据字典提供了对数据库中每张核心表的宏观描述，包括其业务含义、主键、外键关系及主要用途。

| 序号 | 表名 (英文)           | 表名 (中文)       | 业务含义                                                     | 主键                           | 外键关联                                                     | 主要用途/业务模块                          |
| :--- | :-------------------- | :---------------- | :----------------------------------------------------------- | :----------------------------- | :----------------------------------------------------------- | :----------------------------------------- |
| 1    | `book`                | 书目表            | 存储图书的核心静态信息，如书名、作者、出版社、定价等。支持丛书标识。 | `book_id`                      | `parent_book_id → book(book_id)`                             | 供书目录管理、图书检索、订单与采购的基础。 |
| 2    | `author`              | 作者表            | 存储作者信息，独立管理以避免重复。                           | `id`                           | 无                                                           | 支持按作者查询，与书目建立多对多关联。     |
| 3    | `book_author`         | 书目-作者关联表   | 记录图书与作者的多对多关系，并明确作者顺序。                 | `(book_id, author_order)`      | `book_id → book`<br>`author_id → author`                     | 实现"一书多作者有序"的业务规则。           |
| 4    | `keyword`             | 关键字表          | 统一管理所有用于分类和检索的关键字。                         | `id`                           | 无                                                           | 支持图书的多维度标签化与高级检索。         |
| 5    | `book_keyword`        | 书目-关键字关联表 | 记录图书与关键字的多对多关系。                               | `(book_id, keyword_id)`        | `book_id → book`<br>`keyword_id → keyword`                   | 实现"一书多关键字"的标记功能。             |
| 6    | `inventory`           | 库存表            | 记录每种书目的实时可用库存量及安全阈值。                     | `book_id`                      | `book_id → book`                                             | 库存管理、发货出库、缺货预警、采购决策。   |
| 7    | `supplier`            | 供应商表          | 存储图书供应商的基本信息及合作状态。                         | `id`                           | 无                                                           | 供应商管理、采购单关联。                   |
| 8    | `supply`              | 供货关系表        | 描述供应商与可供应书目之间的关系，记录供货价等信息。         | `(supplier_id, book_id)`       | `supplier_id → supplier`<br>`book_id → book`                 | 支持多货源采购，为采购决策提供依据。       |
| 9    | `credit_level`        | 信用等级表        | 定义客户信用等级的规则，如折扣率、透支权限等。               | `id`                           | 无                                                           | 信用管理体系的核心规则配置表。             |
| 10   | `customer`            | 客户表            | 存储网上书店注册客户的信息、账户及信用状态。                 | `id`                           | `level_id → credit_level`                                    | 客户管理、身份验证、账户与信用管理。       |
| 11   | `customer_address`    | 客户地址表        | 存储客户的多个收货地址信息。                                 | `id`                           | `customer_id → customer`                                     | 支持客户管理多个收货地址，下单时选择。     |
| 12   | `sales_order`         | 订单表            | 记录客户的一次完整购买请求，是交易的核心凭证。               | `order_id`                     | `customer_id → customer`<br>`shipping_address_id → customer_address` | 订单流程管理、支付、发货的总控。           |
| 13   | `sales_order_item`    | 订单明细表        | 记录订单中包含的每一种图书及其数量、价格快照。               | `id`                           | `order_id → sales_order`<br>`book_id → book`                 | 实现"一单多书"，存储交易明细。             |
| 14   | `shipment`            | 发货单表 (可选)   | 记录一次具体的发货行为，支持订单分次发货。                   | `shipment_id`                  | `order_id → sales_order`                                     | 物流管理、发货跟踪。                       |
| 15   | `shipment_item`       | 发货明细表 (可选) | 记录一次发货中包含的具体图书及数量。                         | `(shipment_id, order_item_id)` | `shipment_id → shipment`<br>`order_item_id → sales_order_item` | 精细化管理分次发货的货品明细。             |
| 16   | `out_of_stock_record` | 缺书记录表        | 记录因库存不足产生的采购需求。                               | `id`                           | `book_id → book`<br>`related_customer_id → customer`         | 采购管理的起点，触发补货流程。             |
| 17   | `purchase_order`      | 采购单表          | 记录书店向供应商的正式采购请求。                             | `purchase_order_id`            | `supplier_id → supplier`                                     | 采购流程管理，跟踪采购状态。               |
| 18   | `purchase_order_item` | 采购明细表        | 记录采购单中要采购的具体书目及数量、价格。                   | `(purchase_order_id, book_id)` | `purchase_order_id → purchase_order`<br>`book_id → book`<br>`related_out_of_stock_id → out_of_stock_record` | 明确采购内容，关联缺书需求。               |
| 19   | `operation_log`       | 操作日志表        | 记录关键操作的审计日志。                                     | `id`                           | `user_id → customer(id)` (可选)                              | 安全审计、操作追踪。                       |

---

### **6.3 字段级数据字典（核心表示例）**

由于字段数量众多，此处选取最具代表性、业务含义最丰富的五张表（`book`, `customer`, `sales_order`, `credit_level`, `out_of_stock_record`）进行详细字段说明。

#### **6.3.1 书目表 (`book`) 字段说明**

| 字段名            | 数据类型         | 空否     | 默认值                      | 中文含义     | 约束/业务规则说明                                            |
| :---------------- | :--------------- | :------- | :-------------------------- | :----------- | :----------------------------------------------------------- |
| `book_id`         | VARCHAR(32)      | NOT NULL |                             | **书号**     | **主键**。业务主键，如图书ISBN或内部编码。                   |
| `isbn`            | VARCHAR(13)      | NULL     |                             | 国际标准书号 | UNIQUE。全球标准图书编号。                                   |
| `title`           | VARCHAR(255)     | NOT NULL |                             | 书名         | 建立普通索引 (`idx_book_title`) 和全文索引 (`ft_book_title_catalog`)。 |
| `publisher`       | VARCHAR(100)     | NOT NULL |                             | 出版社       | 建立普通索引 (`idx_book_publisher`)。                        |
| `publish_date`    | DATE             | NULL     |                             | 出版日期     |                                                              |
| `edition`         | VARCHAR(20)      | NULL     |                             | 版次         |                                                              |
| `price`           | DECIMAL(10,2)    | NOT NULL | 0.00                        | 定价         | 标准销售价格，单位：元。必须非负。                           |
| `cover_image_url` | VARCHAR(500)     | NULL     |                             | 封面图片URL  | 存储图片文件在服务器或CDN上的路径。                          |
| `catalog`         | TEXT             | NULL     |                             | 内容目录     | 图书的章节介绍。参与全文索引 (`ft_book_title_catalog`)。     |
| `series_flag`     | TINYINT(1)       | NOT NULL | 0                           | 丛书标识     | 0-非丛书，1-丛书。                                           |
| `parent_book_id`  | VARCHAR(32)      | NULL     |                             | 父书号       | 自引用外键，指向所属丛书的父书。                             |
| `status`          | TINYINT UNSIGNED | NOT NULL | 1                           | 状态         | 1-在售，0-下架。建立索引 (`idx_book_status`)。               |
| `created_at`      | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP           | 创建时间     | 记录插入时间。                                               |
| `updated_at`      | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 最后更新时间 | 自动记录最后修改时间。                                       |

#### **6.3.2 客户表 (`customer`) 字段说明**

| 字段名              | 数据类型         | 空否     | 默认值                      | 中文含义     | 约束/业务规则说明                                         |
| :------------------ | :--------------- | :------- | :-------------------------- | :----------- | :-------------------------------------------------------- |
| `id`                | BIGINT UNSIGNED  | NOT NULL | AUTO_INCREMENT              | **客户ID**   | **主键**。系统内部唯一标识。                              |
| `username`          | VARCHAR(50)      | NOT NULL |                             | 登录用户名   | **UNIQUE**。用于系统登录。                                |
| `password_hash`     | VARCHAR(255)     | NOT NULL |                             | 密码哈希值   | 存储经过加盐哈希处理的密码，非明文。                      |
| `real_name`         | VARCHAR(100)     | NOT NULL |                             | 真实姓名     |                                                           |
| `mobile_phone`      | VARCHAR(20)      | NULL     |                             | 手机号       | **UNIQUE**。重要联系方式，可用于验证。                    |
| `email`             | VARCHAR(100)     | NULL     |                             | 电子邮箱     | **UNIQUE**。用于通知和密码找回。                          |
| `account_balance`   | DECIMAL(10,2)    | NOT NULL | 0.00                        | 账户余额     | 单位：元。可为负数，表示透支。通过CHECK约束限制最小额度。 |
| `total_consumption` | DECIMAL(12,2)    | NOT NULL | 0.00                        | 累计消费额   | 单位：元。用于信用等级自动调整判断。                      |
| `level_id`          | TINYINT UNSIGNED | NOT NULL | 1                           | 信用等级ID   | **外键** → `credit_level(id)`。决定折扣和透支规则。       |
| `registration_time` | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP           | 注册时间     |                                                           |
| `status`            | TINYINT UNSIGNED | NOT NULL | 1                           | 账户状态     | **1-正常，0-冻结**。建立索引 (`idx_status`)。             |
| `updated_at`        | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 最后更新时间 |                                                           |

#### **6.3.3 订单表 (`sales_order`) 字段说明**

| 字段名                | 数据类型         | 空否     | 默认值                      | 中文含义     | 约束/业务规则说明                                            |
| :-------------------- | :--------------- | :------- | :-------------------------- | :----------- | :----------------------------------------------------------- |
| `order_id`            | VARCHAR(32)      | NOT NULL |                             | **订单号**   | **主键**。按规则生成（如'SO'+日期+序列）。                   |
| `customer_id`         | BIGINT UNSIGNED  | NOT NULL |                             | 客户ID       | **外键** → `customer(id)`。建立复合索引 (`idx_so_customer_status_time`)。 |
| `order_time`          | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP           | 下单时间     | 建立索引 (`idx_so_customer_time`)。                          |
| `order_status`        | TINYINT UNSIGNED | NOT NULL | 10                          | 订单状态     | 建立索引 (`idx_so_status`)。                                 |
| `goods_amount`        | DECIMAL(10,2)    | NOT NULL | 0.00                        | 商品总金额   | 订单明细商品原价小计。通过触发器与明细同步。                 |
| `discount_rate`       | DECIMAL(5,4)     | NOT NULL | 1.0000                      | 折扣率快照   | 下单时客户信用等级对应的折扣率。                             |
| `payable_amount`      | DECIMAL(10,2)    | NOT NULL | 0.00                        | 实付金额     | `goods_amount * discount_rate`。通过触发器计算。             |
| `shipping_address_id` | BIGINT UNSIGNED  | NOT NULL |                             | 收货地址ID   | **外键** → `customer_address(id)`。快照关联。                |
| `payment_time`        | TIMESTAMP        | NULL     |                             | 支付时间     | 记录客户成功支付的时间。                                     |
| `customer_note`       | TEXT             | NULL     |                             | 客户备注     | 下单时客户填写的备注信息。                                   |
| `updated_at`          | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 最后更新时间 |                                                              |

#### **6.3.4 信用等级表 (`credit_level`) 字段说明**

| 字段名                   | 数据类型         | 空否     | 默认值            | 中文含义     | 约束/业务规则说明                  |
| :----------------------- | :--------------- | :------- | :---------------- | :----------- | :--------------------------------- |
| `id`                     | TINYINT UNSIGNED | NOT NULL |                   | 等级ID       | **主键**。固定为1-5。              |
| `level_name`             | VARCHAR(20)      | NOT NULL |                   | 等级名称     | **UNIQUE**。如"一级会员"。         |
| `discount_rate`          | DECIMAL(5,4)     | NOT NULL | 1.0000            | 折扣率       | 0-1之间的小数。CHECK约束保证范围。 |
| `allow_overdraft`        | TINYINT(1)       | NOT NULL | 0                 | 是否允许透支 | 0-否，1-是。                       |
| `overdraft_limit`        | DECIMAL(10,2)    | NULL     |                   | 透支额度     | 当允许透支时有效。NULL表示无限制。 |
| `upgrade_condition_desc` | VARCHAR(255)     | NULL     |                   | 升级条件描述 | 文字描述升级条件。                 |
| `upgrade_threshold`      | DECIMAL(12,2)    | NULL     |                   | 升级阈值     | 累计消费额达到此值可升级。         |
| `created_at`             | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间     | 记录插入时间。                     |

#### **6.3.5 缺书记录表 (`out_of_stock_record`) 字段说明**

| 字段名                | 数据类型         | 空否     | 默认值            | 中文含义   | 约束/业务规则说明                                        |
| :-------------------- | :--------------- | :------- | :---------------- | :--------- | :------------------------------------------------------- |
| `id`                  | BIGINT UNSIGNED  | NOT NULL |                   | 缺书记录ID | **主键**。系统内部唯一标识。                             |
| `book_id`             | VARCHAR(32)      | NOT NULL |                   | 书号       | **外键** → `book(book_id)`。                             |
| `required_quantity`   | INT UNSIGNED     | NOT NULL |                   | 需求数量   | 需要采购的数量。                                         |
| `record_date`         | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 登记日期   | 记录创建时间。                                           |
| `source`              | TINYINT UNSIGNED | NOT NULL | 1                 | 来源       | 1-手动登记，2-库存预警，3-客户订单触发，4-客户缺书登记。 |
| `related_customer_id` | BIGINT UNSIGNED  | NULL     |                   | 关联客户ID | **外键** → `customer(id)`。当来源为客户相关时记录。      |
| `status`              | TINYINT UNSIGNED | NOT NULL | 10                | 状态       | 10-待处理，20-已生成采购，30-已到货。                    |
| `priority`            | TINYINT UNSIGNED | NULL     |                   | 优先级     | 1-高，2-中，3-低。用于采购排序。                         |
| `created_at`          | TIMESTAMP        | NOT NULL | CURRENT_TIMESTAMP | 创建时间   | 记录插入时间。                                           |
| `quoted_price`        | DECIMAL(10, 2)   | NULL     |                   | 报价       | 管理员针对询价给出的价格。                               |
| `inquiry_notes`       | TEXT             | NULL     |                   | 询价备注   | 记录客户的具体需求说明。                                 |

---

### **6.4 状态与类型枚举值字典**

为避免在代码中使用硬编码数值，系统中所有状态、类型字段均采用约定的枚举值。以下为关键枚举值定义。

#### **6.4.1 订单状态 (`sales_order.order_status`)**
| 值   | 常量名                    | 含义     | 说明                       |
| :--- | :------------------------ | :------- | :------------------------- |
| 0    | `ORDER_CANCELLED`         | 已取消   | 客户或管理员取消订单。     |
| 10   | `ORDER_PENDING_PAYMENT`   | 待付款   | 订单已创建，等待客户支付。 |
| 20   | `ORDER_PENDING_SHIPMENT`  | 待发货   | 已付款，等待仓库发货。     |
| 30   | `ORDER_PARTIALLY_SHIPPED` | 部分发货 | 订单中部分商品已发货。     |
| 40   | `ORDER_SHIPPED`           | 已发货   | 订单全部商品已发货。       |
| 50   | `ORDER_COMPLETED`         | 已完成   | 客户确认收货，交易完成。   |

#### **6.4.2 订单明细状态 (`sales_order_item.item_status`)**
| 值   | 常量名           | 含义   | 说明                   |
| :--- | :--------------- | :----- | :--------------------- |
| 0    | `ITEM_CANCELLED` | 已取消 | 该商品项被取消。       |
| 10   | `ITEM_ORDERED`   | 已下单 | 已下单，待发货。       |
| 20   | `ITEM_SHIPPED`   | 已发货 | 该商品已发货。         |
| 30   | `ITEM_COMPLETED` | 已完成 | 该商品已确认收货完成。 |

#### **6.4.3 图书状态 (`book.status`)**
| 值   | 常量名              | 含义   | 说明             |
| :--- | :------------------ | :----- | :--------------- |
| 0    | `BOOK_DISCONTINUED` | 已下架 | 图书不再销售。   |
| 1    | `BOOK_AVAILABLE`    | 在售   | 图书正常销售中。 |

#### **6.4.4 客户状态 (`customer.status`)**
| 值   | 常量名            | 含义 | 说明             |
| :--- | :---------------- | :--- | :--------------- |
| 0    | `CUSTOMER_FROZEN` | 冻结 | 账户被冻结。     |
| 1    | `CUSTOMER_ACTIVE` | 正常 | 账户正常使用中。 |

#### **6.4.5 缺书记录状态 (`out_of_stock_record.status`)**
| 值   | 常量名                    | 含义       | 说明                           |
| :--- | :------------------------ | :--------- | :----------------------------- |
| 10   | `OUT_OF_STOCK_PENDING`    | 待处理     | 缺书记录已创建，等待处理。     |
| 20   | `OUT_OF_STOCK_PURCHASING` | 已生成采购 | 已根据缺书记录生成采购单。     |
| 30   | `OUT_OF_STOCK_FULFILLED`  | 已到货     | 采购的图书已到货，需求被满足。 |

#### **6.4.6 缺书记录来源 (`out_of_stock_record.source`)**
| 值   | 常量名                   | 含义         | 说明                                 |
| :--- | :----------------------- | :----------- | :----------------------------------- |
| 1    | `OUT_OF_STOCK_MANUAL`    | 手动登记     | 管理员手动创建的缺书记录。           |
| 2    | `OUT_OF_STOCK_INVENTORY` | 库存预警     | 库存低于安全阈值自动生成。           |
| 3    | `OUT_OF_STOCK_ORDER`     | 客户订单触发 | 客户订单数量超过库存时生成。         |
| 4    | `OUT_OF_STOCK_CUSTOMER`  | 客户缺书登记 | 客户主动登记的缺书需求（询价请求）。 |

#### **6.4.7 采购单状态 (`purchase_order.status`)**
| 值   | 常量名               | 含义     | 说明                       |
| :--- | :------------------- | :------- | :------------------------- |
| 0    | `PURCHASE_CANCELLED` | 已取消   | 采购单被取消。             |
| 10   | `PURCHASE_DRAFT`     | 草稿     | 采购单草稿状态。           |
| 20   | `PURCHASE_ISSUED`    | 已发出   | 采购单已发送给供应商。     |
| 30   | `PURCHASE_PARTIAL`   | 部分到货 | 部分图书已到货。           |
| 40   | `PURCHASE_COMPLETED` | 已完成   | 全部图书已到货，采购完成。 |

#### **6.4.8 信用等级 (`credit_level.id`)**
| 值   | 等级名称 | 折扣率     | 允许透支 | 透支额度      | 升级条件（示例）  |
| :--- | :------- | :--------- | :------- | :------------ | :---------------- |
| 1    | 一级会员 | 90% (0.9)  | 否       | 0             | 初始等级          |
| 2    | 二级会员 | 85% (0.85) | 否       | 0             | 累计消费满500元   |
| 3    | 三级会员 | 85% (0.85) | 是       | 500元         | 累计消费满2000元  |
| 4    | 四级会员 | 80% (0.8)  | 是       | 1000元        | 累计消费满5000元  |
| 5    | 五级会员 | 75% (0.75) | 是       | 无限制 (NULL) | 累计消费满10000元 |

---

### **6.5 重要数据库对象摘要**

#### **6.5.1 视图 (Views) 摘要**
| 视图名称                  | 依赖的表                                                     | 主要功能描述                                                 | 应用场景                             |
| :------------------------ | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------- |
| `v_book_summary`          | `book`, `inventory`                                          | 提供包含实时库存状态、库存状态标记的综合书目信息。           | 前台网站书目列表展示、后台库存监控。 |
| `v_customer_order_detail` | `sales_order`, `sales_order_item`, `book`, `customer_address` | 提供客户订单的完整详情视图，包括每本书的信息和收货地址。支持发货数量统计。 | 客户个人中心的"我的订单"页面查询。   |
| `v_pending_out_of_stock`  | `out_of_stock_record`, `book`, `supply`, `supplier`, `inventory` | 集中展示所有待处理的缺书需求，并推荐主供应商和供货信息。     | 采购员工作台，用于生成采购单。       |
| `v_book_search`           | `book`, `book_author`, `author`, `book_keyword`, `keyword`, `inventory` | 封装多表连接，提供书目检索的统一接口，包含作者和关键字信息。 | 书目多条件检索功能。                 |

#### **6.5.2 触发器 (Triggers) 摘要**
| 触发器名称                        | 关联表                | 触发时机        | 核心功能与业务规则                                           |
| :-------------------------------- | :-------------------- | :-------------- | :----------------------------------------------------------- |
| `trg_book_author_limit`           | `book_author`         | `BEFORE INSERT` | 确保每本图书关联的作者数量不超过4位。                        |
| `trg_book_keyword_limit`          | `book_keyword`        | `BEFORE INSERT` | 确保每本图书关联的关键字数量不超过10个。                     |
| `trg_unique_out_of_stock`         | `out_of_stock_record` | `BEFORE INSERT` | 防止对同一本书重复生成"待处理"状态的缺书记录。               |
| `trg_sync_order_amount_insert`    | `sales_order_item`    | `AFTER INSERT`  | 插入订单明细后，自动重新计算并更新订单主表中的商品总金额和实付金额。 |
| `trg_sync_order_amount_update`    | `sales_order_item`    | `AFTER UPDATE`  | 更新订单明细后，自动重新计算并更新订单主表中的商品总金额和实付金额。 |
| `trg_sync_order_amount_delete`    | `sales_order_item`    | `AFTER DELETE`  | 删除订单明细后，自动重新计算并更新订单主表中的商品总金额和实付金额。 |
| `trg_auto_out_of_stock`           | `inventory`           | `AFTER UPDATE`  | 当库存量低于安全阈值时，自动生成缺书记录。                   |
| `trg_update_customer_consumption` | `sales_order`         | `AFTER UPDATE`  | 当订单状态变为"已完成"时，自动更新客户的累计消费额。         |

#### **6.5.3 存储过程 (Stored Procedures) 摘要**
| 存储过程名称                  | 主要输入参数                                                 | 核心功能与业务流程                                           | 事务性 | 关键业务规则                      |
| :---------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----- | :-------------------------------- |
| `sp_place_order`              | `p_customer_id`, `p_shipping_address_id`, `p_order_id`, `p_order_items(JSON)` | **客户下单**。创建订单、插入明细、快照价格与折扣率、计算总金额。 | **是** | 校验图书状态、库存可用性。        |
| `sp_ship_order`               | `p_order_id`, `p_operator`, `p_carrier`, `p_tracking_number` | **订单发货**。校验支付能力、扣减余额、扣减库存、更新订单状态、创建发货记录。 | **是** | 信用透支校验、库存并发控制。      |
| `sp_receive_purchase`         | `p_purchase_order_id`, `p_received_items(JSON)`              | **采购到货**。增加库存、更新采购单和缺书记录状态。           | **是** | 采购单状态校验、库存更新原子性。  |
| `sp_auto_adjust_credit_level` | 无                                                           | **信用自动调整**。根据客户累计消费额自动调整信用等级。       | **是** | 累计消费额与信用等级映射规则。    |
| `sp_search_books`             | `p_keyword`, `p_publisher`, `p_author_name`, `p_min_price`, `p_max_price`, `p_offset`, `p_limit` | **书目多条件检索**。支持按书名、出版社、作者、价格等多条件组合查询。 | 否     | 动态SQL构建，支持模糊查询和分页。 |

---

### **6.6 物理特性与部署说明摘要**

| 项目                | 说明                                                         |
| :------------------ | :----------------------------------------------------------- |
| **数据库名**        | `online_bookstore`                                           |
| **字符集/排序规则** | `utf8mb4` / `utf8mb4_0900_ai_ci`                             |
| **存储引擎**        | 全部表使用 **InnoDB**                                        |
| **主要索引策略**    | 主键索引、外键索引、高频查询字段单列索引、复合索引（针对特定查询模式）、全文索引（用于书名目录检索）。 |
| **关键约束实现**    | 字段级：`PRIMARY KEY`, `FOREIGN KEY`, `UNIQUE`, `NOT NULL`, `CHECK` (MySQL 8.0.16+)。<br>业务级：通过**触发器**和**存储过程**实现。 |
| **事务隔离级别**    | 默认 `REPEATABLE READ`，关键存储过程中根据需要使用 `SELECT ... FOR UPDATE` 进行行级锁控制。 |
| **并发控制**        | 通过存储过程封装核心业务逻辑，使用事务和行锁保证数据一致性，特别是库存更新场景。 |
| **备份建议**        | 定期执行 `mysqldump` 逻辑备份，并考虑二进制日志用于时间点恢复。建议每日全备，每小时增量备份。 |
| **安全建议**        | 1. 应用连接使用专用数据库账户，授予最小必要权限。<br>2. 客户密码在应用层哈希处理（如bcrypt）。<br>3. 使用参数化查询或存储过程防止SQL注入。<br>4. 敏感操作记录审计日志。 |
| **维护建议**        | 1. 定期分析慢查询日志，优化索引。<br>2. 对于历史订单数据，考虑归档策略。<br>3. 使用事件调度器执行定期任务（如信用调整）。<br>4. 监控数据库连接数和资源使用情况。 |
| **扩展性考虑**      | 1. 表结构设计预留扩展字段（如JSON类型字段）。<br>2. 支持分库分表演进路径。<br>3. 视图和存储过程封装复杂逻辑，便于后续优化。 |

---

### **6.7 数据字典使用指南**

1.  **快速定位**：根据表名或字段名在相应章节中查找详细定义。
2.  **理解关系**：通过表级数据字典中的外键关联，理解数据表之间的业务联系。
3.  **状态管理**：参考状态枚举值字典，确保应用程序中使用统一的常量定义。
4.  **约束确认**：在字段说明中查看约束信息，确保数据操作符合业务规则。
5.  **对象引用**：在开发过程中，可引用本数据字典中的表名、字段名、视图名、存储过程名等。

---

### **6.8 本部分小结**

本数据字典作为《网上书店管理系统》数据库设计的核心参考文档，系统性地汇总和描述了所有数据对象的定义、关系和规则。它具有以下特点：

1.  **全面性**：涵盖了所有核心表、字段、约束、视图、触发器和存储过程。
2.  **准确性**：每个定义都基于详细的设计分析，确保与实现一致。
3.  **实用性**：提供状态枚举、业务规则说明等实用信息，直接支持开发工作。
4.  **规范性**：采用统一的结构和格式，便于查阅和维护。
5.  **扩展性**：为后续的数据模型演进提供了清晰的基线。

此数据字典不仅是前期设计成果的结晶，更是未来数据库开发、维护、优化和扩展的基石。通过此字典，任何团队成员都能快速理解数据模型的全貌与细节，有效支撑项目的持续进行。结合前面各部分的详细设计，本数据字典构成了完整的网上书店数据库设计文档体系。

---

## **第 7 部分：总结与展望**

### **7.1 设计工作总结**

本《网上书店管理系统》数据库设计文档，严格遵循数据库系统设计的方法论，从需求分析到概念设计、逻辑设计、物理设计、实现设计，最终形成完整的数据字典，完成了一个结构清晰、业务完整、可扩展性强的关系数据库系统设计。

#### **7.1.1 设计成果概览**

本次设计实现了以下核心成果：

1.  **完整的业务覆盖**：系统涵盖了网上书店的核心业务流程，包括：
    - 书目信息管理（支持作者有序关联、关键字标签、丛书结构）
    - 库存管理与预警机制
    - 客户管理与五级信用体系
    - 订单处理与发货流程（支持分次发货）
    - 采购管理与缺书闭环处理
    - 供应商管理与供货关系维护
    - 多维度书目检索与客户自助查询

2.  **规范化的数据模型**：
    - 概念设计采用E-R模型，清晰表达实体与联系
    - 逻辑设计满足第三范式（3NF），消除数据冗余
    - 物理设计针对MySQL 8进行优化，合理选择数据类型与索引策略

3.  **业务规则内聚**：
    - 通过约束、触发器、存储过程将关键业务规则（如作者数量限制、信用校验、库存预警）下沉至数据库层
    - 确保数据一致性与业务逻辑的可靠性

4.  **可扩展性设计**：
    - 支持可选功能扩展（如分次发货、丛书管理、信用自动调整）
    - 表结构预留合理字段，便于未来功能迭代

5.  **完整的实现方案**：
    - 提供可直接执行的DDL脚本
    - 封装复杂查询的视图
    - 实现核心业务流程的存储过程
    - 建立关键业务规则的触发器体系

#### **7.1.2 设计亮点**

1.  信用体系数据化：将信用等级规则参数化存储，支持动态调整与自动升级。
2.  库存智能预警：通过触发器实现库存低于安全阈值时自动生成缺书记录。
3.  订单价格快照：存储下单时的折扣率与单价，保证订单历史不可篡改。
4.  多条件检索支持：通过全文索引、视图和存储过程，支持复杂的书目查询。
5.  事务安全设计：关键操作（如下单、发货、采购）均通过存储过程封装，保证ACID特性。

---

### **7.2 设计评估**

#### **7.2.1 符合性评估**

本设计完全符合《网上书店管理系统》的业务需求，实现了所有必选功能，并对可选功能进行了合理的设计预留。具体包括：

- 书目信息管理（作者有序、关键字、丛书支持）
- 库存管理与预警
- 客户管理与信用体系
- 订单与发货管理（支持一单多书、分次发货）
- 采购管理（缺书登记、采购单处理）
- 供应商管理
- 网上浏览与多条件检索

#### **7.2.2 技术规范性评估**

- 范式符合度：主体满足3NF，合理使用受控冗余优化性能
- 索引设计：覆盖高频查询路径，避免过度索引
- 约束完整性：通过主键、外键、CHECK约束、触发器多层次保障
- 事务设计：核心业务操作具备原子性、一致性保障

#### **7.2.3 可维护性评估**

- 表、字段命名规范，具有业务含义
- 视图封装复杂查询，简化应用层逻辑
- 存储过程集中业务逻辑，便于维护与优化
- 数据字典完整，便于团队理解与协作

---

### **7.3 结语**

本《网上书店管理系统》数据库设计文档，不仅是一个满足课程要求的完整设计，更是一个具备实际应用价值和扩展潜力的专业级数据库解决方案。它体现了以下核心理念：

1.  业务驱动设计：每个数据对象、每个约束都源于真实的业务需求
2.  规范与方法论：严格遵循数据库设计规范，采用系统化设计方法
3.  平衡的艺术：在规范化与性能、灵活性与约束、当前需求与未来扩展之间寻求最佳平衡
4.  工程化思维：不仅设计结构，更考虑实现、部署、维护的全生命周期

通过本次设计实践，我们不仅掌握了数据库设计的理论知识，更培养了将复杂业务需求转化为高效、可靠数据模型的工程能力。这为后续的数据库应用开发、系统集成奠定了坚实的基础。
