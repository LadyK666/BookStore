## 网上书店管理系统 - 可选与待实现功能清单

> 本清单基于《数据库设计文档_v3.md》，记录**尚未实现**或在当前实现中**有意简化**的功能，便于后续逐项补完。  
> 状态说明：`未实现` / `部分实现(简化)`。

### 一、书目与检索相关

- **作者管理（Author / BookAuthor）** - 部分实现(简化)  
  - 建表：`author`、`book_author`（含作者顺序 `author_order` 1~4，唯一约束 `(book_id, author_order)`）。  
  - 当前：  
    - 已建相关表，并实现 `Author` 模型类、`AuthorDao`、`BookAuthorKeywordDao.addBookAuthor`，支持为书目添加有序作者并按书号查询作者列表（参见测试类 `TestBookMeta`）。  
    - 管理员端书目管理中，“作者与关键字”对话框已支持：按顺序新增作者、编辑作者信息及作者顺序、从当前书目中移除选中作者（不影响其在其他书目中的关联）。  
  - 待补充：限制每本书作者数 ≤ 4 的数据库级约束（当前通过应用层校验实现）、按作者维度反查书目等。

- **关键字管理（Keyword / BookKeyword）** - 部分实现(简化)  
  - 建表：`keyword`、`book_keyword`。  
  - 当前：  
    - 已建相关表，并实现 `Keyword` 模型类、`KeywordDao`、`BookAuthorKeywordDao.addBookKeyword`，支持为书目添加关键字并按书号查询关键字列表（参见 `TestBookMeta`）；并通过 `KeywordDao.findBookIdsByKeywordTextLike` 支持在高级搜索中按关键字文本模糊检索书目。  
    - 管理员端“作者与关键字”对话框已支持：新增关键字、编辑关键字文本、将关键字从当前书目中移除（不影响其与其他书目的关联）。  
  - 业务/约束：每本书最多关联 10 个关键字（当前通过应用层校验实现，后续可通过触发器或更严格约束保证）。  
  - 检索：按关键字（含模糊匹配）检索书目（尚未实现复杂查询 API）。

- **丛书管理（BookSeries 或 parent_book_id 扩展）** - 部分实现(简化)  
  - 当前：仅在 `book` 中有 `series_flag` + `parent_book_id`，未单独建 `book_series` 表，也未实现丛书管理 UI/DAO。  
  - 计划：根据设计文档追加 `book_series` 表和关联关系，实现丛书的维护与按丛书浏览。

### 二、库存与缺书 / 采购管理

- **缺书记录（OutOfStockRecord）** - 部分实现(简化 → 已增强)  
  - 建表：`out_of_stock_record`，字段含缺书数量、登记日期、来源、关联客户、状态、优先级等。**已建表**。  
  - 当前已实现：
    - `OutOfStockRecordDao`：支持插入缺书记录（含“同一本书 + 状态”下自动累加数量、只保留一条记录）、查询待处理记录、更新状态。  
    - 管理端“采购管理 → 缺书记录”页可查看待处理缺书记录，并根据选中记录批量生成采购单；到货后自动更新缺书记录状态为 `COMPLETED`。  
    - 缺书记录来源已支持：  
      - 管理员手工登记（`source = MANUAL`）；  
      - 库存低于安全库存时自动登记（`source = LOW_STOCK`，在发货扣减库存或后台调整库存时触发；每本书仅一条待处理记录，数量累加）；  
      - 顾客缺书登记且已付款的场景下，由系统自动为库存不足的图书生成缺书记录（`source = CUSTOMER_REQUEST`，关联订单与客户）。  
    - 顾客缺书登记（未付款）通过独立表 `customer_out_of_stock_request` 记录，整体流程为：  
      - 顾客在下单时发现库存不足，可选择“付款并生成缺书记录”或“暂不付款，仅登记缺书”；  
      - 若选择“暂不付款”，订单状态从 `PENDING_PAYMENT` 变为 `OUT_OF_STOCK_PENDING`（缺货待确认），系统将每本缺货图书写入 `customer_out_of_stock_request`；  
      - 管理员在“采购管理 → 顾客缺书登记”页查看所有待处理登记，可对每条执行“生成缺书记录”或“不生成”：  
        - 生成：写入正式 `out_of_stock_record`，登记标记为 `ACCEPTED`，订单状态回到 `PENDING_PAYMENT`，等待顾客后续付款；  
        - 不生成：登记标记为 `REJECTED`，订单状态变为 `CANCELLED`；  
      - 若顾客在管理员处理前自行付款（订单从 `OUT_OF_STOCK_PENDING` 付款成功），系统会自动为相关图书生成正式缺书记录并将登记标记为 `ACCEPTED`。  
    - 顾客侧在“我的订单”与单独的“通知”列表中可以查看所有缺书登记的处理结果：  
      - 通过：提示“您的订单（订单号）的缺货登记已通过，请抓紧付款”；  
      - 未通过：提示“您的订单（订单号）的缺货登记未通过，订单已取消”。  
  - 待补充：  
    - 更精细的优先级和处理策略（按来源、客户等级等排序）；  
    - 面向顾客的缺书处理结果查询界面可继续美化和扩展过滤条件（按订单、时间等筛选）。

- **采购单与明细（PurchaseOrder / PurchaseOrderItem）** - 部分实现(简化)  
  - 建表：`purchase_order`、`purchase_order_item`，并与 `supplier` / `book` / `out_of_stock_record` 建立关联。**已建表**。  
  - 当前已实现：  
    - `PurchaseOrderDao`：创建采购单（含明细）、查询、更新状态。
    - `PurchaseService.receiveGoods()`：到货处理，自动增加库存、关闭缺书记录、更新采购单状态。
    - `PurchaseService.createPurchaseOrderFromOutOfStock(...)`：从多条状态为 `PENDING` 的缺书记录批量生成采购单，自动关联 `supply` 表供货价，并将缺书记录状态置为 `PURCHASING`。
    - 测试类 `TestPurchase` 以及管理员端 GUI 的“根据选中缺书生成采购单”按钮共同演示完整业务闭环。
  - 待补充：
    - 更复杂的缺书合并策略（按供应商自动分组、多张采购单生成等）；
    - 部分到货处理与状态 `PARTIAL_RECEIVED`。

- **库存更新联动** - 已实现  
  - 当前：  
    - `InventoryDao` 已提供 `increaseQuantity()` / `decreaseQuantity()` / `getQuantity()` 方法；
    - 采购到货时调用 `increaseQuantity()` 增加库存（见 `PurchaseService`）；
    - **发货时调用 `decreaseQuantity()` 扣减库存**（见 `ShipmentService.shipOrder`），发货前会校验库存是否充足。
  - 待补充：  
    - 并发锁机制（`SELECT ... FOR UPDATE`）防止高并发场景下超卖；
    - 将发货单创建、库存扣减、订单状态更新纳入同一数据库事务（当前已部分实现）。

### 三、客户与信用管理

- **客户信息管理** - 已实现  
  - 建表：`customer`，字段包括网上ID、登录密码、名称、地址、账户余额、信用等级等。**已建表**。  
  - 当前已实现：
    - 客户注册与登录功能（见 `LoginView` 和 `CustomerDao`）。
    - **客户主动充值**：顾客端提供“充值”按钮，支持预充项（¥50、¥100、¥200、¥500、¥1000）和自定义金额，选择后付款，系统自动增加账户余额。
    - 管理员端客户管理：查看客户列表、调整信用等级、点击客户ID查看详细客户信息（只读）。
  - 待补充：
    - 客户信息修改功能（由客户在网上维护）。

- **客户地址（CustomerAddress）** - 部分实现(简化)  
  - 建表：`customer_address`，字段包括收件人、电话、省市区、详细地址、是否默认等。  
  - 当前：  
    - 已创建 `customer_address` 表，并实现 `CustomerAddress` 模型类与 `CustomerAddressDao`；  
    - 顾客端在页面底部提供“管理地址”入口，可查看、添加、删除收货地址，并支持设置默认地址；  
    - 下单时会优先使用默认地址；如存在多条地址，会弹出对话框让用户选择本次订单的收货地址，并将快照写入 `sales_order.shipping_address_snapshot`。  
  - 待补充：  
    - 更完善的地址校验与编辑功能；  
    - 结合地图/区域选择器的友好录入体验。

- **信用等级与权限机制** - 已实现  
  - 建表：`credit_level`，字段包括等级ID、等级名称、折扣率、是否允许透支、透支额度、升级条件等。**已建表**。  
  - 当前已实现：
    - **五级信用等级体系**：
      - **一级**：10%折扣，不能透支，必须先付款后发货。
      - **二级**：15%折扣，不能透支，必须先付款后发货。
      - **三级**：15%折扣，可透支（有额度限制），可先发货后付款。
      - **四级**：20%折扣，可透支（有额度限制），可先发货后付款。
      - **五级**：25%折扣，可无限透支，可先发货后付款。
    - **付款校验**：`OrderService.payOrder` 根据信用等级判断是否允许透支，一二级要求余额 >= 应付金额，三四级要求余额 + 透支额度 >= 应付金额，五级允许无限透支。
    - **发货机制**：`ShipmentService.shipOrder` 允许三级及以上信用等级的订单先发货后付款（订单状态为 `PENDING_PAYMENT` 时也可发货），一二级必须先付款才能发货。
    - **界面显示**：顾客端底部显示信用等级、折扣率及权限说明（是否可透支、是否可先发货后付款）。
    - 管理员端可调整客户信用等级。
  - 待补充：
    - 信用等级自动调整（根据账户余额或累计消费，在每月初批量调整客户信用等级，可使用存储过程或应用定期触发）。

### 四、订单与发货管理

- **发货单与发货明细（Shipment / ShipmentItem）** - 已实现  
  - 建表：`shipment`、`shipment_item`，与 `sales_order` / `sales_order_item` 建立关系。**已建表**。  
  - 当前已实现：  
    - `ShipmentDao`：创建发货单（含明细）、按订单查询发货单、按发货单查明细。
    - `ShipmentService.shipOrder()`：执行发货，包含库存校验、库存扣减、订单状态更新。
    - 测试类 `TestShipmentWithInventory` 演示完整流程。
  - 待补充：  
    - 支持一单多次发货（当前为一次性全部发货）；  
    - 确保针对同一订单明细的累计发货量不超过订购数量。

- **订单分次发货控制** - 未实现  
  - 规则：同一订单明细的累计 `ship_quantity` ≤ 该明细的 `quantity`。  
  - 实现思路：  
    - 在发货服务层或存储过程中累加校验；  
    - 可选增加触发器进行数据库层保护。

- **订单取消 / 退款流程** - 未实现  
  - 文档中未详细展开，但实际系统中常见：  
    - 取消未发货订单（恢复余额/库存）；  
    - 简单退款逻辑（本课程项目可选实现）。

### 五、网上浏览与查询 / 客户个人空间

- **多条件、模糊检索 API** - 部分实现(简化)  
  - 设计：按书号、书名（模糊）、出版社、关键字、作者（含第 N 作者）组合查询。  
  - 当前：  
    - 顾客界面提供了一个统一的搜索框：用户输入任意模糊文本（如“王”），系统会在书号、书名、出版社、作者名、关键字文本上同时做模糊检索：  
      - 书号 / 书名 / 出版社由 `BookDao.findByConditions` 负责；  
      - 作者由 `AuthorDao.findBookIdsByAuthorNameLike` 提供支持；  
      - 关键字由 `KeywordDao.findBookIdsByKeywordTextLike` 提供支持；  
      - 对多来源结果按 `book_id` 去重后合并展示。  
  - 待补充：  
    - 使用索引与更复杂 SQL 优化查询性能。

-- **客户个人空间查询** - 部分实现(简化)  
  - 功能：  
    - 查询客户所有历史订单及其明细；  
    - 查询每个订单的发货信息；  
    - 查询账户余额与信用等级。  
  - 当前：  
    - 在顾客界面底部显示账户余额和信用等级信息；  
    - 顾客端提供“我的订单”入口，`SalesOrderDao.findByCustomerId` 支持按当前登录客户查询其全部订单；  
    - “我的订单”中已提供订单详情页面（显示每个订单的明细列表与发货信息）；  
    - “我的订单”支持按订单状态进行筛选（全部 / 待付款 / 待发货 / 已发货 / 已完成 / 已取消）；  
    - 管理端可通过发货管理查看发货记录。  
  - 待补充：  
    - 更丰富的筛选与统计（按时间段、组合条件筛选、消费统计等）。

### 六、前端界面（JavaFX）

- **顾客端界面** - 已实现  
  - 登录/注册功能；  
  - 书目浏览与搜索；  
  - 购物车管理；  
  - 下单与付款；  
  - 我的订单查看。  
  - 待补充：  
    - 收货地址管理；  
    - 个人信息修改。

- **管理员端界面** - 已实现  
  - 订单管理（查看、筛选）；  
  - 发货管理（执行发货）；  
  - 库存管理（查看、调整）；  
  - 采购管理（缺书记录、采购单、到货）；  
  - 客户管理（充值、调整信用等级）；  
  - 供应商管理（查看、添加）；  
  - 书目管理（查看、添加）。  
  - 待补充：  
    - 编辑/删除功能；  
    - 数据导出；  
    - 统计报表。

### 七、数据库级约束、存储过程与触发器

- **作者数与关键字数限制** - 未实现  
  - 规则：每本书作者 ≤ 4、关键字 ≤ 10。  
  - 实现方式：  
    - 触发器或在应用层插入前计数校验。

- **缺书记录唯一性控制** - 未实现  
  - 规则：同一 `book_id` 在状态为“待处理”时只能有一条记录。  
  - 实现方式：  
    - 唯一索引 `(book_id, status)` + 状态值限制，或触发器控制。

- **库存更新与财务记录的 ACID 保障** - 部分实现(简化)  
  - 当前：订单付款中已对“扣款 + 更新订单状态”使用显式事务；库存尚未纳入同一事务。  
  - 计划：  
    - 对“创建订单 + 扣减库存 + 扣款 + 生成发货单”设计统一事务；  
    - 考虑并发锁与异常恢复策略。


