## 网上书店管理系统 - 开发进度说明（阶段性文档）

> 本文档依据《数据库设计文档_v3.md》和课程要求，记录当前已实现的功能与未完成的功能，便于对照任务清单推进开发。

**最新更新：**
- ✅ 已实现累积消费更新机制：客户付款成功后自动更新累积消费金额。
- ✅ 已实现信用等级自动升级机制：根据累积消费自动升级信用等级（二级：500元，三级：2000元，四级：5000元，五级：10000元）。
- ✅ 客户管理页面新增累积消费列显示。
- ✅ 提供SQL脚本重置所有用户的累积消费为0（`docs/重置累积消费.sql`）。
- ✅ 已实现客户信息修改功能：客户可在网上自行维护个人信息（真实姓名、手机号、邮箱），通过"修改信息"按钮打开修改对话框。
- ✅ 新增分次发货/分次收货：管理员可对订单逐本书发货并支持多快递单号，订单状态进入 `DELIVERING`；顾客可分次确认已发货的图书，所有明细确认收货后订单变为 `COMPLETED`。
- ✅ 新增通用消息通知中心：引入 `customer_notification` 通知表及 `CustomerNotification` 模型，顾客端“通知”入口统一展示缺书登记处理结果、分次发货通知、商家活动等各类消息；缺书登记处理结果由后台自动写入该表。  

### 一、已完成的基础工作（对应设计文档章节）

- **1. 数据库基础环境搭建**
  - 在 MySQL 中创建了 `bookstore` 数据库，字符集 `utf8mb4`。（对应设计文档 3.2 总览）
  - 按设计文档中“核心业务数据层”的一部分，已经建成以下表（见 `docs/数据库建表脚本.sql`）：
    - `credit_level`：信用等级规则字典表。
    - `customer`：客户信息表（含账户余额、累计消费、信用等级外键等）。
    - `book`：书目表（静态书目信息）。
    - `inventory`：库存表（与 `book` 一对一，记录库存数量与安全库存）。
    - `sales_order`：订单主表。
    - `sales_order_item`：订单明细表。

- **2. 测试数据准备**
  - 在 `docs/数据库建表脚本.sql` 中添加了“测试数据”部分：
    - 为 `book` / `inventory` 插入了 3 本典型图书及其库存。
    - 为 `customer` 插入了 2 个测试客户，并关联到不同信用等级。
  - 这些数据用于后续基于 JDBC 的功能调试。

- **3. Maven 工程与 JDBC 基础设施**
  - 使用 Maven 构建 Java 项目，JDK 版本为 21，依赖包括：
    - `mysql-connector-java`：MySQL JDBC 驱动。
    - `HikariCP`：连接池。
    - `slf4j-api` / `slf4j-simple`：日志。
  - 已经实现数据库连接配置与工具类：
    - `db.properties`：记录数据库 URL、用户名、密码等。
    - `DBUtil`：基于 HikariCP 的连接池工具类（提供 `getConnection()`）。
  - 验证类：
    - `TestConnection`：成功连接到数据库，并通过 `BookDao` 查询图书列表，验证了“Java → JDBC → MySQL” 通路正常。

- **4. 部分中间层 / DAO 骨架**
  - 按照设计文档中“书目（Book）”实体，定义了对应的 Java 实体类：
    - `com.bookstore.model.Book`：包含 `book_id`、`isbn`、`title`、`publisher`、`publish_date`、`edition`、`price`、`status` 等核心字段。
  - 编写了 `BookDao` 数据访问类，实现了基础的 CRUD 操作：
    - `findAll()`：查询所有图书。
    - `findById(String bookId)`：按主键查询图书。
    - `insert(Book book)`：新增图书。
    - `update(Book book)`：更新图书。
    - `deleteById(String bookId)`：删除图书。
  - 以上工作对应设计文档中：
    - **1. 供书目录与库存管理模块** 的一部分数据访问层实现（书目基础维护）。
    - 为后续 C/S 管理端（书目管理界面）提供了后端支撑。

- **5. 客户与信用管理模块（第一阶段）**
  - 已有表：
    - `credit_level`：信用等级规则字典表（包含折扣率、是否允许透支、透支额度等字段，并预置五级数据）。
    - `customer`：客户信息表。
  - 新增 Java 实体与 DAO：
    - `com.bookstore.model.Customer`：对应设计文档中的 Customer 实体，字段包括用户名、密码哈希、真实姓名、联系方式、余额、累计消费、注册时间、账户状态、信用等级ID等。
    - `CustomerDao`：实现基础数据访问方法：
      - `findAll()`：查询所有客户。
      - `findByUsername(String username)`：按用户名查询客户（为登录/重名校验准备）。
      - `insert(Customer c)`：新增客户记录（简单“注册”，当前阶段未实现真实密码加密）。
  - 新增测试类：
    - `TestCustomer`：演示使用 `CustomerDao` 完成：
      - 查询并打印所有客户；
      - 插入一位新测试客户 `wangwu`；
      - 再次查询并打印全部客户。
  - 对应设计文档中的模块：
    - **3. 客户与信用管理模块** 中的“客户信息管理”和“账户余额管理”的基础数据访问支持。

- **5.x 客户地址管理模块（第一阶段）**
  - 新增表结构（见 `docs/数据库建表脚本.sql`）：
    - `customer_address`：客户收货地址表，字段包括收件人、电话、省市区、详细地址、是否默认等。  
  - 新增实体与 DAO：  
    - `CustomerAddress` 模型类；  
    - `CustomerAddressDao`：支持按客户查询全部地址、新增地址（含默认地址处理）、设置默认地址、删除地址。  
  - 前端支持：  
    - 顾客端 `CustomerView` 在界面底部提供“管理地址”按钮，可查看/新增/删除收货地址，并设置默认地址；  
    - 在下单时，系统会优先选择默认地址作为收货地址快照；如存在多条地址，会弹出对话框供顾客选择本次订单使用的地址，并将完整地址快照写入 `sales_order.shipping_address_snapshot`。  

- **6. 顾客订单管理模块（第一阶段：下单与折扣计算）**
  - 已有表：
    - `sales_order`：订单主表。
    - `sales_order_item`：订单明细表。
  - 新增 Java 实体与 DAO：
    - `com.bookstore.model.CreditLevel` + `CreditLevelDao`：用于根据客户的 `credit_level_id` 查询折扣率、透支规则等（当前阶段主要使用折扣率）。
    - `com.bookstore.model.SalesOrder`、`com.bookstore.model.SalesOrderItem`：对应订单主表与明细表的核心字段（金额、折扣快照、状态等）。
    - `SalesOrderDao`：
      - `createOrder(SalesOrder order, List<SalesOrderItem> items)`：在一个事务中完成订单主表和明细表的插入。
      - `findOrderById(long orderId)` / `findItemsByOrderId(long orderId)`：按订单号查询订单主表和全部明细，用于测试与回显。
  - 新增测试类：
    - `TestOrder`：模拟如下业务场景：
      - 使用测试客户 `zhangsan`（其信用等级与折扣率来自 `credit_level` 表）；
      - 购买两本测试图书：`B001` 和 `B002`（1 本 + 2 本）；
      - 按信用等级折扣率计算每本书的成交单价与小计金额，汇总得到订单总金额与应付金额；
      - 通过 `SalesOrderDao.createOrder` 将订单持久化到 `sales_order` / `sales_order_item`；
      - 再次从数据库查询订单主表与明细并打印，验证插入是否正确。
  - 对应设计文档中的模块：
    - **4. 订单与发货管理模块** 中的“订单创建（订单头+明细）”和“价格计算（按信用等级折扣率）”两个子功能点的后端基础实现。

- **7. 顾客订单管理模块（第二阶段：付款与信用校验）**
  - 新增业务服务：
    - `OrderService`：
      - `payOrder(long orderId)`：根据订单、客户及其信用等级，按照设计文档中的规则完成支付能力校验与扣款：
        - 一、二级：不允许透支，要求 `账户余额 >= 应付金额`；
        - 三、四级：允许透支，要求 `账户余额 + 透支额度 >= 应付金额`；
        - 五级：透支额度配置为 `-1` 视为无限透支，本实验中直接视为可以支付。
        - 校验通过后，扣减客户账户余额（可变为负值表示透支），并将订单状态从 `PENDING_PAYMENT` 更新为 `PENDING_SHIPMENT`，记录 `payment_time`。
  - DAO 辅助扩展：
    - `CustomerDao` 新增：
      - `findById(long customerId)`：按主键查询客户。
      - `updateAccountBalance(long customerId, BigDecimal newBalance)`：更新账户余额。
    - `SalesOrderDao` 新增：
      - `updateStatusAndPaymentTime(long orderId, String newStatus, LocalDateTime paymentTime)`：更新订单状态与支付时间。
  - 新增测试类：
    - `TestPayment`：
      - 假定已通过 `TestOrder` 生成 `order_id = 1` 的订单；
      - 付款前打印订单状态与客户余额；
      - 调用 `OrderService.payOrder(1)` 执行付款逻辑；
      - 再次查询并打印订单状态（应变为 `PENDING_SHIPMENT`）与客户余额（应减少，应付金额可能导致余额为负）。
  - 对应设计文档中的模块：
    - **4. 订单与发货管理模块** 中的“发货前校验（依据信用等级判断支付能力）”与“账户余额扣减”的核心规则，当前阶段已在后端服务中实现，后续仍需结合库存扣减与发货管理完善。

- **8. 供应商管理模块（第一阶段：供应商与供货关系）**
  - 新增表结构（见 `docs/数据库建表脚本.sql`）：
    - `supplier`：供应商信息表，字段包括名称、联系人、电话、邮箱、地址、结算方式、合作状态等。
    - `supply`：供货关系表，实现“供应商-书目”的多对多关联，包含供货价、供货周期天数、是否主供货商等字段。
  - 新增测试数据：
    - 示例供应商：`新华图书批发中心`、`高校教材供应站`。
    - 供货关系：为 `B001`、`B002`、`B003` 分别配置了供货记录，以支持后续采购管理模块的开发和演示。
  - 新增实体与 DAO：
    - `com.bookstore.model.Supplier` + `SupplierDao`：支持查询全部供应商、按主键查询。
    - `com.bookstore.model.Supply` + `SupplyDao`：支持按 `supplier_id` 或 `book_id` 查询供货信息。
  - 新增测试类：
    - `TestSupplier`：
      - 打印所有供应商的基本信息；
      - 对每个供应商，查询并打印其可供应的书目和供货价格等信息；
      - 示范按书号（如 `B001`）查询所有可供货的供应商。
  - 对应设计文档中的模块：
    - **5. 供应商管理模块** 中的“供应商信息维护”和“供货关系维护”的数据模型与基础数据访问实现，为后续“采购单”与“缺书记录”闭环打下基础。

- **9. 发货管理模块（第一阶段：发货数据结构与基本流程）**
  - 新增表结构（见 `docs/数据库建表脚本.sql` 后续 SQL）：  
    - `shipment`：发货单主表（字段：`shipment_id`、`order_id`、`ship_time`、`carrier`、`tracking_number`、`shipment_status`、`operator`），与 `sales_order` 建立多对一关系。  
    - `shipment_item`：发货明细表（字段：`shipment_item_id`、`shipment_id`、`order_item_id`、`ship_quantity`），与 `sales_order_item` 建立联系，用于支持一单多次发货。  
  - 新增实体与 DAO：  
    - `Shipment`、`ShipmentItem` 模型类。  
    - `ShipmentDao`：  
      - `createShipment(Shipment shipment, List<ShipmentItem> items)`：在一个事务中创建发货单及其明细；  
      - `findByOrderId(long orderId)`：按订单号查询发货单；  
      - `findItemsByShipmentId(long shipmentId)`：查询某发货单的全部明细。  
  - 新增测试类：  
    - `TestShipment`：  
      - 假定存在 `order_id = 1` 且已生成订单明细；  
      - 将该订单的所有明细“一次性全部发货”（当前阶段未加入库存扣减与分次发货控制，仅演示数据流程）；  
      - 打印发货单及其明细，验证数据写入和查询正确。  
  - 对应设计文档中的模块：  
    - **4. 订单与发货管理模块** 中关于“发货单 / 发货明细”的数据模型与一单多次发货的基础结构要求；  
    - 库存扣减、分次发货累计数量控制等细节留待下一阶段与库存模块整合实现。

- **10. 书目扩展模块（第一阶段：作者与关键字）**
  - 新增表结构（见 `docs/数据库建表脚本.sql`）：
    - `author`：作者信息表（姓名、国籍、简介等）。  
    - `book_author`：书目-作者关系表，包含 `author_order` 字段，主键为 `(book_id, author_order)`，用于记录作者顺序。  
    - `keyword`：关键字字典表。  
    - `book_keyword`：书目-关键字关系表，实现多对多关联。  
  - 新增实体与 DAO：
    - `Author` / `AuthorDao`：支持插入作者、按书号查询该书的作者列表，并提供作者信息更新方法。  
    - `Keyword` / `KeywordDao`：支持插入关键字、按书号查询该书的关键字列表，并提供关键字文本更新方法。  
    - `BookAuthorKeywordDao`：提供关系维护方法：
      - `addBookAuthor(String bookId, long authorId, int authorOrder)`；  
      - `addBookKeyword(String bookId, long keywordId)`；  
      - `removeBookAuthor(String bookId, long authorId)`：将作者与指定书目的关联移除；  
      - `updateBookAuthorOrder(String bookId, long authorId, int newOrder)`：更新某本书中该作者的作者顺序；  
      - `removeBookKeyword(String bookId, long keywordId)`：将关键字与指定书目的关联移除。
  - 新增测试类：
    - `TestBookMeta`：
      - 为 `B001`、`B002` 插入示例作者与关键字，并建立关联；
      - 查询并打印 `B001` 的作者列表与关键字列表，验证关系表与 DAO 是否工作正常。
  - 对应设计文档中的模块：
    - **1. 供书目录与库存管理模块** 中"作者管理"和"关键字管理"的数据结构与基础操作；  
    - 管理员端 JavaFX 界面中，通过“作者与关键字”对话框，已支持为书目新增/编辑/删除作者（含作者序号）以及新增/编辑/删除关键字；  
    - 有关"作者≤4 人、关键字≤10 个、按作者/关键字检索"等约束和高级检索，在后续阶段继续实现（当前作者/关键字数量限制在应用层进行了校验，尚未使用数据库触发器约束）。

- **11. 采购管理模块（缺书记录 → 采购单 → 到货 → 库存增加 完整闭环）**
  - 新增表结构（见 `docs/数据库建表脚本.sql`）：
    - `out_of_stock_record`：缺书记录表，字段含书号、缺书数量、登记日期、来源（手动/低库存/订单超量/客户请求）、关联客户、状态、优先级等；通过唯一约束与 DAO 内部逻辑保证“同一本书在同一状态下仅保留一条记录，重复登记会自动累加数量”。
    - `purchase_order`：采购单主表，字段含供应商 ID、创建日期、期望到货日期、采购员、预估金额、状态等。
    - `purchase_order_item`：采购明细表，复合主键 `(purchase_order_id, book_id)`，含采购数量、采购价、关联缺书记录 ID。
  - 新增实体与 DAO：
    - `OutOfStockRecord` + `OutOfStockRecordDao`：
      - `insert()`：创建缺书记录（若同一本书在相同状态下已有记录，则自动累加 `required_quantity` 而不新增记录）；
      - `findPending()`：查询所有待处理缺书记录；
      - `updateStatus()`：更新缺书记录状态。
    - `PurchaseOrder`、`PurchaseOrderItem` + `PurchaseOrderDao`：
      - `createPurchaseOrder()`：事务内创建采购单及其明细；
      - `findById()` / `findItemsByOrderId()`：查询采购单与明细；
      - `updateStatus()`：更新采购单状态。
    - `InventoryDao`：
      - `increaseQuantity()`：采购到货时增加库存；
      - `decreaseQuantity()`：发货时扣减库存；
      - `getQuantity()` / `getSafetyStock()`：查询库存与安全库存。
    - `customer_out_of_stock_request`：顾客缺书登记表，用于记录顾客在下单时提出的缺书请求（含订单号、客户ID、书号、数量、是否已付款、备注、处理状态及对应正式缺书记录ID），并支持标记是否已在顾客端展示通知。
  - 新增服务/功能：
    - `PurchaseService`：
      - `receiveGoods(long purchaseOrderId)`：处理采购到货，自动增加库存、关闭关联缺书记录、更新采购单状态为 `COMPLETED`。
      - `createPurchaseOrderFromOutOfStock(List<Long> recordIds, long supplierId, LocalDate expectedDate, String buyer)`：
        - 支持从多条状态为 `PENDING` 的缺书记录批量生成一张采购单；
        - 自动按选定供应商在 `supply` 表中的供货价格生成采购明细，汇总预估金额；
        - 将相关缺书记录状态更新为 `PURCHASING`，与 GUI 前端“根据选中缺书生成采购单”按钮联动。
  - 新增辅助逻辑：
    - 在发货服务 `ShipmentService.shipOrder` 中，发货扣减库存后会检查是否低于安全库存，并自动以 `LOW_STOCK` 源生成/累加缺书记录；
    - 在管理员后台“库存管理”页中，可直接编辑每本书的安全库存，调整后如当前库存已经低于新的安全库存，也会自动生成缺书记录；
    - 顾客下单时，如订单中存在某些图书库存不足：
      - 系统会弹出“缺书登记”对话框，列出库存不足的图书，顾客可选择：  
        1. **付款并自动生成缺书记录**：系统为这些图书写入 `out_of_stock_record`（`source = CUSTOMER_REQUEST`，状态 `PENDING`），并将登记记录标记为已通过（`ACCEPTED`）；  
        2. **暂不付款，仅提交缺书登记**：系统将每本缺货图书的信息写入 `customer_out_of_stock_request`，订单状态从 `PENDING_PAYMENT` 变为 `OUT_OF_STOCK_PENDING`（缺货待确认），等待管理员处理；  
      - 管理员在“采购管理”模块下新增“顾客缺书登记”页，可查看所有待处理的顾客缺书登记，并执行：  
        - “生成缺书记录”：写入正式 `out_of_stock_record`，登记状态改为 `ACCEPTED`，相关订单状态回到 `PENDING_PAYMENT`，由顾客后续付款；  
        - “不生成”：登记状态改为 `REJECTED`，相关订单状态改为 `CANCELLED`；  
      - 若顾客在管理员处理前对 `OUT_OF_STOCK_PENDING` 状态的订单完成付款，`OrderService.payOrder` 会自动根据该订单的待处理登记生成正式缺书记录并将登记标记为 `ACCEPTED`。  
      - 顾客端在“我的订单”与单独的“通知”列表中可以查看所有缺书登记的处理结果：通过/未通过均会以一条条记录展示，不会因一次弹窗而丢失历史。
    - `TestPurchase`：演示完整业务闭环：
      - 查看 `B001` 当前库存；
      - 创建一条缺书记录（手动登记）；
      - 根据缺书记录创建采购单（向指定供应商采购）；
      - 模拟到货处理（调用 `PurchaseService.receiveGoods`）；
      - 验证库存增加、缺书记录状态变为 `COMPLETED`、采购单状态变为 `COMPLETED`。
  - 对应设计文档中的模块：
    - **2. 采购管理模块** 中"缺书登记"、"采购单管理"、"到货处理"的核心功能实现；
    - "库存更新联动"在此阶段已初步实现（采购到货增加库存），后续可扩展发货时扣减库存、并发控制等。

- **12. 发货管理模块（第二阶段：发货与库存扣减整合）**
  - 新增服务：
    - `ShipmentService`：
      - `shipOrder(long orderId, String carrier, String trackingNumber, String operator)`：执行发货，流程如下：
        1. 校验订单状态必须为 `PENDING_SHIPMENT`；
        2. 校验库存是否充足（遍历订单明细，检查 `inventory.quantity >= 订单数量`）；
        3. 创建发货单与发货明细；
        4. 扣减库存（调用 `InventoryDao.decreaseQuantity`）；
        5. 更新订单状态为 `SHIPPED`，记录 `delivery_time`。
  - DAO 扩展：
    - `SalesOrderDao` 新增 `updateStatusAndDeliveryTime()`：更新订单状态与发货时间。
  - 新增测试类：
    - `TestShipmentWithInventory`：演示完整流程：
      - 查看初始库存；
      - 创建新订单（使用客户 `lisi`）；
      - 付款（调用 `OrderService.payOrder`）；
      - 发货（调用 `ShipmentService.shipOrder`，含库存扣减）；
      - 验证：订单状态变为 `SHIPPED`，库存数量减少。
  - 对应设计文档中的模块：
    - **4. 订单与发货管理模块** 中"发货执行（扣减库存）"与"订单状态流转"的核心实现；
    - 现已实现"下单 → 付款 → 发货 → 库存扣减"完整业务主线。

- **13. JavaFX 前端界面（GUI 开发阶段）**
  - 添加 JavaFX 依赖：
    - `pom.xml` 中新增 `javafx-controls`、`javafx-fxml` 依赖（版本 21.0.2）。
    - 配置 `javafx-maven-plugin` 用于运行 JavaFX 应用。
  - 主要界面类：
    - `MainApp`：JavaFX 应用入口，管理场景切换。
    - `LoginView`：登录界面，支持顾客/管理员两种用户类型登录，顾客可注册新账号。
    - `CustomerView`：顾客界面，包含：
      - 书目浏览与搜索（显示定价与折后价，统一搜索框支持在书号/书名/出版社/作者/关键字上进行模糊检索，**点击书号可查看只读图书详情**）；
      - 购物车管理（添加、删除、清空）；
      - 提交订单与付款（**根据信用等级校验透支权限**）；
      - 查看我的订单（基于 `SalesOrderDao.findByCustomerId` 查询当前登录客户的全部订单，支持按状态筛选，如：待付款、待发货、已发货、已完成等，**新增订单状态 `OUT_OF_STOCK_PENDING`**）；
      - 订单详情查看：在“我的订单”中可查看单个订单的明细列表及发货信息（使用 `SalesOrderDao.findItemsByOrderId` + `ShipmentDao.findByOrderId`）；
      - 个人信息展示（余额、信用等级、**信用等级权限说明**）；
      - **账户充值**：提供"充值"按钮，支持预充项（¥50、¥100、¥200、¥500、¥1000）和自定义金额，选择后付款，系统自动增加余额；
      - **修改个人信息**：提供"修改信息"按钮，客户可自行维护真实姓名、手机号、邮箱等信息；
      - 收货地址管理与下单时地址选择；
      - **缺书登记处理结果通知列表**（查看管理员对缺书登记的处理结果）。
    - `AdminView`：管理员后台界面，左侧菜单导航，包含：
      - 订单管理（查看全部订单、按状态筛选，**点击订单号/客户ID可查看只读详情**）；
      - 发货管理（待发货订单列表、执行发货操作，**支持三级及以上信用等级先发货后付款**，发货前校验库存，不足则弹窗提示，**点击订单号/客户ID可查看只读详情**，**未付款订单不可发货**（三级及以上除外））；
      - 库存管理（查看库存、手动调整库存数量，**可编辑安全库存**）；
      - 采购管理（缺书记录、采购单、从缺书生成采购单、到货处理，**新增“顾客缺书登记”Tab，处理未付款的顾客缺书登记**）；
      - 客户管理（查看客户列表、调整信用等级，**点击客户ID可查看只读客户详情**，**充值功能已移除，改为客户主动充值**，**显示累积消费列**）；
      - 供应商管理（查看/添加供应商）；
      - 书目管理（查看/添加书目）。
  - DAO 扩展：
    - `CustomerDao` 新增 `updateCreditLevel()`：更新客户信用等级。
    - `CustomerDao` 新增 `addTotalConsumption()`：增加客户累积消费金额。
    - `CustomerDao` 新增 `updateCustomerInfo()`：更新客户基本信息（真实姓名、手机、邮箱）。
    - `SalesOrderDao` 新增 `findAll()`、`findByStatus()`：查询所有订单、按状态查询。
    - `InventoryDao` 新增 `findAll()`、`insert()`：查询所有库存记录、新增库存记录。
    - `PurchaseOrderDao` 新增 `findAll()`：查询所有采购单。
    - `SupplierDao` 新增 `insert()`：新增供应商。
    - `CreditLevelDao` 新增 `findById()`：查询信用等级信息（含折扣率、是否允许透支、透支额度等）。
  - 服务层扩展：
    - `OrderService.payOrder()`：**根据信用等级实现透支机制**，一二级不允许透支，三四级有额度限制，五级无限透支。**付款成功后自动更新客户累积消费，并根据累积消费自动升级信用等级**。
    - `OrderService.checkAndUpgradeCreditLevel()`：**根据累积消费自动检查并升级客户信用等级**，升级规则：二级（累计消费满500元）、三级（累计消费满2000元）、四级（累计消费满5000元）、五级（累计消费满10000元）。
    - `ShipmentService.shipOrder()`：**支持三级及以上信用等级先发货后付款**，允许订单状态为 `PENDING_PAYMENT` 时发货。
  - 新增实体类：
    - `Inventory`：库存实体类。
  - 功能特性：
    - 顾客端：完整购物流程（浏览 → 加购物车 → 下单 → 付款）。
    - 管理员端：覆盖库存、采购、客户、订单、发货、供应商、书目等主要管理功能。

### 二、尚未完成或仅设计未实现的功能（对照需求与设计文档）

> 以下功能在《数据库设计文档_v3.md》中已有清晰的概念/逻辑设计，但在当前代码中尚未实现或仅部分准备。

- **1. 供书目录与库存管理模块（未完部分）**
  - `Author` / `BookAuthor`：作者及书目-作者关系表尚未建表与实现 DAO。
  - `Keyword` / `BookKeyword`：关键字及其关系尚未建表与实现 DAO。
  - 库存调整逻辑（采购到货入库、发货出库、盘点调整）尚未在代码中实现，仅有 `inventory` 表结构。
  - 丛书管理（`BookSeries` 或 `parent_book_id` 的业务逻辑）尚未实现。

- **2. 采购管理模块**
  - 数据表：
    - `OutOfStockRecord`（缺书记录）、`PurchaseOrder`（采购单）、`PurchaseOrderItem`（采购明细）尚未在数据库中创建。
  - 业务逻辑：
    - 自动生成缺书记录（库存低于安全库存 / 订单超库存）尚未实现。
    - 基于缺书记录生成采购单、到货更新库存、关闭缺书记录等流程尚未在代码中实现。

- **3. 客户与信用管理模块（未完部分）**
  - Java 实体与 DAO：
    - `Customer` 实体类及 `CustomerDao` 已实现。
  - 功能：
    - 客户注册、登录、信息维护、账户充值等业务逻辑已实现。
    - **客户信息修改功能已实现**：客户可在网上自行维护个人信息（真实姓名、手机号、邮箱），通过"修改信息"按钮打开修改对话框。
    - **累积消费更新机制已实现**：在 `OrderService.payOrder()` 中，付款成功后自动更新客户累积消费。
    - **信用等级自动升级机制已实现**：根据累积消费自动升级信用等级，升级规则：二级（累计消费满500元）、三级（累计消费满2000元）、四级（累计消费满5000元）、五级（累计消费满10000元）。升级在每次付款成功后自动检查并执行。

- **4. 顾客订单管理与发货管理模块**
  - 订单相关业务：
    - 创建订单（订单头 + 明细）、计算折扣价与总金额、保存订单的完整流程未在代码中实现。
    - 根据信用等级与透支规则进行“发货前资金校验”的存储过程或服务层逻辑尚未实现。
  - 发货相关：
    - `Shipment` / `ShipmentItem` 表尚未创建。
    - 分次发货、发货记录、物流信息、订单状态流转（待付款→待发货→已发货→完成/取消）等代码尚未实现。

- **5. 供应商管理模块**
  - 数据表：
    - `Supplier`、`Supply`（供应商-书目供货关系）尚未在数据库中创建。
  - Dao 与业务：
    - 供应商信息维护、供货关系维护的 DAO 与业务逻辑尚未编写。

- **6. 网上浏览与查询模块**
  - 面向前端/客户的多条件书目查询（按书号、书名、出版社、关键字、作者等的精确/模糊检索）仅在设计层面存在，尚无具体 SQL 与服务实现。
  - 客户“个人空间”相关查询（历史订单、发货信息等）尚未在代码中实现。

- **7. 存储过程、触发器与事务控制**
  - 设计文档中提到的关键业务规则（如：
    - 发货前余额/透支额度校验、
    - 缺书记录唯一性控制、
    - 库存更新的原子性、
    - 信用等级自动调整
    ）目前仅在文档层面，还未用 MySQL 存储过程 / 触发器 / 事务代码实现。

### 三、下一阶段建议开发顺序（与设计文档对应）

1. **完善供书目录与库存管理（后台 C/S 部分优先）**
   - 补充作者 / 关键字相关表与 DAO。
   - 基于 `BookDao` 添加库存联动（新增书目自动初始化库存记录）。
2. **实现客户与订单主流程**
   - 编写 `Customer` 实体与 `CustomerDao`，实现注册/登录/信息维护基础逻辑。
   - 实现“下订单 + 按信用等级折扣计算 + 订单持久化”主流程。
3. **发货与资金校验**
   - 设计并实现一个存储过程或服务方法：根据信用等级规则校验支付能力，扣减账户余额并更新订单状态。
   - 视需要增加发货单相关表和 DAO，实现简单发货记录。
4. **扩展采购与缺书管理**
   - 按设计文档创建 `OutOfStockRecord`、`PurchaseOrder`、`PurchaseOrderItem` 等表，逐步实现缺书/采购闭环。

以上进度记录会随着后续开发一起更新，以保持与《数据库设计文档_v3.md》的功能范围和模块划分严格一致。


